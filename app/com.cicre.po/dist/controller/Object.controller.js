jQuery.sap.require("sap.ui.core.util.Export");jQuery.sap.require("sap.ui.core.util.ExportTypeCSV");sap.ui.define(["com/cicre/po/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","com/cicre/po/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/export/Spreadsheet"],function(e,t,o,i,a,r,s){"use strict";return e.extend("com.cicre.po.controller.Object",{formatter:i,PoNumber:"",PurchDoc:"",DocParNo:"",sCoCode:"",sCoText:"",sPONO:"",sVendor:"",sProj:"",sPOrg:"",sPlant:"",sPGrp:"",sDocType:"",sDocTypeText:"",BUBoQs:[],WBSBoQs:[],Boqs:[],myBuildingSet:[],myWBSSet:[],myPurchaseRequisition:[],aContexts:[],sSubBoq:"",sSubBoqId:"",sSubBoq2:"",sSubBoq2Id:"",POHeaderToPOSrv:[],_oBuilding2Dialog:null,_oWBS2Dialog:null,consultantIndecator:"",sConsultant:"",sConsultantName:"",compInd:"",vendorInd:"",pGrpInd:"",pOrgInd:"",sSearchCoCode:"",sSearchVendor:"",sSearchPGrp:"",sSearchPOrg:"",selectedRefContracts:[],sVendorName:"",SupeiorWBSText:"",GroupCode:"",ModelCode:"",Amount:"",Omission:"",sValueAction:"",sValueorderType:"",Composing:"",addVA:"0",addVAOld:"0",myBuildingSet:"",ModelCodeFilter:"",sProjj:"",ModelCodee:"",GroupCodee:"",Building:"",BoqDescR:"",variationBuildingVorA:[],GroupCodefilter:"",ModelCodefilter:"",ZoneCodefilter:"",BuildingCodefilter:"",ContractCode:"",HeadToHeadVariationG:[],ViewCon:"",SERTYPE:"",SERTYPEText:"",BoqAll:"",BoqDescAll:"",currentYear:"",years:[],onInit:function(){var e=[{id:"R",text:"Released"},{id:"C",text:"Composing"}];var o=new sap.ui.model.json.JSONModel;o.setData({variationOrderContract:[],variationBuilding:[],selectedBuildinglist:[],VariationMode:true,ViewCon1:false,ViewCon2:true,ViewCon4:false,ViewCon3:true,VReleasedMode:"",Action:e,Buildings:[],Buildingss:[]});this.getView().setModel(o,"localJso");var i,a=new t({busy:true,delay:0});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);i=this.getView().getBusyIndicatorDelay();this.setModel(a,"objectView")},onShareInJamPress:function(){var e=this.getModel("objectView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},_onObjectMatched:function(e){var t=this.getView().getModel();var o=this;o.getView().setBusy(true);if(e)var i=e.getParameter("arguments").objectId;else var i=o.PoNumber;o.PoNumber=i;o.IndexMonth();var a=new sap.ui.model.json.JSONModel;var r=[{id:"01",text:"Jan"},{id:"02",text:"Feb"},{id:"03",text:"Mar"},{id:"04",text:"Apr"},{id:"05",text:"May"},{id:"06",text:"Jun"},{id:"07",text:"Jul"},{id:"08",text:"Aug"},{id:"09",text:"Sep"},{id:"10",text:"Oct"},{id:"11",text:"Nov"},{id:"12",text:"Dec"}];var s=[{id:"C",text:"Cancel"},{id:"R",text:"Released"}];var n=[{id:"R",text:"Released"},{id:"C",text:"Composing"}];var l=[{id:"O",text:"Original"},{id:"E",text:"Estimated"}];var d=[{id:"A",text:"Active"},{id:"D",text:"Deleted"},{id:"UA",text:"Under Processing-Active"},{id:"UD",text:"Under Processing-Deleted"}];var g=[{id:"C",text:"Contingency"},{id:"U",text:"Unit rate"},{id:"L",text:"lumpsum"},{id:"P",text:"Provisional Sum"},{id:"R",text:"Remeasured"}];var c=[{id:"O",text:"Original"},{id:"V",text:"Variation"},{id:"A",text:"Addendum"}];t.bindContext("/ContractPOHeaderSet('"+i+"')",null,{$expand:"POHeaderToBoqItem,ContractPONoteNav,POHeaderToPOItem,ContractPOSrvItemSet,AttachmentSet,POHeaderToPOGetbuildingNav,ReleaseerrorSet,PermissionNav,WFContractInboxNAV,POPurchaseRequisitionTreeNav"}).requestObject().then(function(e){e.IndexMonths=o.years;e.VAction=s;e.VStatus=n;e.Currency=e.Currency;e.AuthInd=e.PermissionNav.AuthInd;if(e.Currency==="USD"){o.CustomCurrency=2}else{o.CustomCurrency=2}e.STATUSBoqlist=d;e.Service_TYPE=g;e.Actiontype="O";e.STATUSBoqlist=d;e.selectedRefContracts=e.RefContract.split(",");var t=0,i=0;var a=[],r=[];var l=e.ReleaseerrorSet.results;var c=[];for(var u=0;u<l.length;u++){var p={type:"Error",title:l[u].ErrItem+"-"+l[u].ErrMsg2,description:l[u].ErrMsg1};c.push(p)}e.MessageSet=c;$.each(e.POHeaderToPOGetbuildingNav.results,function(e,t){t.AsBuild="";if(t.Project===""){r.push(t)}else{a.push(t)}});e.myBuildingSet=a;e.myWBSSet=r;$.each(e.myBuildingSet,function(i,a){e.myBuildingSet[i].DelInd="";e.myBuildingSet[i].ChangeIndicator="";e.myBuildingSet[i].Group=e.myBuildingSet[i].SubBoq;t=parseFloat(t)+1;if(e.myBuildingSet[i].ContractualIndicator==="O"){e.myBuildingSet[i].sortNum=1}if(e.myBuildingSet[i].ContractualIndicator==="V"){e.myBuildingSet[i].sortNum=2}if(e.myBuildingSet[i].ContractualIndicator==="A"){e.myBuildingSet[i].sortNum=3}$.each(o.HeadToHeadVariationG,function(t,o){if(e.myBuildingSet[i].Txt===o.OrderType+"-"+o.UserOrder){e.myBuildingSet[i].OrderNo=o.OrderNo}})});if(e.WFContractInboxNAV.results.length>0){var h=e.WFContractInboxNAV.results;var m=o.onprocessworkflowBuilding(h);e.lanes=m.lanes;e.nodes=m.nodes}else{e.lanes=[];e.nodes=[]}$.each(e.myWBSSet,function(t,a){e.myWBSSet[t].DelInd="";e.myWBSSet[t].ChangeIndicator="";e.myWBSSet[t].Group=e.myWBSSet[t].SubBoq;e.myWBSSet[t].Model=e.myWBSSet[t].Boq;e.myWBSSet[t].BuildingNo=e.myWBSSet[t].BuildingNo;e.myWBSSet[t].IdText=e.myWBSSet[t].ModelDesc;e.myWBSSet[t].WbsCode=e.myWBSSet[t].Wbs;i=parseFloat(i)+1;if(e.myWBSSet[t].ContractualIndicator==="O"){e.myWBSSet[t].sortNum=1}if(e.myWBSSet[t].ContractualIndicator==="V"){e.myWBSSet[t].sortNum=2}if(e.myWBSSet[t].ContractualIndicator==="A"){e.myWBSSet[t].sortNum=3}$.each(o.HeadToHeadVariationG,function(o,i){if(e.myWBSSet[t].Txt===i.OrderType+"-"+i.UserOrder){e.myWBSSet[t].OrderNo=i.OrderNo}})});e.WbslistNo=i;e.BuildingNO=t;o.myBuildingSet=e.myBuildingSet;o.myWBSSet=e.myWBSSet;e.HeadToHeadVariation=e.HeadToHeadVariationNav.results;e.variationBuilding=[];e.selectedBuildingOrWBS=[];o.PurchDoc=e.PurchDoc;o.getView().getModel("localJso").setProperty("/VariationMode",false);o.sCoCode=e.CompCode;o.sCoCode=e.CompCode;o.ContractNo=e.PoNumber;o.sProjectCode=e.ProjetTemp;o.sDocType=e.DocType;o.sVendor=e.Vendor;o.sVendorName=e.VendorName;o.SupeiorWBSCode=e.SuperiorWbs;e.ReleaseedMode=false;o.sConsultant=e.Consultant;o.sConsultantName=e.ConsultantName;o.SERTYPE=e.SerType;o.sPOrg=e.PurchOrg;o.sPGrp=e.PurGroup;o.DocParNo=e.DocParNo;e.IndexMonth=e.IndexMonth.split(",");if(e.CreationType==="E"&&e.Status==="COMPOSING")e.estimatedMode=true;else e.estimatedMode=false;o.getView().byId("idVendor").setValue(e.VendorName);o.getView().byId("idConsultant").setValue(e.ConsultantName);o.getView().byId("idserviceType").setValue(e.SerTypeDesc);var S=[o.getView().byId("idCompCode"),o.getView().byId("idProject")];var f=[o.sCoCode,o.sProjectCode];$.each(S,function(e,t){t.getBinding("items").attachEventOnce("dataReceived",function(){t.setSelectedKey(f[e])},this)});if(e.CreationType==="E"){var v=[];$.each(e.ContractPOSrvItemSet.results,function(t,o){if(o.SrvStatus!=="A"){e.ReleaseedMode=true}o.DelInd="";o.ChangeIndicator="";v.push(o)});e.EstimatedContracts=v;e.AttachmentSet=e.AttachmentSet.results;e.editMode=false;e.selectBoq=false;e.selectGroupBoq=false;e.BuildingSet=[],e.BoqModelSet=[];e.BoqItemSet=[];e.BoqMatGrpSet=[];e.BoqConsulidatedItemSet=[];e.BuildingConsulidatedItemSetfilter=[];e.myBuildingSet=[];o.myBuildingSet=[];e.AsbuildService=[];o.myWBSSet=[];e.myWBSSet=[];e.selectedBuilding=[];o.getView().setModel(new sap.ui.model.json.JSONModel(e),"localJson");o.getView().setBusy(false)}else{var y=e.POHeaderToBoqItem.results;var C=e.POHeaderToPOItem.results;o.POHeaderToPOSrv=e.ContractPOSrvItemSet.results;var v=[];var P=[];var B=[];var V=[];var w=[];var M=[];var I=JSON.parse(JSON.stringify(o.POHeaderToPOSrv));$.each(C,function(e,t){if(t.ContractualIndicator!=="E"){v.push(t)}});C=v;$.each(o.POHeaderToPOSrv,function(t,i){if(i.AsbuildVar!==""){$.each(e.HeadToHeadVariation,function(t,a){if(a.OrderDesc===i.AsbuildVar){var r=JSON.parse(JSON.stringify(i));r.Amount=JSON.parse(JSON.stringify((parseFloat(r.Qty)*parseFloat(r.PriceUnit)*-1).toFixed(o.CustomCurrency)));e.HeadToHeadVariation[t].OrderItemsSrvSet.push(r)}})}if(i.AsBuild2==="X"&&i.AsBuild==="X"){M.push(i)}i.ChangeIndicator="";if(i.SrvStatus!=="A"){e.ReleaseedMode=true}if(i.ContractualIndicator==="E"){i.DelInd="";B.push(i)}else{if(i.ServiceType===""){i.sorttype=1}else{i.sorttype=2}if(i.ContractualIndicator==="O"){i.sortNum=1}if(i.ContractualIndicator==="V"){i.sortNum=2}if(i.ContractualIndicator==="A"){i.sortNum=3}i.ProvisionRate=parseInt(i.ProvisionRate);i.Matdesc=i.ShortText;i.Qty=parseFloat(i.Qty);P.push(i)}});e.BuildingConsulidatedItemSetfilter=JSON.parse(JSON.stringify(P));o.POHeaderToPOSrv=P;e.AsbuildService=M;e.EstimatedContracts=B;var O=[];var D=[];D=o.Consoliatedserviceslistobject(JSON.parse(JSON.stringify(o.POHeaderToPOSrv)));D=D.sort((e,t)=>e.Data-t.Data);e.ServicNOCount=D.length;var r=[];var T=[];var b=[];var T={};var x=[];$.each(C,function(e,t){var o=false;if(O.length!==0){$.each(O,function(e,i){if(i.Buildingno!==""){if(i.Boq===t.Boq&&i.SubBoq===t.SubBoq&&i.MatlGroup===t.MatlGroup){o=true}}else{if(i.Boq===t.Boq&&i.SubBoq===t.SubBoq&&i.MatlGroup===t.MatlGroup){o=true}}})}else{O.push(t);o=true}if(!o)O.push(t)});setTimeout(function(){var t=[];$.each(O,function(e,o){var i=false;if(t.length===0)t.push({Data:o.Boq,ShortDesc:o.BoqStxt,LongDesc:o.BoqLtxt,DelInd:"",Indicator:"Z",live:"one",Model:o.Boq,PriceUnit:"0",MoiceUnit:"0",ModelType:o.Project!==""?"BOQ":"WBS",Categories:[{Data:o.SubBoq,DelInd:"",Indicator:"Z",ShortDesc:o.SubboqStxt,LongDesc:o.SubboqLtxt,Model:o.Boq,ModelType:o.Project!==""?"BOQ":"WBS",PriceUnit:"0",Categories:[{Data:o.MatlGroup,Item:o.MatlGroup,ShortDesc:o.Matdesc,LongDesc:o.Matdesc,DelInd:"",Indicator:"Z",Matdesc:o.ShortText,ModelType:o.Project!==""?"BOQ":"WBS",ChangeIndicator:"",PriceUnit:"0",Boq:o.Boq,SubBoq:o.SubBoq,Categories:[]}]}]});else{$.each(t,function(e,a){if(o.Boq===a.Model){var r=false;var s=false;$.each(t[e].Categories,function(a,n){if(o.SubBoq===n.Data){s=true}$.each(n.Categories,function(e,t){if(o.MatlGroup===t.Item&&o.SubBoq===n.Data){r=true}});if(!r)if(o.SubBoq===n.Data){t[e].Categories[a].Categories.push({Data:o.MatlGroup,Item:o.MatlGroup,Matdesc:o.Matdesc,LongDesc:o.Matdesc,ShortDesc:o.Matdesc,DelInd:"",Indicator:"Z",PriceUnit:"0",SubBoq:o.SubBoq,Boq:o.Boq,ModelType:o.Project!==""?"BOQ":"WBS",ChangeIndicator:"",Categories:[]})}i=true});if(!s)t[e].Categories.push({Data:o.SubBoq,Model:o.Boq,ShortDesc:o.SubboqStxt,LongDesc:o.SubboqLtxt,DelInd:"",Indicator:"Z",ModelType:o.Project!==""?"BOQ":"WBS",PriceUnit:"0",Categories:[{Data:o.MatlGroup,ShortDesc:o.Matdesc,LongDesc:o.Matdesc,DelInd:"",Indicator:"Z",Item:o.MatlGroup,Matdesc:o.ShortText,ModelType:o.Project!==""?"BOQ":"WBS",ChangeIndicator:"",PriceUnit:"0",SubBoq:o.SubBoq,Boq:o.Boq,Categories:[]}]})}});if(!i)t.push({Data:o.Boq,Model:o.Boq,ShortDesc:o.BoqStxt,LongDesc:o.BoqLtxt,live:"one",DelInd:"",Indicator:"Z",ModelType:o.Project!==""?"BOQ":"WBS",PriceUnit:"0",Categories:[{Data:o.SubBoq,Model:o.Boq,ShortDesc:o.SubboqStxt,LongDesc:o.SubboqLtxt,DelInd:"",Indicator:"Z",ModelType:o.Project!==""?"BOQ":"WBS",PriceUnit:"0",Categories:[{Data:o.MatlGroup,ShortDesc:o.Matdesc,LongDesc:o.Matdesc,Item:o.MatlGroup,DelInd:"",Indicator:"Z",Matdesc:o.ShortText,ModelType:o.Project!==""?"BOQ":"WBS",ChangeIndicator:"",PriceUnit:"0",SubBoq:o.SubBoq,Boq:o.Boq,Categories:[]}]}]})}});$.each(o.POHeaderToPOSrv,function(e,t){$.each(y,function(e,o){if(o.Serviceno===t.Serviceno&&o.SubBoq===t.SubBoq&&o.Boq===t.Boq&&o.Item===t.MatlGroup&&t.ContractualIndicator===o.ContractualIndicator){y[e].PriceUnit=t.PriceUnit;y[e].OvfTol=t.OvfTol;y[e].SubModel=t.SubBoq;y[e].UnitMeas=t.BaseUom;y[e].VariationOrder=t.VariationOrder;y[e].Txt=t.Txt;y[e].SrvStatus=t.SrvStatus;y[e].Eancat=t.ServiceType;y[e].LongText=t.SrvLongText;y[e].Qty_Srv=t.Qty;y[e].ProvisionRate=t.ProvisionRate}})});$.each(t,function(e,o){$.each(y,function(i,a){if(o.Model===a.Boq){$.each(t[e].Categories,function(o,i){if(i.Data===a.SubBoq&&i.Model===a.Boq){$.each(t[e].Categories[o].Categories,function(i,r){if(r.Data===a.Item&&r.SubBoq===a.SubBoq&&r.Boq===a.Boq){t[e].Categories[o].Categories[i].Categories.push({DelInd:"",Indicator:"Y",Model:a.Boq,LongDesc:a.LongText,ShortDesc:a.Servicedesc,Matdesc:a.Matdesc,Data:a.Serviceno,PriceUnit:a.PriceUnit,ProvisionRate:a.ProvisionRate,Price:a.PriceUnit,Data:a.Serviceno,Flag:a.Flag,UnitMeas:a.UnitMeas,Qty:a.Qty_Srv,SubModel:a.SubModel,ModelType:r.ModelType,ChangeIndicator:"",ContractualIndicator:a.ContractualIndicator,Item:a.Item,MatlGroup:a.Item,SrvNo:a.SrvNo,Txt:a.Txt,Uom:a.UnitMeas,Eancat:a.Eancat,VariationOrder:a.VariationOrder,SrvStatus:a.SrvStatus})}})}})}})});e.BuildingSet=[],e.BoqModelSet=y;e.BoqItemSet=t;e.BoqMatGrpSet=[];e.BoqConsulidatedItemSet=D;e.WbslistNo=i;e.selectedBuildinglist=[];e.selectedBuilding=[];$.each(o.myBuildingSet,function(e,t){o.BUBoQs.push(t.Model+t.Group)});$.each(o.myWBSSet,function(e,t){o.BUBoQs.push(t.Model+t.Group)});o.BUBoQs.sort();var a=null;var r=0;for(var s=0;s<=o.BUBoQs.length;s++){if(o.BUBoQs[s]!=a){if(r>0){o.Boqs.push({Model:a.substr(0,8),BoqSub:a.substr(8,4),Count:r,Categories:[],Services:[]})}a=o.BUBoQs[s];r=1}else{r++}}e.ContractPOSrvItemSet=I;if(C[0]){e.DeliveryDate=C[0].DeliveryDate;e.OvfTol=C[0].OvfTol}else{e.DeliveryDate="";e.OvfTol="0"}e.AttachmentSet=e.AttachmentSet.results;e.editMode=false;o.getView().setModel(new sap.ui.model.json.JSONModel(e),"localJson");o.getView().byId("idDisplayProcessFlow").updateModel();if(e.WFContractInboxNAV.results.length>0){o._readWFType()}var n=JSON.parse(JSON.stringify(o.getView().getModel("localJson").getProperty("/BuildingConsulidatedItemSetfilter")));var l=JSON.parse(JSON.stringify(o.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));var d=JSON.parse(JSON.stringify(o.getView().getModel("localJson").getProperty("/BoqItemSet")));$.each(l,function(e,t){$.each(d,function(e,t){$.each(t.Categories,function(t,i){$.each(i.Categories,function(a,r){$.each(r.Categories,function(r,s){var n=false;$.each(o.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===s.Model&&i.Data===t.Group&&t.AsBuild2===""){n=true}});$.each(o.myWBSSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===s.Model&&i.Data===t.Group&&t.AsBuild2===""){n=true}});if(n){d[e].PriceUnit="0";d[e].Categories[t].PriceUnit="0";d[e].Categories[t].Categories[a].PriceUnit="0"}})})})})});var g=[];$.each(l,function(e,t){$.each(d,function(e,o){$.each(o.Categories,function(o,i){$.each(i.Categories,function(i,a){$.each(a.Categories,function(a,r){if(t.Data===r.Data&&t.Txt===r.Txt){d[e].Categories[o].Categories[i].Categories[a].ProvisionRate=parseFloat(t.ProvisionRate);d[e].Categories[o].Categories[i].Categories[a].PriceUnit=parseFloat(t.PriceUnit)*parseFloat(d[e].Categories[o].Categories[i].Categories[a].Qty);if(r.Eancat!=="C"&&r.Eancat!=="U"){d[e].PriceUnit=(parseFloat(d[e].PriceUnit)+parseFloat(t.PriceUnit)*parseFloat(d[e].Categories[o].Categories[i].Categories[a].Qty)).toString()}if(r.Eancat!=="C"&&r.Eancat!=="U"){d[e].Categories[o].PriceUnit=(parseFloat(d[e].Categories[o].PriceUnit)+parseFloat(t.PriceUnit)*parseFloat(d[e].Categories[o].Categories[i].Categories[a].Qty)).toString()}if(r.Eancat!=="C"&&r.Eancat!=="U"){d[e].Categories[o].Categories[i].PriceUnit=(parseFloat(d[e].Categories[o].Categories[i].PriceUnit)+parseFloat(t.PriceUnit)*parseFloat(d[e].Categories[o].Categories[i].Categories[a].Qty)).toString()}}})})})})});$.each(n,function(e,t){});$.each(l,function(e,t){t.Amount=parseFloat(t.PriceUnit)*parseFloat(t.Qty)});o.addVAOld=0;$.each(d,function(e,t){o.addVAOld=parseFloat(o.addVAOld)+parseFloat(d[e].PriceUnit)});o.getView().getModel("localJson").setProperty("/BuildingConsulidatedItemSetfilter",JSON.parse(JSON.stringify(n)));o.getView().getModel("localJson").setProperty("/BoqConsulidatedItemSet",JSON.parse(JSON.stringify(l.sort((e,t)=>e.Data-t.Data))));o.getView().getModel("localJson").setProperty("/BoqItemSet",JSON.parse(JSON.stringify(d.sort((e,t)=>e.Data-t.Data))));o.getView().setBusy(false)},8e3)}}).catch(function(e){sap.m.MessageToast.show("Error");o.getView().setBusy(false)})},_bindView:function(e){var t=this.getModel("Contract"),o=this.getModel();this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){o.metadataLoaded().then(function(){t.setProperty("/busy",true)})},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("objectView"),o=e.getElementBinding();this.getResourceBundle()},_actionDialog:null,onActivateReleaseedPO:function(e){var t=this;var o="";var i=true;var a="",r="0004",s=t.getView().getModel("localJson").getProperty("/CreationType");var n=t.getModel("localJson").getProperty("/HeadToHeadVariation");if(n.length===0){i=true}else{$.each(n,function(e,t){if(t.VarStatus!=="R"){o=t.VarStatus;i=false}else{a=t.OrderNo;s=t.OrderType}})}if(i===true){if(!this._activateDialog){this._activateDialog=new sap.m.Dialog({title:"{i18n>Confirm}",content:[new sap.m.Label({text:t.getResourceBundle().getText("Are you sure you want to Activate ",this.docNo)})],beginButton:new sap.m.Button({text:"{i18n>Yes}",press:function(){this._activateDialog.close();var e=t.getView().getModel("localJson").getProperty("/PoNumber"),o=t.getOwnerComponent().getModel();t.getView().setBusy(true);o.callFunction("/POExecuteAction",{method:"POST",urlParameters:{PoNo:e,Decision:r,Notes:"",WorkitemId:t.getView().getModel("localJson").getProperty("/Workitem"),CreationType:t.getView().getModel("localJson").getProperty("/CreationType"),OrderNo:a,ActionType:s,Comments:""},success:function(o){t.getView().setBusy(false);sap.m.MessageBox.success(t.getView().getModel("i18n").getResourceBundle().getText("Contract "+e+" Release Triggered Workflow"),{title:t.getView().getModel("i18n").getResourceBundle().getText("Msg_Success"),onClose:function(e){t._onObjectMatched()}})},error:function(o){t.getView().setBusy(false);sap.m.MessageToast.show("Error in Activating contract "+e)}})}.bind(this)}),endButton:new sap.m.Button({text:"{i18n>No}",press:function(){this._activateDialog.close()}.bind(this)}),afterClose:function(){t._activateDialog.destroy();t._activateDialog=null}});this.getView().addDependent(this._activateDialog)}}else{sap.m.MessageToast.show(" Variation or Addendum should be is confirmed ")}this._activateDialog.open()},_activateDialog:null,onActivatePO:function(e){var t=this;var o="";var i=true,a="",r=r,s=t.getView().getModel("localJson").getProperty("/PoNumber"),n=t.getOwnerComponent().getModel();if(e.getSource().getId().lastIndexOf("idSubmitTermsBtn")>-1){a="0003";r=t.getView().getModel("i18n").getResourceBundle().getText("AreyousureyouwanttoActivate",s)}else if(e.getSource().getId().lastIndexOf("idDeteteContract")>-1){a="0008";r=t.getView().getModel("i18n").getResourceBundle().getText("AreyousureyouwanttoDetete",s)}if(i===true){if(!this._activateDialog){this._activateDialog=new sap.m.Dialog({title:"{i18n>Confirm}",content:[new sap.m.Label({text:r})],beginButton:new sap.m.Button({text:"{i18n>Yes}",press:function(){this._activateDialog.close();t.getView().setBusy(true);const e=n.bindContext("/POExecuteAction(...)");e.setParameter("PoNo",s);e.setParameter("Decision",a);e.setParameter("Notes"," ");e.setParameter("WorkitemId","");e.setParameter("CreationType",t.getView().getModel("localJson").getProperty("/CreationType"));e.setParameter("OrderNo","");e.setParameter("ActionType","");e.setParameter("Comments","");e.execute().then(()=>{t.getView().setBusy(false);if(a==="0003"){sap.m.MessageBox.success(t.getView().getModel("i18n").getResourceBundle().getText("Contract "+s+" Release triggered"),{title:t.getView().getModel("i18n").getResourceBundle().getText("Msg_Success"),onClose:function(e){t._onObjectMatched()}})}else if(a==="0008"){sap.m.MessageBox.success(t.getView().getModel("i18n").getResourceBundle().getText("Contract "+s+" IS Deleted"),{title:t.getView().getModel("i18n").getResourceBundle().getText("Msg_Success"),onClose:function(e){t.onWorklistPress()}})}}).catch(e=>{t.getView().setBusy(false);sap.m.MessageToast.show("Error in Activating contract "+s)})}.bind(this)}),endButton:new sap.m.Button({text:"{i18n>No}",press:function(){this._activateDialog.close()}.bind(this)}),afterClose:function(){t._activateDialog.destroy();t._activateDialog=null}});this.getView().addDependent(this._activateDialog)}}else{sap.m.MessageToast.show(" Variation or Addendum should be is confirmed ")}this._activateDialog.open()},onWorklistPress:function(e){this.getRouter().navTo("worklist",{},true)},_actionDialog:null,onActivatePOWF:function(e){var t=this;var o="";var i=true,a="",r="",s,n=t.getView().getModel("localJson").getProperty("/CreationType");if(e.getSource().getId().lastIndexOf("idAprove")>-1){r="0001";s=t.getView().getModel("i18n").getResourceBundle().getText("detailMsgConfirmApprovell")}else if(e.getSource().getId().lastIndexOf("idreject")>-1){r="0002";s=t.getView().getModel("i18n").getResourceBundle().getText("detailMsgConfirmReject")}else{r="0004";s=t.getView().getModel("i18n").getResourceBundle().getText("ContractReleasetriggeredWorkflow")}var l=t.getModel("localJson").getProperty("/HeadToHeadVariation");if(l.length===0){i=true}else{$.each(l,function(e,t){if(t.VarStatus!=="R"){o=t.VarStatus;i=false}else if(t.WfStatus===""||t.WfStatus==="INPROGRESS"){a=t.OrderNo;n=t.OrderType}})}if(i===true){if(!this._actionDialog){this._actionDialog=new sap.m.Dialog({title:s,type:"Message",content:[new sap.m.TextArea("Notes",{width:"100%",placeholder:s})],beginButton:new sap.m.Button({text:"{i18n>Confirm}",press:function(){var e=sap.ui.getCore().byId("Notes").getValue();var o=t.getView().getModel("localJson").getProperty("/PoNumber"),i=t.getOwnerComponent().getModel();t._actionDialog.close();t._actionDialog.destroy();t._actionDialog=null;i.callFunction("/POExecuteAction",{method:"POST",urlParameters:{PoNo:o,Decision:r,Notes:"",WorkitemId:t.getView().getModel("localJson").getProperty("/Workitem"),CreationType:t.getView().getModel("localJson").getProperty("/CreationType"),OrderNo:a,ActionType:n,Comments:e},success:function(e){if(r==="0004"){t.getView().setBusy(false);sap.m.MessageBox.success(t.getView().getModel("i18n").getResourceBundle().getText("Contract "+o+" Release triggered Workflow"),{title:t.getView().getModel("i18n").getResourceBundle().getText("Msg_Success"),onClose:function(e){t._onObjectMatched()}})}else{t.getView().setBusy(false);sap.m.MessageBox.success(t.getView().getModel("i18n").getResourceBundle().getText("Contract "+o+" Successfully Action"),{title:t.getView().getModel("i18n").getResourceBundle().getText("Msg_Success"),onClose:function(e){t._onObjectMatched()}})}},error:function(e){t.getView().setBusy(false);sap.m.MessageToast.show("Error in Activating contract "+o)}})}}),endButton:new sap.m.Button({text:"{i18n>Cancel}",press:function(){t._actionDialog.close();t._actionDialog.destroy();t._actionDialog=null}}),afterClose:function(){t._actionDialog.destroy()}});this.getView().addDependent(this._actionDialog);this._actionDialog.open()}}else{sap.m.MessageToast.show(" Variation or Addendum should be is confirmed ")}},_createDialog:null,oncreatePO:function(e){var t=this;this.rowContext=e.getSource().getBindingContext("dataModel");if(!this._createDialog){this._createDialog=new sap.m.Dialog({title:"{i18n>Confirm}",content:[new sap.m.Label({text:t.getResourceBundle().getText("detailRequestActivateMessage",this.docNo)})],beginButton:new sap.m.Button({text:"{i18n>Yes}",press:function(){this._createDialog.close();var e=t.getView().getModel("dataModel").getProperty("/PoNumber"),o=t.getOwnerComponent().getModel();t.getView().getModel("detailView").setProperty("/busy",true);o.callFunction("/CreatePurchaseOrder",{method:"POST",urlParameters:{PoNo:e},success:function(e){t.getView().getModel("detailView").setProperty("/busy",false);t.getView().getModel("detailView").setProperty("/bEnabled",false);t.getView().getModel("dataModel").setProperty("/Status","SUBMITTED FOR APPROVAL");t.handleSuccessMessageBox(t.getResourceBundle().getText("detailActivateSuccess",t.docNo))},error:function(e){t.getView().getModel("detailView").setProperty("/busy",false);sap.m.MessageToast.show(t.getResourceBundle().getText("detailActivateError"),{duration:4e3})}})}.bind(this)}),endButton:new sap.m.Button({text:"{i18n>No}",press:function(){this._createDialog.close()}.bind(this)}),afterClose:function(){t._createDialog.destroy();t._createDialog=null}});this.getView().addDependent(this._createDialog)}this._createDialog.open()},onEditPress:function(){var e=this;var t=this.getView();var o;this.Composing="";e.getView().getModel("localJson").setProperty("/editMode",true);var i=e.getView().byId("idCreationType").getSelectedKey();if(this.PurchDoc!==""&&this.getView().byId("idCreationType").getSelectedKey()==="O"){var a=e.getModel("localJson").getProperty("/HeadToHeadVariation");for(var r=0;r<a.length;r++){if(a[r].Status==="C"){this.Composing=a[r].Status;o=a[r].VarStatus}else{this.Composing=a[r].Status;o=a[r].VarStatus}}if(this.Composing==="C"){e.getView().getModel("localJso").setProperty("/VariationMode",false);e.getView().getModel("localJson").setProperty("/editMode",true)}else if(this.Composing==="R"&&o===""){e.getView().getModel("localJso").setProperty("/VariationMode",false);e.getView().getModel("localJson").setProperty("/editMode",true)}else if(this.Composing==="R"&&o==="R"){e.getView().getModel("localJso").setProperty("/VariationMode",true);e.getView().getModel("localJson").setProperty("/editMode",true)}else if(this.Composing===""&&i==="O"){e.getView().getModel("localJso").setProperty("/VariationMode",true);e.getView().getModel("localJson").setProperty("/editMode",true)}}else{e.getView().getModel("localJso").setProperty("/VariationMode",false);e.getView().getModel("localJson").setProperty("/editMode",true)}},onCancelPress:function(){var e=this;var t=this.getView();e.getView().getModel("localJson").setProperty("/editMode",false);e.getView().getModel("localJso").setProperty("/VariationMode",true);e._onObjectMatched();e._onBindingChange()},onChangeTolerance:function(){var e=this;var t=e.getView().byId("idTolerance").getValue();var o=e.getView().getModel("localJson").getProperty("/BoqItemSet");$.each(o,function(e,i){$.each(i.Categories,function(i,a){$.each(a.Categories,function(a,r){$.each(r.Categories,function(r,s){o[e].Categories[i].Categories[a].Categories[r].OvfTol=t})})})});e.getView().getModel("localJson").setProperty("/BoqItemSet",o)},onDisplaySearBuilding:function(){if(!this._BuildingDialog){this._BuildingDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.BuildingSearchDialog",this);this._BuildingDialog.setModel(this.getView().getModel())}this._BuildingDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"BUILDINGID");var i=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,this.sProj);var s=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.EQ,this.ModelCode);var n=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.EQ,this.GroupCode);t.push(o);if(this.sProjectCode.length>0){t.push(i)}if(this.sProj.length>0){t.push(r)}if(this.ModelCode.length>0){t.push(s)}if(this.GroupCode.length>0){t.push(n)}t.push(a);this._BuildingDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchBuilding:function(e){var t=e.getParameter("value");var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"BUILDINGID");var i=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,this.sProj);var n=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.EQ,this.ModelCode);var l=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.EQ,this.GroupCode);var d=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var g=[];g.push(o);if(this.sProjectCode.length>0){g.push(r)}if(this.sProj.length>0){g.push(s)}if(this.ModelCode.length>0){g.push(n)}if(this.GroupCode.length>0){g.push(l)}g.push(a);g.push(i);this._BuildingDialog.bindAggregation("items",{path:"/ValueHelpSet",template:d,filters:g})},onSelectBuilding:function(e){var t=this;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){t.Building=e.getObject().IdNumber;t.getView().byId("_IdBuilding").setValue(e.getObject().IdText)})}else{t.Building="";t.getView().byId("_IdBuilding").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchidSupeiorWBSDialog:function(){if(this.sCoCode&&this.sProjectCode){if(!this._SuperiorWBSDialog){this._SuperiorWBSDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SuperiorWBSSearchDialog",this);this._SuperiorWBSDialog.setModel(this.getView().getModel())}this._SuperiorWBSDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"SUBWBS");var i=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,1e3);t.push(o);t.push(i);t.push(a);t.push(r);this._SuperiorWBSDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})}else{sap.m.MessageToast.show(this.getView().getModel("i18n").getResourceBundle().getText("Msg_Error_Select_WBS_C"))}},handleSearWBS:function(){var e=this;if(!this._GroupDialog){this._GroupDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SuperiorWBSSearchDialog",this);this._GroupDialog.setModel(this.getView().getModel())}var t=e.getView().getModel();var o=new sap.ui.model.json.JSONModel;o.setData({SupeiorWBSSet:[]});e._SuperiorWBSDialog.setModel(o,"localJson");var i=[];var a=[];var r=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"SUBWBS");var s=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var n=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var l=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,sap.ui.getCore().byId("idDesc").getValue());var d=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idlenth").getValue());i.push(r);i.push(s);i.push(n);if(sap.ui.getCore().byId("idDesc").getValue()!==""){i.push(l)}if(sap.ui.getCore().byId("idlenth").getValue()!==""){i.push(d)}if(sap.ui.getCore().byId("idlenth").getValue()===""){var d=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,500);i.push(d)}t.read("/ValueHelpSet",{filters:i,success:function(t){var o=JSON.parse(JSON.stringify(t.results));e._SuperiorWBSDialog.getModel("localJson").setProperty("/SupeiorWBSSet",o)},error:function(e){sap.m.MessageToast.show("Error")}})},onSelectCheque:function(e){this.SupeiorWBSText=e.getParameters().rowContext.getObject().IdText;this.SupeiorWBSCode=e.getParameters().rowContext.getObject().IdNumber;this.getView().byId("idSupeiorWBS").setValue(this.SupeiorWBSText);this._SuperiorWBSDialog.close();that._SuperiorWBSDialog.destroy();that._SuperiorWBSDialog=null},_handleCancelPresswbs:function(){var e=this;e._SuperiorWBSDialog.close();e._SuperiorWBSDialog.destroy();e._SuperiorWBSDialog=null},handleSearchSuperior:function(e){var t=e.getParameter("value");var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"SUBWBS");var i=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,1e3);var n=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var l=[];l.push(o);l.push(i);l.push(a);l.push(r);l.push(s);this._SuperiorWBSDialog.bindAggregation("items",{path:"/ValueHelpSet",template:n,filters:l})},onSelectSuperiorList:function(e){var t=this;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){t.SupeiorWBSText=e.getObject().IdText;t.SupeiorWBSCode=e.getObject().IdNumber;t.getView().byId("idSupeiorWBS").setValue(e.getObject().IdText)})}else{t.SupeiorWBSText="";t.SupeiorWBSCode="";t.getView().byId("idSupeiorWBS").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearGroup:function(e){this.idSelestGroup=e.getSource().getId();if(!this._GroupDialog){this._GroupDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.GroupSearchDialog",this);this._GroupDialog.setModel(this.getView().getModel())}this._GroupDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var o=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Group");var a=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProj);var r=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.Contains,this.ModelCode);var n=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.Contains,this.Building);o.push(i);if(this.sProj.length>0){o.push(a)}if(this.ModelCode.length>0){o.push(s)}if(this.Building.length>0){o.push(n)}o.push(r);this._GroupDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:o})},handleSearchGroup:function(e){var t=this;var o=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Group");var a=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProj);var r=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var s=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,o);var n=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.Contains,this.ModelCode);var l=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.Contains,this.Building);var d=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var g=[];g.push(i);if(o!==""){g.push(s)}g.push(r);if(this.sProj.length>0){g.push(a)}if(this.ModelCode.length>0){g.push(n)}if(this.Building.length>0){g.push(l)}this._GroupDialog.bindAggregation("items",{path:"/ValueHelpSet",template:d,filters:g})},onSelectGroupList:function(e){var t=this;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){if(t.idSelestGroup==="idSearchByGroupp"){t.GroupCodee=e.getObject().IdNumber;t.getView().byId("idSearchByGroupp").setValue(e.getObject().IdText)}else{t.GroupCode=e.getObject().IdNumber;t.getView().byId("idSearchByGroup").setValue(e.getObject().IdText)}})}else{t.GroupCodee="";t.getView().byId("idSearchByGroup").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},_BuildinDialog:null,onBuildingSelectionValueHelpPress:function(){var e=this;var t=this.getModel("localJson").getProperty("/StatusOr");this.getView().getModel("localJson").setProperty("/selectBoq",false);if(this.PurchDoc!==""&&t==="Released Original"&&this.getView().byId("idCreationType").getSelectedKey()==="O"){if(t==="Released Original"){var o=e.getModel("localJson").getProperty("/HeadToHeadVariation");for(var i=0;i<o.length;i++){if(o[i].Status==="C"){if(o[i].UserOrder===""||o[i].OrderDesc===""){sap.m.MessageToast.show("Please Enter Manadatory Fields");return}this.Composing=o[i].Status}}if(this.Composing==""||this.Composing==="R"){sap.m.MessageToast.show("Please Create Variation order or Addenum");e.getView().getModel("localJso").setProperty("/VariationMode",false)}else{if(e.sProjectCode!==""&&e.sCoCode!==""){this.getView().getModel("localJson").setProperty("/BuildingSet",[]);var a=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.SelectMultiBuildingTable",this);if(!this._BuildinDialog){this._BuildinDialog=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.SelectMultiBuildingDialoge",this);this._BuildinDialog.setTable(a);this.getView().addDependent(this._BuildinDialog);e.aContexts=[];e.Boqs=[];e.BUBoQs=[]}e._BuildinDialog.open()}else{sap.m.MessageToast.show("Please select Company Code and Project first.")}}}else{sap.m.MessageToast.show("Please select Creation Type is Original .")}}else{if(e.sProjectCode!==""&&e.sCoCode!==""){this.getView().getModel("localJson").setProperty("/BuildingSet",[]);var a=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.SelectMultiBuildingTable",this);if(!this._BuildinDialog){this._BuildinDialog=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.SelectMultiBuildingDialoge",this);this._BuildinDialog.setTable(a);this.getView().addDependent(this._BuildinDialog);e.aContexts=[];e.Boqs=[];e.BUBoQs=[]}e._BuildinDialog.open();e.aContexts=[];e.Boqs=[];e.BUBoQs=[]}else{sap.m.MessageToast.show("Please select Company Code and Project first.")}}},onAfterClose:function(e){var t=this;t._oBuilding2Dialog.destroy();t._oBuilding2Dialog=null},onAfterCloseWBS:function(e){var t=this;e.getSource().destroy();t._oWBS2Dialog=null},onActionAfterClose:function(e){var t=this;t._action2Sheet.destroy();t._action2Sheet=null},_handleCancelPressBuilding:function(){var e=this;var t=e.getView().getModel("localJson").getProperty("/selectedBuilding");var o=[];for(var i=0;i<e.myBuildingSet.length;i++){var a=false;$.each(t,function(t,o){if(e.myBuildingSet[i].BuildingNo===o.BuildingNo&&e.myBuildingSet[i].Model===o.Model&&e.myBuildingSet[i].Group===o.Group)a=true});if(!a){o.push(e.myBuildingSet[i])}}e.myBuildingSet=JSON.parse(JSON.stringify(o));e.getView().getModel("localJson").setProperty("/myBuildingSet",e.myBuildingSet);e.getView().getModel("localJson").setProperty("/selectedBuilding",[]);e._oBuilding2Dialog.close();this.afterCloseBuilding()},afterCloseBuilding:function(){if(this._oBuilding2Dialog){this._oBuilding2Dialog.destroy();this._oBuilding2Dialog=null}},onProvisionRateChange:function(e){var t=this;if(e!==""){var o=e.getSource().getBindingContext("localJson").getPath();var i=this.getView().getModel("localJson");var a=i.getProperty(o);a.ChangeIndicator="X";i.setProperty(o,a);var r=e.getSource().getBindingContext("localJson").getObject();$.each(t.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===r.Boq&&r.SubBoq===t.Group&&t.Txt===r.Txt){t.ChangeIndicator="ChangeP"}});$.each(t.myWBSSet,function(e,t){if(t.Model===r.Boq){t.ChangeIndicator="ChangeP"}})}},onPriceConsolidatedChange:function(e,t,o){var i=this;var a="0.00",r="0.00",s="0.00";var n=i.getModel("localJson").getProperty("/HeadToHeadVariation");var l=JSON.parse(JSON.stringify(i.getView().getModel("localJson").getProperty("/BoqItemSet")));var d=JSON.parse(JSON.stringify(i.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet"))),g=JSON.parse(JSON.stringify(i.getView().getModel("localJson").getProperty("/PRItemSet"))),c=this.getView().getModel("localJson").getProperty("/myPurchaseRequisition");if(e!==""){var u=e.getSource().getBindingContext("localJson").getPath();var p=this.getView().getModel("localJson");var h=p.getProperty(u);h.ChangeIndicator="X";p.setProperty(u,h);var m=e.getSource().getBindingContext("localJson").getObject();var S=m.Data;$.each(l,function(e,t){$.each(t.Categories,function(t,o){$.each(o.Categories,function(o,i){$.each(i.Categories,function(i,a){l[e].PriceUnit="0";l[e].Categories[t].PriceUnit="0";l[e].Categories[t].Categories[o].PriceUnit="0"})})})});$.each(g,function(e,t){$.each(t.Categories,function(e,o){$.each(o.Categories,function(e,i){t.PriceUnit="0";o.PriceUnit="0";i.PriceUnit="0"})})});$.each(d,function(e,t){$.each(l,function(e,o){$.each(o.Categories,function(a,r){$.each(r.Categories,function(s,n){$.each(n.Categories,function(n,d){if(d.Data===S&&m.Txt===d.Txt){if(o.AddNew!=="AN"){d.ChangeIndicator="ChangeP"}}if(t.Data===d.Data&&t.Txt===d.Txt){var g=false;$.each(i.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===m.Boq&&m.SubBoq===t.Group&&t.Txt===m.Txt){if(o.AddNew!=="AN"){t.ChangeIndicator="ChangeP"}}if((t.Model.length===8?t.Model:"00000"+t.Model)===d.Model&&r.Data===t.Group){g=true}});$.each(i.myWBSSet,function(e,t){if(t.Model===d.Model){if(o.AddNew!=="AN"){t.ChangeIndicator="ChangeP"}}if(t.Model===d.Model){g=true}});if(g){t.PriceUnit=parseFloat(t.PriceUnit).toFixed(i.CustomCurrency);var c=JSON.parse(JSON.stringify(t.PriceUnit));l[e].Categories[a].Categories[s].Categories[n].Price=c;l[e].Categories[a].Categories[s].Categories[n].PriceUnit=(c*parseFloat(l[e].Categories[a].Categories[s].Categories[n].Qty)).toString();if(d.Eancat!=="C"&&d.Eancat!=="U"){l[e].PriceUnit=(parseFloat(l[e].PriceUnit)+c*parseFloat(l[e].Categories[a].Categories[s].Categories[n].Qty)).toString()}if(d.Eancat!=="C"&&d.Eancat!=="U"){l[e].Categories[a].PriceUnit=(parseFloat(l[e].Categories[a].PriceUnit)+c*parseFloat(l[e].Categories[a].Categories[s].Categories[n].Qty)).toString()}if(d.Eancat!=="C"&&d.Eancat!=="U"){l[e].Categories[a].Categories[s].PriceUnit=(parseFloat(l[e].Categories[a].Categories[s].PriceUnit)+c*parseFloat(l[e].Categories[a].Categories[s].Categories[n].Qty)).toString()}}}})})})})});$.each(d,function(e,t){$.each(g,function(e,o){$.each(o.Categories,function(e,i){$.each(i.Categories,function(e,a){if(a.Data===S&&m.Txt===a.Txt){if(o.AddNew!=="AN"){a.ChangeIndicator="ChangeP"}}if(t.Data===a.Data&&t.Txt===a.Txt){$.each(c,function(e,r){if(o.AddNew!=="AN"){r.ChangeIndicator="ChangeP"}if(r.PrNo==o.PrNumber&&i.Data===a.Item){var s=JSON.parse(JSON.stringify(t.PriceUnit));a.price=s;a.PriceUnit=(s*parseFloat(a.Qty)).toString();a.Qty=parseFloat(a.Qty).toString();if(a.Eancat!=="C"&&a.Eancat!=="U"){o.PriceUnit=(parseFloat(o.PriceUnit)+s*parseFloat(a.Qty)).toString()}if(a.Eancat!=="C"&&a.Eancat!=="U"){i.PriceUnit=(parseFloat(i.PriceUnit)+s*parseFloat(a.Qty)).toString()}}})}})})})})}else{var m=t;var S=m.Data;var f="1";$.each(l,function(e,t){$.each(t.Categories,function(t,o){$.each(o.Categories,function(o,i){$.each(i.Categories,function(i,a){l[e].PriceUnit="0";l[e].Categories[t].PriceUnit="0";l[e].Categories[t].Categories[o].PriceUnit="0"})})})});$.each(g,function(e,t){$.each(t.Categories,function(e,o){$.each(o.Categories,function(e,i){t.PriceUnit="0";o.PriceUnit="0";i.PriceUnit="0"})})});$.each(d,function(e,t){$.each(l,function(e,o){$.each(o.Categories,function(a,r){$.each(r.Categories,function(s,n){$.each(n.Categories,function(n,d){if(t.Data===d.Data&&t.Txt===d.Txt){if(d.Data===S&&m.Txt===d.Txt){if(o.AddNew!=="AN"){d.ChangeIndicator="ChangeP"}}var g=false;$.each(i.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===d.Model&&r.Data===t.Group){g=true}});$.each(i.myWBSSet,function(e,t){if(t.Model===d.Model){g=true}});if(g){t.PriceUnit=parseFloat(t.PriceUnit).toFixed(i.CustomCurrency);var c=JSON.parse(JSON.stringify(t.PriceUnit));l[e].Categories[a].Categories[s].Categories[n].Price=c;l[e].Categories[a].Categories[s].Categories[n].PriceUnit=(c*parseFloat(l[e].Categories[a].Categories[s].Categories[n].Qty)).toString();if(d.Eancat!=="C"&&d.Eancat!=="U"){l[e].PriceUnit=(parseFloat(l[e].PriceUnit)+c*parseFloat(l[e].Categories[a].Categories[s].Categories[n].Qty)).toString()}if(d.Eancat!=="C"&&d.Eancat!=="U"){l[e].Categories[a].PriceUnit=(parseFloat(l[e].Categories[a].PriceUnit)+c*parseFloat(l[e].Categories[a].Categories[s].Categories[n].Qty)).toString()}if(d.Eancat!=="C"&&d.Eancat!=="U"){l[e].Categories[a].Categories[s].PriceUnit=(parseFloat(l[e].Categories[a].Categories[s].PriceUnit)+c*parseFloat(l[e].Categories[a].Categories[s].Categories[n].Qty)).toString()}}}})})})})});$.each(d,function(e,t){$.each(g,function(e,o){$.each(o.Categories,function(e,i){$.each(i.Categories,function(e,a){if(a.Data===S&&m.Txt===a.Txt){if(o.AddNew!=="AN"){a.ChangeIndicator="ChangeP"}}if(t.Data===a.Data&&t.Txt===a.Txt){$.each(c,function(e,r){if(o.AddNew!=="AN"){r.ChangeIndicator="ChangeP"}if(r.PrNo==o.PrNumber&&i.Data===a.Item){var s=JSON.parse(JSON.stringify(t.PriceUnit));a.price=s;a.PriceUnit=(s*parseFloat(a.Qty)).toString();a.Qty=parseFloat(a.Qty).toString();if(a.Eancat!=="C"&&a.Eancat!=="U"){o.PriceUnit=(parseFloat(o.PriceUnit)+s*parseFloat(a.Qty)).toString()}if(a.Eancat!=="C"&&a.Eancat!=="U"){i.PriceUnit=(parseFloat(i.PriceUnit)+s*parseFloat(a.Qty)).toString()}}})}})})})})}var n=i.getModel("localJson").getProperty("/HeadToHeadVariation");$.each(n,function(e,t){if(n[e].Status==="C"){i.AddValueVariation(l)}});i.onAfterClose();$.each(d,function(e,t){t.Amount=(parseFloat(t.PriceUnit).toFixed(i.CustomCurrency)*parseFloat(t.Qty)).toFixed(i.CustomCurrency)});s=parseFloat(a)+parseFloat(r);i.getView().getModel("localJson").setProperty("/BoqConsulidatedItemSet",JSON.parse(JSON.stringify(d.sort((e,t)=>e.Data-t.Data))));i.getView().getModel("localJson").setProperty("/BoqItemSet",JSON.parse(JSON.stringify(l.sort((e,t)=>e.Data-t.Data))));i.getView().getModel("localJson").setProperty("/PRItemSet",JSON.parse(JSON.stringify(g.sort((e,t)=>e.Data-t.Data))));c=this.getView().getModel("localJson").setProperty("/myPurchaseRequisition",c);i.ContractValueHeader()},_handleValueHelpCloseBuilding:function(e){var t=this,o=t.getView().getModel();t.getView().setBusy(true);var i=t.getView().getModel();var a=t.getView().getModel("localJson").getProperty("/selectedBuilding");var r=t.getView().getModel("localJson").getProperty("/selectedBuildingOrWBS"),s=t.getModel("localJson").getProperty("/HeadToHeadVariation"),n=[],l=[];var d=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));if(t.aContexts.length===0)sap.m.MessageToast.show("Select one Building at least!");else{var g=false;$.each(t.myBuildingSet,function(e,t){if(t.Group===""){g=true}});if(g)sap.m.MessageToast.show("Select Boq for each Building!");else{$.each(a,function(e,o){t.BUBoQs.push(o.Model+o.Group)});t.BUBoQs.sort();this.objSet=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));this.selectedBuilding=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/selectedBuilding")));var c=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));var u="0.00";$.each(r,function(e,t){var o=new sap.ui.model.Filter("Data",sap.ui.model.FilterOperator.BT,t.Model,t.Group);if(o!==""){l.push(o)}});var p=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,t.sProjectCode);if(p!==""){l.push(p)}var h=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,t.sCoCode);if(h!==""){l.push(h)}o.read("/BoqTreeSet",{filters:l,success:function(e,o){e=e.results;var i=1;var a=[];var r="O";var n="";var l="UA";var d="";$.each(s,function(e,t){if(s[e].Status==="C"){r=s[e].OrderType;n=s[e].OrderNo;d=s[e].UserOrder}});if(r==="O"){var g="Original"}else{var g=r+"-"+d}$.each(e,function(t,o){if(e[t].LevelNo==="1"){e[t].AddNew="AN";e[t].live="one"}e[t].ModelType="BOQ";if(e[t].Eancat===""&&parseInt(e[t].LevelNo)===4){e[t].Qty="0";e[t].Uom="";e[t].Price="0"}if(e[t].Eancat==="U"){e[t].Qty=0}if(parseInt(e[t].LevelNo)===4){e[t].Txt=g;e[t].SrvStatus=l;if(e[t].Eancat!=""){e[t].PriceUnit="1";e[t].Price="1"}e[t].DelInd="";e[t].VariationOrder=n;e[t].ChangeIndicator="addB";e[t].ContractualIndicator=r;e[t].Indicator="Y";u=parseFloat(u)+parseFloat(e[t].Qty)*parseFloat(e[t].Price)}else{e[t].Indicator="Z"}});t.getView().getModel("localJson").setProperty("/myBuildingSet",t.myBuildingSet);t.getView().getModel("localJson").setProperty("/myBuildingSet",t.myBuildingSet);for(i;i<e.length+1;i++){a.push({[i]:[]});for(var c=0;c<e.length;c++){e[c].Categories=[];if(parseInt(e[c].LevelNo)===i){a[i-1][i].push(e[c])}}}var p=[];$.each(a,function(e,t){if(e<3){$.each(t,function(t,o){if(o.length!==0){$.each(o,function(t,o){$.each(a[e+1],function(e,t){$.each(t,function(e,t){if(t.length!==0){if(o.LevelId===t.Parent){o.Categories.push(t)}}})})})}})}});$.each(a[0],function(e,t){if(t.length!==0){$.each(t,function(e,t){p.push(t)})}});var h=false;var m=false;$.each(p,function(e,o){h=false;if(t.objSet.length!==0){$.each(t.objSet,function(i,a){$.each(o.Categories,function(r,s){$.each(a.Categories,function(e,t){if(o.Data===a.Data){h=true;if(s.Data===t.Data){m=true}}});if(h&&!m){if(s.Model===a.Model){t.objSet[i].Categories.push(p[e].Categories[r]);m=false}}})});if(!h&&!m){t.objSet.push(o);h=false}}else{t.objSet.push(o)}m=false;h=false});t.getView().getModel("localJson").setProperty("/BoqItemSet",t.objSet);t.getView().getModel("localJson").setProperty("/selectedBuildingOrWBS",[]);t.Consoliatedservices();var a=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));var S=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));$.each(a,function(e,t){$.each(t.Categories,function(t,o){$.each(o.Categories,function(o,i){$.each(i.Categories,function(i,r){a[e].PriceUnit="0";a[e].Categories[t].PriceUnit="0";a[e].Categories[t].Categories[o].PriceUnit="0";a[e].Categories[t].Categories[o].Categories[i].Matdesc=a[e].Categories[t].Categories[o].ShortDesc})})})});$.each(S,function(e,o){$.each(a,function(e,i){$.each(i.Categories,function(i,r){$.each(r.Categories,function(r,s){$.each(s.Categories,function(s,n){if(o.Data===n.Data&&o.Txt===n.Txt){var l=false;$.each(t.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===n.Model){l=true}});$.each(t.myWBSSet,function(e,t){if(t.Model===n.Model){l=true}});if(l){var d=JSON.parse(JSON.stringify(parseFloat(o.PriceUnit).toFixed(t.CustomCurrency)));a[e].Categories[i].Categories[r].Categories[s].price=d;a[e].Categories[i].Categories[r].Categories[s].PriceUnit=(d*parseFloat(a[e].Categories[i].Categories[r].Categories[s].Qty)).toString();if(n.Eancat!=="C"&&n.Eancat!=="U"){a[e].PriceUnit=(parseFloat(a[e].PriceUnit)+d*parseFloat(a[e].Categories[i].Categories[r].Categories[s].Qty)).toString()}if(n.Eancat!=="C"&&n.Eancat!=="U"){a[e].Categories[i].PriceUnit=(parseFloat(a[e].Categories[i].PriceUnit)+d*parseFloat(a[e].Categories[i].Categories[r].Categories[s].Qty)).toString()}if(n.Eancat!=="C"&&n.Eancat!=="U"){a[e].Categories[i].Categories[r].PriceUnit=(parseFloat(a[e].Categories[i].Categories[r].PriceUnit)+d*parseFloat(a[e].Categories[i].Categories[r].Categories[s].Qty)).toString()}}}})})})})});t.getView().getModel("localJson").setProperty("/BoqItemSet",JSON.parse(JSON.stringify(a)));t.ContractValueHeader();t.addBuildingForvariation()},error:function(e){sap.m.MessageToast.show("Error")}})}}},onDisplaySearchSubBoqDialog:function(e){var t=this;if(!this._oSubBoqDialog){this._oSubBoqDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SubBoqSearchDialog",this);this._oSubBoqDialog.setModel(this.getView().getModel())}this._oSubBoqDialog.open();this.sSubBoqId=e.getParameters().id;var o=e.getSource().getBindingContext("localJson").getObject().Model;var i=e.getSource().getBindingContext("localJson").getObject().Usagetype;this.BoqDescR=e.getSource().getBindingContext("localJson").getObject();var a=new sap.ui.model.Filter("Boq",sap.ui.model.FilterOperator.EQ,o);var r=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,t.sCoCode);var s=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,t.sProjectCode);var n=new sap.m.StandardListItem({title:"{BoqSub}",description:"{BoqDesc}"});var l=[];l.push(a);l.push(r);l.push(s);this._oSubBoqDialog.bindAggregation("items",{path:"/BoqSubItemSet",template:n,filters:l})},onDisplay2SearchSubBoqDialog:function(e){if(!this._oSubBoq2Dialog){this._oSubBoq2Dialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SubBoqSearchDialog",this);this._oSubBoq2Dialog.setModel(this.getView().getModel())}this._oSubBoq2Dialog.open();this.sSubBoq2Id=e.getParameters().id;var t=e.getSource().getBindingContext("localJson").getObject().SelectionParameter6;this.BoqDescR=e.getSource().getBindingContext("localJson").getObject();var o=new sap.ui.model.Filter("Boq",sap.ui.model.FilterOperator.EQ,t);var i=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,this.sCoCode);var a=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var r=new sap.m.StandardListItem({title:"{BoqSub}",description:"{BoqDesc}"});var s=[];s.push(o);s.push(i);s.push(a);this._oSubBoq2Dialog.bindAggregation("items",{path:"/BoqSubItemSet",template:r,filters:s})},onSelectSubBoqList:function(e){var t=this;var o;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){if(t.sSubBoqId!==""){o=e.getObject().BoqDesc;t.sSubBoq=e.getObject().BoqSub;sap.ui.getCore().byId(t.sSubBoqId).setValue(e.getObject().BoqSub);t.BoqDescR.BoqDesc=o}if(t.sSubBoq2Id!==""){o=e.getObject().BoqDesc;t.sSubBoq=e.getObject().BoqSub;t.sSubBoq2=e.getObject().BoqSub;sap.ui.getCore().byId(t.sSubBoq2Id).setValue(e.getObject().BoqSub);t.BoqDescR.BoqDesc=o}})}else{sap.m.MessageToast.show("No new item was selected.")}this.sSubBoq2Id="";this.sSubBoqId=""},_longTextDialog:null,onPressLongText:function(e){var t=this;t.itemIndex=e.getSource().getBindingContext("localJson").getPath();var o=e.getSource().getBindingContext("localJson").getObject();if(!t._longTextDialog){t._longTextDialog=sap.ui.xmlfragment(t.getView().getId(),"com.cicre.po.view.fragments.ServiceLongText",t);t.getView().addDependent(t._longTextDialog)}t._longTextDialog.open();t.getView().byId("idLongText").setText(o.ShortDesc)},onCloseLongTextFragment:function(e){this._longTextDialog.close()},onExpandFirstLevel:function(){var e=this.byId("TreeTableBasic");e.expandToLevel(3)},onCollapseAll:function(){var e=this.byId("TreeTableBasic");e.collapseAll()},handleOpenActionSheetVOA:function(e){var t=e.getSource();if(!this._actionSheetVOA){this._actionSheetVOA=sap.ui.xmlfragment("com.cicre.po.view.fragments.ActionVOADialog",this);this.getView().addDependent(this._actionSheetVOA)}this._actionSheetVOA.openBy(t)},onvariation_Order:function(){var e=this;if(e.sProjectCode!==""&&e.sCoCode!==""){if(!e._varOrdDialog){e._varOrdDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SelectMultiWBS",e);var t=new sap.ui.model.resource.ResourceModel({bundleUrl:"i18n/i18n.properties"});e._varOrdDialog.setModel(t,"i18n");e._varOrdDialog.setModel(e.getView().getModel())}e._varOrdDialog.open();var o=e.getView().getModel();var i=new sap.ui.model.json.JSONModel;i.setData({VariationOrderSet:[]});e._varOrdDialog.setModel(i,"localJson");var a=[];var r=new sap.ui.model.Filter("ContractNo",sap.ui.model.FilterOperator.EQ,"00235");a.push(r);o.read("/OrderHeaderSet",{filters:a,success:function(t){var o=JSON.parse(JSON.stringify(t.results));e._varOrdDialog.getModel("localJson").setProperty("/VariationOrderSet",o)},error:function(e){sap.m.MessageToast.show("Error")}})}else{sap.m.MessageToast.show("Please select Company Code and Project first.")}},onVoewAfterClose:function(e){var t=this;e.getSource().destroy();t._View2Sheet=null},_action2Sheet:null,handleOpenActionSheet:function(e){if(this.getView().byId("idCreationType").getSelectedKey()==="O"){var t=e.getSource();if(!this._action2Sheet){this._action2Sheet=sap.ui.xmlfragment("com.cicre.po.view.fragments.ActionSheetDialog",this);this.getView().addDependent(this._action2Sheet)}this._action2Sheet.openBy(t);sap.ui.getCore().byId("idonAddBuildings").setVisible(false);sap.ui.getCore().byId("idonAddWBS").setVisible(true);sap.ui.getCore().byId("idonAddBuildingsC").setVisible(false);sap.ui.getCore().byId("idonAddWBSC").setVisible(false)}else{sap.m.MessageToast.show("you should select Creation original order")}},onWBSSelectionValueHelpPressB:function(e){var t=this;t.fragmentType="";var o=this.getModel("localJson").getProperty("/StatusOr");if(e.getSource().getId().lastIndexOf("idAddPurchaseRequisitionc")>-1){t.fragmentType="PR"}if(this.PurchDoc!==""&&o==="Released Original"&&this.getView().byId("idCreationType").getSelectedKey()==="O"){if(o==="Released Original"){var i=t.getModel("localJson").getProperty("/HeadToHeadVariation");for(var a=0;a<i.length;a++){if(i[a].Status==="C"){if(i[a].UserOrder===""||i[a].OrderDesc===""){sap.m.MessageToast.show("Please Enter Manadatory Fields");return}this.Composing=i[a].Status}}if(this.Composing==""||this.Composing==="R"){sap.m.MessageToast.show("Please Create Variation order or Addenum");t.getView().getModel("localJso").setProperty("/VariationMode",false)}else{if(t.sProjectCode!==""&&t.sCoCode!==""){if(t.fragmentType==="PR"){this.onPRSelectionValueHelpPress()}else{t.onWBSSelectionValueHelpPress()}}else{sap.m.MessageToast.show("Please select Company Code and Project first.")}}}else{sap.m.MessageToast.show("Please select Creation Type is Original .")}}else{if(t.fragmentType==="PR"){this.onPRSelectionValueHelpPress()}else{t.onWBSSelectionValueHelpPress()}}},_handleCancelPressWBS:function(){var e=this;var t=e.getView().getModel("localJson").getProperty("/selectedBuilding");var o=[];for(var i=0;i<e.myWBSSet.length;i++){var a=false;$.each(t,function(t,o){if(e.myWBSSet[i].Model===o.Model)a=true});if(!a){o.push(e.myWBSSet[i])}}e.myWBSSet=JSON.parse(JSON.stringify(o));e.getView().getModel("localJson").setProperty("/myWBSSet",e.myWBSSet);e.getView().getModel("localJson").setProperty("/selectedBuilding",[]);e._oWBS2Dialog.close()},handleSearchBuildingPress:function(){var e=this;var t=e.getView().getModel(),o=true,i=e.getView().getModel("localJson");var a=[];var r=new sap.ui.model.Filter("Zone",sap.ui.model.FilterOperator.EQ,e.sProj);var s=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,e.sCoCode);var n=new sap.ui.model.Filter("BuildingNo",sap.ui.model.FilterOperator.EQ,e.Building);var l=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,e.sProjectCode);var d=new sap.ui.model.Filter("Group",sap.ui.model.FilterOperator.EQ,e.GroupCode);var g=new sap.ui.model.Filter("Model",sap.ui.model.FilterOperator.EQ,e.ModelCodee);if(e.sProj!=="")a.push(r);if(e.Building!=="")a.push(n);if(e.GroupCode!==""){a.push(d)}if(e.ModelCodee!==""){a.push(g)}a.push(s);a.push(l);t.read("/BuildingSet",{filters:a,success:function(t){$.each(t.results,function(i,a){if(a.Status==="")a.Status="COMPOSING";if(i==0){e.oldmodelvalue=t.results[i].Model}if(e.oldmodelvalue!=t.results[i].Model||e.oldmodelvalue===""){o=false}});e.BoqAll="";e.BoqDescAll="";e.getView().byId("idhandboq").setValue(e.BoqDescAll);var a=JSON.parse(JSON.stringify(t.results));i.setProperty("/BuildingSet",a);if(e.oldmodelvalue===""){o=false}if(o){e.getView().getModel("localJson").setProperty("/selectBoq",true)}i.refresh()},error:function(e){sap.m.MessageToast.show("Error")}})},onDisplaySearchProjDialog:function(e){this.idSearch=e.getSource().getId();if(!this._oProjDialog){this._oProjDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.ProjSearchDialog",this);this._oProjDialog.setModel(this.getView().getModel())}this._oProjDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var o=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Zone");var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.Contains,this.ModelCode);var n=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.Contains,this.Building);var l=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.Contains,this.GroupCode);o.push(i);o.push(a);o.push(r);if(this.ModelCode.length>0){o.push(s)}if(this.Building.length>0){o.push(n)}if(this.GroupCode.length>0){o.push(l)}this._oProjDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:o})},handleSearchProj:function(e){var t=e.getParameter("value");var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Zone");var i=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.Contains,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.Contains,this.ModelCode);var n=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.Contains,this.Building);var l=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.Contains,this.GroupCode);var d=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var g=[];g.push(o);g.push(i);g.push(a);g.push(r);if(this.ModelCode.length>0){g.push(s)}if(this.Building.length>0){g.push(n)}if(this.GroupCode.length>0){g.push(l)}this._oProjDialog.bindAggregation("items",{path:"/ValueHelpSet",template:d,filters:g})},onSelectProjList:function(e){var t=this;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){t.sProj=e.getObject().IdNumber;if(t.idSearch==="idSearchByProjectt"){t.getView().byId("idSearchByProjectt").setValue(e.getObject().IdText);t.sProjj=e.getObject().IdNumber}else{t.getView().byId("idSearchByProject").setValue(e.getObject().IdText);t.sProj=e.getObject().IdNumber}})}else{t.sProjj="";t.sProj="";t.getView().byId("idSearchByProject").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},handleSuggestProj:function(e){var t=e.getParameter("suggestValue");var o=[];if(t){o.push(new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"BE"));o.push(new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t))}e.getSource().getBinding("suggestionItems").filter(o)},onSelectProjSuggestion:function(e){this.sProj=e.getSource().getSelectedKey()},addBuildingForvariation:function(){var e=this;var t=e.getView().getModel("localJson").getProperty("/variationBuilding");var o=e.getModel("localJson").getProperty("/HeadToHeadVariation");var i=e.getView().getModel("localJson").getProperty("/BoqItemSet");var a=e.getView().getModel("localJson").getProperty("/PRItemSet"),r=e.getView().getModel("localJson").getProperty("/myPurchaseRequisition");var s=JSON.parse(JSON.stringify(e.getView().getModel("localJson").getProperty("/selectedBuilding")));var n=t;var l=0;var d,g={};$.each(s,function(t,o){if(o.vlive==="V"){var a=false;$.each(i,function(r,l){$.each(i[r].Categories,function(i,r){if(o.Group===r.Data&&(o.Model.length===8?o.Model:"00000"+o.Model)===(r.Model.length===8?r.Model:"00000"+r.Model)){s[t].Add="A";g={Group:s[t].Zzgroup,Status:"C",DeleteInd:s[t].DeleteInd,Action:s[t].Add,ContractNo:e.ContractNo,BuildingNo:s[t].BuildingNo===""?s[t].Model:s[t].BuildingNo,Zzone:s[t].Project,Model:s[t].Model,ModelDesc:s[t].ModelDesc===""?s[t].IdText:s[t].ModelDesc,Boq:s[t].Group,Amount:r.PriceUnit,Type:""};$.each(n,function(e,t){if(o.Group===t.Boq&&o.Model===t.Model&&o.BuildingNo===t.BuildingNo){a=true}});if(a===false){n.push(g)}}})})}});$.each(r,function(t,o){if(o.vlive==="V"&&o.SrvStatus!=="A"){var i=false;$.each(a,function(t,a){if(o.BuildingNo===a.PrNumber){o.Add="A";g={Group:"",Status:"C",DeleteInd:o.DeleteInd,Action:o.Add,ContractNo:e.ContractNo,BuildingNo:a.PrNumber,Zzone:"",Model:"",ModelDesc:o.BoqDesc,Boq:"",Amount:a.PriceUnit,Type:"PR"};$.each(n,function(e,t){if(o.BuildingNo===t.BuildingNo){i=true}});if(i===false){n.push(g)}}})}});$.each(o,function(e,t){if(o[e].Status==="C"){o[e].ChangeInd="X";$.each(n,function(e,o){o.OrderNo=t.OrderNo;t.OrderItemsSet.push(o)})}});e.getView().getModel("localJson").setProperty("/variationBuilding",n);e.getView().getModel("localJson").setProperty("/HeadToHeadVariation",o)},getModeandBoq:function(e,t){var o=this;var i=o.getView().getModel("localJson").getProperty("/variationBuilding");var a=this.getView().getModel("localJson");var r=e.substring(0,13),s=a.getProperty(r+"/Name"),n=a.getProperty(r+"/PriceUnit");var l=e.substring(0,26),d=a.getProperty(l+"/Name");$.each(o.myBuildingSet,function(e,a){if(d==a.Group&&s=="00000"+a.Model){if(i.length==0){o.myBuildingSet[e].Add=t;o.myBuildingSet[e].PriceUnit=n;i.push(o.myBuildingSet[e])}else{$.each(i,function(e,t){if("00000"+i[e].Model==s&&i[e].Group==d){i.splice(e,1)}});o.myBuildingSet[e].Add=t;o.myBuildingSet[e].PriceUnit=n;i.push(o.myBuildingSet[e])}}});return s,d},onDeleteService:function(e){var t=this;var o=e.getSource().getBindingContext("localJson").getPath();var i=this.getView();var a=i.getModel("i18n").getResourceBundle();var r=new sap.m.Dialog({title:a.getText("Delete"),type:"Message",content:new sap.m.Text({text:a.getText("Msg_srv_Delete")}),beginButton:new sap.m.Button({text:a.getText("Delete"),type:"Emphasized",press:function(){r.close();var e=t.getView().getModel("localJson");var i="D";var a=t.getView().getModel("localJson").getProperty(o);if(a.EanCat==="R"||"U"||"C"&&a.SrvStatus==="A"){sap.m.MessageToast.show("Can delete this service from App As Build")}else if(a.EanCat==="L"&&a.SrvStatus==="A"){}else if(a.SrvStatus==="UA"){var s=e.getProperty(o);s.DelInd=s.DelInd==="Y"?"":"Y";s.Add="D";e.setProperty(o,s);t.onChangeQty("",o,"0")}}}),endButton:new sap.m.Button({text:a.getText("Cancel"),press:function(){r.close()}}),afterClose:function(){r.destroy()}});r.open()},onDeleteBuilding:function(e){var t=this;var o=this.getView().byId("IdBuildingTable").getModel("localJson");var i=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var a=parseInt(i[2]);var r=o.getProperty("/myBuildingSet/"+a);var s=e.getSource().getBindingContext("localJson").getPath();var n=this.getView();var l=n.getModel("i18n").getResourceBundle();var d=new sap.m.Dialog({title:l.getText("Delete"),type:"Message",content:new sap.m.Text({text:l.getText("Msg_Confirm_Delete")}),beginButton:new sap.m.Button({text:l.getText("Delete"),type:"Emphasized",press:function(){var e=t.getView().getModel("localJson");var o=e.getProperty(s);if(r.SrvStatus==="UA"){o.DelInd="Y";o.ChangeIndicator="Y";d.close();r.Boq=r.Model.length===8?r.Model:"00000"+r.Model;t.deletesrv(r);t.deleteBOQliseConsolidate(r);e.setProperty(s,o)}}}),endButton:new sap.m.Button({text:l.getText("Cancel"),press:function(){d.close()}}),afterClose:function(){d.destroy()}});d.open()},onDeleteWBS:function(e){var t=this;var o=this.getView().byId("IdWBSTable").getModel("localJson");var i=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var a=parseInt(i[2]);var r=o.getProperty("/myWBSSet/"+a);var s=e.getSource().getBindingContext("localJson").getPath();var n=this.getView();var l=n.getModel("i18n").getResourceBundle();var d=new sap.m.Dialog({title:l.getText("Delete"),type:"Message",content:new sap.m.Text({text:l.getText("Msg_Confirm_Delete")}),beginButton:new sap.m.Button({text:l.getText("Delete"),type:"Emphasized",press:function(){var e=t.getView().getModel("localJson");var o=e.getProperty(s);if(r.SrvStatus==="UA"){o.DelInd="Y";o.ChangeIndicator="Y";d.close();r.Boq=r.Model.length===8?r.Model:"00000"+r.Model;t.deletesrv(r);t.deleteBOQliseConsolidate(r);e.setProperty(s,o)}else if(r.SrvStatus==="A"){sap.m.MessageToast.show("you should handel this service");o.DelInd=o.DelInd==="X"?"":"X";t.deletesrvA(r,s);d.close();e.setProperty(s,o)}}}),endButton:new sap.m.Button({text:l.getText("Cancel"),press:function(){d.close()}}),afterClose:function(){d.destroy()}});d.open()},onSave:function(){var e=this;var t=e.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet");var o=e.getView().getModel("localJson").getProperty("/BoqItemSet");var i=e.getView().getModel("localJson").getProperty("/AttachmentSet");var a=e.getView().getModel("localJson").getProperty("/EstimatedContracts");var r=e.getView().getModel("localJson").getProperty("/HeadToHeadVariation");var s=e.getView().getModel("localJso").getProperty("/variationOrderContract/Description");var n=e.getView().getModel("localJson").getProperty("/variationBuilding");var l=parseFloat(e.getView().getModel("localJson").getProperty("/AddendumValue"));var d=parseFloat(e.getView().getModel("localJson").getProperty("/VariationOrderValue"));var g=parseFloat(e.getView().getModel("localJson").getProperty("/OriginalContractValue"));var c=parseFloat(e.getView().getModel("localJson").getProperty("/VariationOrderPre"));var u=e.getView().getModel("localJson").getProperty("/myPurchaseRequisition"),p=e.getView().getModel("localJson").getProperty("/PRItemSet"),h=e.getView().getModel("localJson").getProperty("/ContractPONoteSet");var m=parseFloat(g)*.2;var S="";var f=[];var v=[];var y=[];var C=[];var P=[];var B=[];var V=this.getView();var w=V.getModel("i18n").getResourceBundle();var M=new sap.m.Dialog({title:w.getText("Edit"),type:"Message",content:new sap.m.Text({text:w.getText("Msg_Confirm_Save_Change")}),beginButton:new sap.m.Button({text:w.getText("SaveChange"),type:"Emphasized",press:function(){var s=parseFloat(g)*((parseFloat(c)+parseFloat(l))/100);if(s<d){sap.m.MessageToast.show(e.getView().getModel("i18n").getResourceBundle().getText("Total_of_variationorder_you_must_less_than",s));e.getView().setBusy(false);return}if(m<=d&&parseFloat(d)!=0){sap.m.MessageBox.warning(e.getView().getModel("i18n").getResourceBundle().getText("Total_variation_orders_exceeds_20_from_the_original"))}$.each(r,function(e,t){$.each(t.OrderItemsSet,function(e,o){o.Status=t.Status;n.push(o)})});$.each(r,function(t,i){if(e.PurchDoc!==""&&r[t].VarStatus!=="R"){C.push({OrderNo:r[t].OrderNo===""?"":r[t].OrderNo,UserOrder:r[t].UserOrder,OrderType:r[t].OrderType,OrderDesc:r[t].OrderDesc,Type:r[t].Type,OrderDate:r[t].OrderDate===""?null:e.formatDate(r[t].OrderDate)+"T00:00:00",MonthIndex:r[t].MonthIndex.toString(),AddValues:""+parseFloat(r[t].AddValues).toFixed(e.CustomCurrency)+""===""?"0.0":""+parseFloat(r[t].AddValues).toFixed(e.CustomCurrency)+"",OmissionValues:""+parseFloat(r[t].OmissionValues).toFixed(e.CustomCurrency)+""===""?"0.0":""+parseFloat(r[t].OmissionValues).toFixed(e.CustomCurrency)+"",ChangeAmount:""+parseFloat(r[t].ChangeAmount).toFixed(e.CustomCurrency)+""===""?"0.0":""+parseFloat(r[t].ChangeAmount).toFixed(e.CustomCurrency)+"",DaysNo:r[t].DaysNo.toString(),MonthNo:r[t].MonthNo.toString(),Action:r[t].Action,ContractNo:e.ContractNo,Status:r[t].Status,OrderItemsSet:f,ChangeInd:r[t].ChangeInd,Currency:e.getView().byId("idCurrency").getValue()});$.each(n,function(t,i){if(i.Status==="C"){$.each(o,function(t,a){$.each(o[t].Categories,function(t,o){if(i.Boq===o.Data&&(i.Model.length===8?i.Model:"00000"+i.Model)===(o.Model.length===8?o.Model:"00000"+o.Model)){f.push({Group:i.Group,OrderNo:i.OrderNo,OrderItem:i.OrderItem,DeleteInd:i.DeleteInd,Action:i.Action,ContractNo:e.ContractNo,BuildingNo:i.BuildingNo,Zzone:i.Zzone,Model:i.Model,ModelDesc:i.ModelDesc,Boq:i.Boq,Amount:parseFloat(o.PriceUnit).toFixed(2).toString()})}})})}})}});$.each(e.myBuildingSet,function(e,t){B.push(t)});$.each(e.myWBSSet,function(e,t){B.push(t)});$.each(u,function(e,t){t.Group="";t.Project="";t.Model="";B.push(t)});$.each(B,function(t,o){if(o.ChangeIndicator!==""||o.DelInd!==""){P.push({PoHeader:e.PoNumber,Buildingno:o.BuildingNo,Zone:o.Project,Model:o.Model,Submodel:o.Group,ContractualIndicator:o.ContractualIndicator===""?"O":o.ContractualIndicator,TextContInd:o.Txt,VariationOrder:o.OrderNo,ChangeIndicator:o.ChangeIndicator,DeleteIndicator:o.DelInd,SrvStatus:o.SrvStatus,Network:o.Network,Type:o.ModelType})}});if(u.length>0){$.each(p,function(t,o){$.each(o.Categories,function(t,i){$.each(i.Categories,function(t,a){v.push({PoHeader:e.PoNumber,PoItem:"",SubBoq:a.SubModel,DeleteInd:a.DelInd,Plant:"",MatlGroup:a.MatlGroup,Qty:parseFloat(a.Qty.toString()).toFixed(2),PoUnit:"",PriceUnit:a.PriceUnit.toString(),ItemCat:"",Acctasscat:"",Boq:a.Model,ShortText:a.ShortDesc,LongText:a.LongDesc,Serviceno:a.Data,Servicedesc:a.ShortDesc,BaseUom:a.Uom,WbsElement:"",NoLimit:"X",Buildingno:o.PrNumber,Project:"",OvfTol:a.OvfTol?a.OvfTol.toString():"0",ChangeIndicator:"",DeliveryDate:e.getView().byId("idDeliveryDate").getValue(),ContractualIndicator:"",SrvStatus:"UA",ServiceType:a.Eancat,Currency:e.getView().byId("idCurrency").getValue(),IuidRelevant:"P",PrItem:a.Item,Network:o.Network,ActivityNumber:i.ActivityNumber})})})})}if(P.length>0){$.each(o,function(t,i){$.each(i.Categories,function(a,r){$.each(r.Categories,function(r,s){$.each(s.Categories,function(r,n){v.push({PoHeader:e.PoNumber,Project:"",Boq:n.Model,SubBoq:o[t].Categories[a].Data,Flag:"U",DeleteInd:n.DelInd,Plant:"",Matdesc:s.ShortDesc,MatlGroup:n.Item,Qty:parseFloat(n.Qty.toString()).toFixed(2),PoUnit:"",ItemCat:"D",Acctasscat:"P",ShortText:n.ShortDesc,LongText:n.LongDesc,Serviceno:n.Data,Servicedesc:n.ShortDesc,NoLimit:"X",BaseUom:n.Uom,OvfTol:n.OvfTol?n.OvfTol.toString():"0",Buildingno:"",DeliveryDate:e.getView().byId("idDeliveryDate").getValue(),ChangeIndicator:"",ContractualIndicator:"",SrvStatus:"",ServiceType:n.Eancat,VariationOrder:"",Txt:"",Currency:e.getView().byId("idCurrency").getValue(),IuidRelevant:i.ModelType==="WBS"?"X":""})})})})})}$.each(v,function(o,i){$.each(t,function(t,a){if(i.Serviceno===a.Data){v[o].Plant=a.Plant;v[o].PriceUnit=parseFloat(a.PriceUnit).toFixed(e.CustomCurrency);v[o].OvfTol=a.OvfTol?a.OvfTol.toString():"0";v[o].ProvisionRate=a.ProvisionRate?a.ProvisionRate.toString():"0"}});$.each(e.POHeaderToPOSrv,function(e,t){if(i.Buildingno===t.Buildingno&&i.Txt===t.Txt&&i.MatlGroup===t.MatlGroup&&i.Serviceno===t.Serviceno&&i.SubBoq===t.SubBoq){v[o].SrvNo=t.SrvNo;v[o].PoItem=t.PoItem}})});$.each(y,function(o,i){$.each(e.POHeaderToPOSrv,function(e,t){if(i.Boq===t.Boq&&i.Txt===t.Txt&&i.MatlGroup===t.MatlGroup&&i.Serviceno===t.Serviceno&&i.SubBoq===t.SubBoq){y[o].SrvNo=t.SrvNo;y[o].PoItem=t.PoItem}});$.each(t,function(t,a){if(i.Serviceno===a.Data&&i.Txt===a.Txt){y[o].PriceUnit=parseFloat(a.PriceUnit).toFixed(e.CustomCurrency);y[o].Currency=e.getView().byId("idCurrency").getValue();y[o].ProvisionRate=a.ProvisionRate?a.ProvisionRate.toString():"0"}})});$.each(a,function(t,o){if(o.ChangeIndicator!==""||o.DelInd!==""){v.push({PoHeader:e.PoNumber,PoItem:o.PoItem===""?"":o.PoItem,SubBoq:"",DeleteInd:o.DelInd,Plant:"",MatlGroup:"",Amount:parseFloat(o.Amount).toFixed(e.CustomCurrency),PoUnit:"",Boq:"",ShortText:"",Serviceno:"",Servicedesc:o.Servicedesc,BaseUom:"",WbsElement:"",NoLimit:"",Buildingno:"",Project:"",ContractualIndicator:"E",ChangeIndicator:o.ChangeIndicator,ServiceType:"E",DeliveryDate:e.getView().byId("idDeliveryDate").getValue()})}});if(h.Flag!="X"){h={}}setTimeout(function(){var t={PoNumber:e.PoNumber,Flag:"U",DocType:e.getView().getModel("localJson").getProperty("/DocType"),Project:e.sProjectCode,Vendor:e.getView().getModel("localJson").getProperty("/Vendor"),PurchOrg:e.getView().getModel("localJson").getProperty("/PurchOrg"),PurGroup:e.getView().getModel("localJson").getProperty("/PurGroup"),CompCode:e.getView().getModel("localJson").getProperty("/CompCode"),DocDate:e.getView().getModel("localJson").getProperty("/DocDate")===""?null:e.getView().byId("idDocumentDate").getValue()+"T00:00:00",VperStart:e.getView().getModel("localJson").getProperty("/VperStart")===""?null:e.getView().byId("idValidFromDate").getValue()+"T00:00:00",VperEnd:e.getView().getModel("localJson").getProperty("/VperEnd")===""?null:e.getView().byId("idValidToDate").getValue()+"T00:00:00",Status:"",DeleteInd:"",ContractDesc:e.getView().byId("idContractDescription").getValue(),LongDesc:e.getView().byId("idLongDescription").getValue(),Currency:e.getView().byId("idCurrency").getValue(),MeasMethod:e.getView().byId("idMeasurementMethod").getSelectedKey(),ConstructionType:e.getView().byId("idConstructionType").getSelectedKey(),RefContract:e.getView().byId("idRefrenceContract").getValue(),CreationDate:e.getView().byId("idDocumentDate").getValue()===""?null:e.getView().byId("idDocumentDate").getValue()+"T00:00:00",ValidFrom:e.getView().byId("idValidFromDate").getValue()===""?null:e.getView().byId("idValidFromDate").getValue()+"T00:00:00",ValidTo:e.getView().byId("idValidToDate").getValue()===""?null:e.getView().byId("idValidToDate").getValue()+"T00:00:00",SigninDate:e.getView().byId("idDeliveryDate").getValue()===""?null:e.getView().byId("idDeliveryDate").getValue()+"T00:00:00",RevisedValidTo:e.getView().byId("idRevisedValidToDate").getValue()===""?null:e.getView().byId("idRevisedValidToDate").getValue()+"T00:00:00",IndexMonth:e.getView().byId("idIndexMonth").getSelectedKeys().join(),Consultant:e.sConsultant,ConsultantName:e.sConsultantName,Ss:e.getView().byId("idResponsiblepersonSS").getSelectedKey(),Ir:e.getView().byId("idResponsiblepersonIR").getSelectedKey(),SuperiorWbs:e.SupeiorWBSCode,CreationType:e.getView().byId("idCreationType").getSelectedKey(),MarkUp:e.getView().byId("idMarkUp").getValue(),VendorName:e.sVendorName,PurchDoc:e.PurchDoc,ContractType:e.getView().getModel("localJson").getProperty("/ContractType"),AttachmentSet:i,POHeaderToPOItem:v,POHeaderToPOBuildingNav:P,DocParNo:e.DocParNo,HeadToHeadVariationNav:C,EstimatedContractValue:parseFloat(e.getModel("localJson").getProperty("/EstimatedContractValue")).toFixed(e.CustomCurrency),OriginalContractValue:parseFloat(e.getModel("localJson").getProperty("/OriginalContractValue")).toFixed(e.CustomCurrency),TotalContractValue:parseFloat(e.getModel("localJson").getProperty("/TotalContractValue")).toFixed(e.CustomCurrency),VariationOrderValue:parseFloat(e.getModel("localJson").getProperty("/VariationOrderValue")).toFixed(e.CustomCurrency),AddendumValue:parseFloat(e.getModel("localJson").getProperty("/AddendumValue")).toFixed(e.CustomCurrency),RevisedContractValue:parseFloat(e.getModel("localJson").getProperty("/RevisedContractValue")).toFixed(e.CustomCurrency),SerType:e.SERTYPE,Overviewstatus:e.getModel("localJson").getProperty("/Overviewstatus"),ContractPONoteNav:h};var o=e.getView().getModel();console.log(t);e.getView().setBusy(true);o.create("/ContractPOHeaderSet",t,{success:function(t){sap.m.MessageBox.success("Contract "+t.PurchDoc+" Edited Successfully!",{title:"Success",onClose:function(t){e._onObjectMatched()}});e.getView().setBusy(false)},error:function(t){sap.m.MessageBox.error("Error in editing Contract",{title:"Error"});e.getView().setBusy(false)}})},2e3);M.close()}}),endButton:new sap.m.Button({text:w.getText("Cancel"),press:function(){M.close()}}),afterClose:function(){M.destroy()}});M.open()},onChangeQty:function(e,t,o,i){var a=this;var r=this.getView().getModel("localJson");if(e!==""){var s=e.getSource().getBindingContext("localJson").getPath();var n=e.getParameters().newValue}else{var s=t;var n=o}var l=a.getView().getModel("localJson").getProperty(s);if(l===null){l=i}var d=s.substring(0,13),g=r.getProperty(d+"/Name"),c=r.getProperty(d+"/PriceUnit"),u=r.getProperty(d+"/AddNew");if(u!=="AN"){l.ChangeIndicator="ChangeP"}if(e!==""){var p=e.getSource().getBindingContext("localJson").getPath();var h=this.getView().getModel("localJson");var m=h.getProperty(p);var S="A"}var f=JSON.parse(JSON.stringify(a.getView().getModel("localJson").getProperty("/BoqItemSet")));var v=JSON.parse(JSON.stringify(a.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));var y=JSON.parse(JSON.stringify(a.getView().getModel("localJson").getProperty("/myBuildingSet")));var C=JSON.parse(JSON.stringify(a.getView().getModel("localJson").getProperty("/myWBSSet")));var P=0;var B=0;if(l.ModelType==="BOQ"){$.each(y,function(e,t){if(t.Model===l.Boq)++P})}else{$.each(C,function(e,t){if(t.Model===l.Boq)++P})}$.each(f,function(e,t){$.each(t.Categories,function(e,t){$.each(t.Categories,function(e,t){$.each(t.Categories,function(e,t){if(l.Serviceno===t.Serviceno&&l.Txt===t.Txt){B=(parseFloat(B)+parseFloat(t.Qty)).toString()}})})})});$.each(v,function(e,t){if(t.Serviceno===l.Serviceno&&t.Txt===l.Txt){v[e].Qty=B}});a.getView().getModel("localJson").setProperty(s+"/Qty",n===""?"0":JSON.parse(JSON.stringify(n)));a.getView().getModel("localJson").setProperty("/BoqConsulidatedItemSet",JSON.parse(JSON.stringify(v.sort((e,t)=>e.Data-t.Data))));a.onPriceConsolidatedChange("",l,JSON.parse(JSON.stringify(n)))},DataExport:function(e){var t=this,o=[];var i=t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet");$.each(i,function(e,t){if(t.AsBuild2!=="X"&&t.AsBuild!=="X"){o.push({PoHeader:t.PoHeader,ContractualIndicator:t.Txt,Services:t.Data,Servicedesc:t.LongDesc,Uom:t.Uom,Qty:t.Qty,PurchDoc:t.PurchDoc,PriceUnit:t.PriceUnit,sortNum:t.sortNum})}});JSON.parse(JSON.stringify(o.sort((e,t)=>e.Services-t.Services)));o.sort((e,t)=>e.sortNum-t.sortNum);t.getView().getModel("localJson").setProperty("/BoqConsulidatedItemSetex",o);var a,r,n,l;var d,o=[],a=t.createColumnConfig();r=t.getModel("localJson").getProperty("/BoqConsulidatedItemSetex");n={workbook:{columns:a},dataSource:r};l=new s(n);l.build().then(function(){}).finally(l.destroy)},createColumnConfig:function(){var e=this.getView().getModel("i18n").getResourceBundle();return[{label:"PoHeader",property:"PoHeader",width:"20"},{label:"ContractualIndicator",property:"ContractualIndicator",width:"20"},{label:"Services",property:"Services",width:"25"},{label:"Servicedesc",property:"Servicedesc",width:"30"},{label:"Uom",property:"Uom",width:"20"},{label:"Qty",property:"Qty",width:"23"},{label:"PriceUnit",property:"PriceUnit",width:"23"}]},exportExcel:function(e,t,o,i){var a=this;var r=[];var s="/";var n=false;var l=false;var d=e.getData();for(var g in d){if(g==t){s=s+g;var c=d[g];for(var g in c){var u=c[g];for(var g in u){var p=u[g];var h={name:g,template:{content:"{"+g+"}"}};if(typeof i==="undefined"){if(g!="__metadata")r.push(h)}else{if(i.includes(g)){r.push(h)}}}if(typeof i!=="undefined"){r.sort(function(e,t){return i.indexOf(e.name)-i.indexOf(t.name)})}break}}}$.each(d[t],function(e,o){for(var i in o){if(o.hasOwnProperty(i)){if(!isNaN(d[t][e][i])&&i!="Services"){if(i!="Accumulative")d[t][e][i]=a.ceilNumberWithCommas(d[t][e][i]);else d[t][e][i]=a.NumberWithCommas(d[t][e][i])}}}});var m=new sap.ui.model.json.JSONModel(d);var S=new sap.ui.core.util.Export({exportType:new sap.ui.core.util.ExportTypeCSV({separatorChar:","}),models:m,rows:{path:s},columns:r});if(o!=""){S.saveFile(o).always(function(){this.destroy()})}},ceilNumberWithCommas:function(e){var t=e.toString().split(".");t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,",");return t.join(".")},NumberWithCommas:function(e){var t=e.toString().split(".");t[0]=t[0].replace(/\B(?=(\d{3})+(?!\d))/g,",");return t.join(".")},_handleValueHelpCloseWBS:function(e){var t=this,o=t.getView().getModel(),i=[],a=[];var r=new sap.ui.model.json.JSONModel;var s=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/selectedBuilding")));var n=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));var l="0.00";if(t.aContexts.length===0)sap.m.MessageToast.show("Select one WBS at least!");else{var d=false;$.each(t.myWBSSet,function(e,t){if(t.Group===""){d=true}});if(d)sap.m.MessageToast.show("Select Boq for each WBS!");else{$.each(s,function(e,o){t.BUBoQs.push(o.Model+o.Group)});t.BUBoQs.sort();var g=t.getView().getModel("localJson").getProperty("/selectedBuildingOrWBS"),c=t.getModel("localJson").getProperty("/HeadToHeadVariation");$.each(g,function(e,t){var o=new sap.ui.model.Filter("Data",sap.ui.model.FilterOperator.BT,t.Model,t.Group);if(o!==""){i.push(o)}});var u=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,t.sProjectCode);if(u!==""){i.push(u)}var p=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,t.sCoCode);if(p!==""){i.push(p)}var h=new sap.ui.model.Filter("Eancat",sap.ui.model.FilterOperator.EQ,"W");if(h!==""){i.push(h)}this.objSet=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));t.getView().getModel("localJson").setProperty("/selectedBuildingOrWBS",[]);var m=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));var S=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));o.read("/BoqTreeSet",{filters:i,success:function(e,o){e=e.results;var i=1,a=[],r="O",s="",n="UA",d="";$.each(e,function(t,o){$.each(c,function(e,t){if(c[e].Status==="C"){r=c[e].OrderType;s=c[e].OrderNo;d=c[e].UserOrder}});if(r==="O"){var i="Original"}else{var i=r+"-"+d}if(e[t].LevelNo==="1"){e[t].AddNew="AN";e[t].live="one"}if(e[t].Eancat===""&&parseInt(e[t].LevelNo)===4){e[t].Qty="0";e[t].Uom="";e[t].Price="0"}e[t].ModelType="WBS";if(e[t].Eancat==="U"){e[t].Qty=0}if(parseInt(e[t].LevelNo)===4){e[t].Txt=i;e[t].SrvStatus=n;if(e[t].Eancat!=""){e[t].PriceUnit="1";e[t].Price="1"}e[t].DelInd="";e[t].VariationOrder=s;e[t].ChangeIndicator="addB";e[t].ContractualIndicator=r;e[t].Indicator="Y";l=parseFloat(l)+parseFloat(e[t].Qty)*parseFloat(e[t].Price)}else{e[t].Indicator="Z"}});t.getView().getModel("localJson").setProperty("/myWBSSet",JSON.parse(JSON.stringify(t.myWBSSet)));for(i;i<e.length+1;i++){a.push({[i]:[]});for(var g=0;g<e.length;g++){e[g].Categories=[];if(parseInt(e[g].LevelNo)===i){a[i-1][i].push(e[g])}}}var u=[];$.each(a,function(e,t){if(e<3){$.each(t,function(t,o){if(o.length!==0){$.each(o,function(t,o){$.each(a[e+1],function(e,t){$.each(t,function(e,t){if(t.length!==0){if(o.LevelId===t.Parent){o.Categories.push(t)}}})})})}})}});$.each(a[0],function(e,t){if(t.length!==0){$.each(t,function(e,t){u.push(t)})}});var p=false;var h=false;$.each(u,function(e,o){p=false;if(t.objSet.length!==0){$.each(t.objSet,function(i,a){$.each(o.Categories,function(r,s){$.each(a.Categories,function(e,t){if(o.Data===a.Data){p=true;if(s.Data===t.Data){h=true}}});if(p&&!h){if(s.Model===a.Model){t.objSet[i].Categories.push(u[e].Categories[r]);h=false}}})});if(!p&&!h){t.objSet.push(o);p=false}}else{t.objSet.push(o)}h=false;p=false});t.getView().getModel("localJson").setProperty("/BoqItemSet",t.objSet);t.Consoliatedservices();t.ContractValueHeader();t.getView().setBusy(false);var a=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));var m=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));$.each(a,function(e,t){$.each(t.Categories,function(t,o){$.each(o.Categories,function(o,i){$.each(i.Categories,function(i,r){a[e].PriceUnit="0";a[e].Categories[t].PriceUnit="0";a[e].Categories[t].Categories[o].PriceUnit="0";a[e].Categories[t].Categories[o].Categories[i].Matdesc=a[e].Categories[t].Categories[o].ShortDesc})})})});$.each(m,function(e,o){$.each(a,function(e,i){$.each(i.Categories,function(i,r){$.each(r.Categories,function(r,s){$.each(s.Categories,function(s,n){if(o.Data===n.Data&&o.Txt===n.Txt){var l=false;$.each(t.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===n.Model){l=true}});$.each(t.myWBSSet,function(e,t){if(t.Model===n.Model){l=true}});if(l){var d=JSON.parse(JSON.stringify(parseFloat(o.PriceUnit).toFixed(t.CustomCurrency)));a[e].Categories[i].Categories[r].Categories[s].price=d;a[e].Categories[i].Categories[r].Categories[s].PriceUnit=(d*parseFloat(a[e].Categories[i].Categories[r].Categories[s].Qty)).toString();if(n.Eancat!=="C"&&n.Eancat!=="U"){a[e].PriceUnit=(parseFloat(a[e].PriceUnit)+o.PriceUnit*parseFloat(a[e].Categories[i].Categories[r].Categories[s].Qty)).toString()}if(n.Eancat!=="C"&&n.Eancat!=="U"){a[e].Categories[i].PriceUnit=(parseFloat(a[e].Categories[i].PriceUnit)+o.PriceUnit*parseFloat(a[e].Categories[i].Categories[r].Categories[s].Qty)).toString()}if(n.Eancat!=="C"&&n.Eancat!=="U"){a[e].Categories[i].Categories[r].PriceUnit=(parseFloat(a[e].Categories[i].Categories[r].PriceUnit)+o.PriceUnit*parseFloat(a[e].Categories[i].Categories[r].Categories[s].Qty)).toString()}}}})})})})});t.getView().getModel("localJson").setProperty("/BoqItemSet",JSON.parse(JSON.stringify(a)));t.addBuildingForvariation()},error:function(e){sap.m.MessageToast.show("Error")}})}}},_oMessagePopover:null,onPressMessagePopover:function(e){if(!this._oMessagePopover){this._oMessagePopover=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.MessagePopover",this);this.getView().addDependent(this._oMessagePopover)}this._oMessagePopover.toggle(e.getSource())},onWBSSelectionChange:function(e){var t=this;var o=e.getSource();var i=true,a=[],r=[];t.BUBoQs=[];t.WBSBoQs=[];t.aContexts=[];var s=t.getView().getModel("localJson").getProperty("/variationBuilding"),n=t.getView().getModel("localJson").getProperty("/selectedBuildingOrWBS"),l=this._contractDialog.getTable().getSelectedIndices();var d=t.getView().getModel("localJson").getProperty("/selectedBuilding");var g=t.getModel("localJson").getProperty("/HeadToHeadVariation");t.myWBSSet=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/myWBSSet")));if(l.length>0){for(var c=0;c<l.length;c++){var u=this._contractDialog.getTable().getContextByIndex(l[c]).getObject();u.ChangeIndicator="AddB";a.push(u)}$.each(a,function(e,t){if(t.Group===""){r.push(t.IdNumber);i=false}});$.each(t.myWBSSet,function(e,t){$.each(a,function(e,o){if(o.IdNumber===t.Boq&&t.Model===o.Model&&t.Group===o.Group){r.push(t.Boq);i=false}})});if(i){$.each(a,function(e,o){a[e].ContractualIndicator="O";a[e].Txt="Original";a[e].BuildingNo=parseInt(a[e].IdNumber).toString();$.each(g,function(t,o){if(g[t].Status==="C"){a[e].ContractualIndicator=g[t].OrderType;a[e].SrvStatus="UA";a[e].vlive="V";a[e].ModelType="WB";a[e].Txt=g[t].OrderType+"-"+g[t].UserOrder}});a[e].SrvStatus="UA";a[e].DelInd="";a[e].WbsCode=a[e].SelectionParameter;a[e].DelInd="";a[e].AsBuild2="";a[e].SubBoq=a[e].Group;a[e].BuildingNo=parseInt(a[e].IdNumber).toString();t.myWBSSet.push(a[e]);n.push(a[e]);d.push(a[e])});t.aContexts.push(a);t.getView().getModel("localJson").setProperty("/selectedBuildingOrWBS",n);t.getView().getModel("localJson").setProperty("/selectedBuilding",d);this.onWBSContractClose();this._handleValueHelpCloseWBS()}else if(!i){var p=r.join();sap.m.MessageToast.show("WBS and  Boq is already added or don't select Boq"+p)}}else{}},onSelectionChange:function(e){var t=this;var o=e.getSource();var i=true,a=[],r=[];t.BUBoQs=[];t.WBSBoQs=[];var s=t.getView().getModel("localJson").getProperty("/variationBuilding");var n=this.getView().getModel("localJson").getProperty("/BuildingSet");var l=t.getView().getModel("localJson").getProperty("/selectedBuilding"),d=this._BuildinDialog.getTable().getSelectedIndices(),g=t.getView().getModel("localJson").getProperty("/selectedBuildingOrWBS");var c=t.getModel("localJson").getProperty("/HeadToHeadVariation");t.myBuildingSet=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/myBuildingSet")));if(d.length>0){for(var u=0;u<d.length;u++){var p=this._BuildinDialog.getTable().getContextByIndex(d[u]).getObject();p.ChangeIndicator="AddB";a.push(p)}$.each(a,function(e,t){if(t.Group===""){r.push(t.BuildingNo);i=false}});$.each(t.myBuildingSet,function(e,t){$.each(a,function(e,o){if(o.BuildingNo===t.BuildingNo&&t.Model===o.Model&&t.Group===o.Group){r.push(t.BuildingNo);i=false}})});if(i){$.each(a,function(e,o){a[e].ContractualIndicator="O";a[e].Txt="Original";$.each(c,function(t,o){if(c[t].Status==="C"){a[e].ContractualIndicator=c[t].OrderType;a[e].SrvStatus="UA";a[e].AsBuild2="";a[e].OrderNo=c[t].OrderNo;a[e].Txt=c[t].OrderType+"-"+c[t].UserOrder;a[e].vlive="V"}});a[e].SubBoq=a[e].Group;a[e].SrvStatus="UA";t.myBuildingSet.push(a[e]);a[e].AsBuild2="";a[e].DelInd="";l.push(a[e]);g.push(a[e])});t.getView().getModel("localJson").setProperty("/selectedBuilding",l);t.getView().getModel("localJson").setProperty("/selectedBuildingOrWBS",g);t.aContexts.push(l);this.onBuildingContractClose();this._handleValueHelpCloseBuilding()}else if(!i){var h=r.join();sap.m.MessageToast.show("Model and  Boq is already added or don't select Boq"+h);r=[]}}},onAddPress:function(){var e=this;if(!e._selectSDialog){e._selectSDialog=sap.ui.xmlfragment(e.getView().getId(),"com.cicre.po.view.fragments.AddService",e);e.getView().addDependent(e._selectSDialog)}jQuery.sap.delayedCall(0,this,function(){e.getView().byId("idSelectBoq").setValue("");e.getView().byId("idSelectService").setValue("");e.getView().byId("idSelectSub").setSelectedKey("");e.getView().byId("idInputQty").setValue("");e.getView().byId("idInputMatGrp").setValue("");e.getView().byId("idInputMatGrpDesc").setValue("");e._selectSDialog.open()})},addServiceBoqSelectionChange:function(e){var t=this;var o=new sap.ui.model.Filter("Boq",sap.ui.model.FilterOperator.EQ,t.getView().byId("idSelectBoq").getValue());var i=t.getView().byId("idSelectSub").getBinding("items");i.filter([o])},onDisplaySearchServiceDialog:function(){var e=this;if(e._selectDialog){e._selectDialog.destroy();e._selectDialog=null}if(!e._selectDialog){e._selectDialog=sap.ui.xmlfragment(e.getView().getId(),"com.cicre.po.view.fragments.ServiceSearchDialog",e);e.getView().addDependent(e._selectDialog)}jQuery.sap.delayedCall(0,this,function(){e._selectDialog.open()});var t=new sap.m.StandardListItem({title:"{IdText}",description:"{= parseFloat(${IdNumber})}"});var o=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"SRV");o.push(i);e._selectDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:o})},onSelectServiceList:function(e){var t=this;var o=t.getView().getModel();var i=e.getParameter("selectedContexts");var a=t.getView().getModel("localJson").getProperty("/BoqItemSet");if(i&&i.length){i.map(function(e){t.sServiceCode=parseFloat(e.getObject().IdNumber);t.sServiceText=e.getObject().IdText;t.getView().byId("idSelectService").setValue(t.sServiceText)});o.callFunction("/BOQGetMatServiceAction",{method:"GET",urlParameters:{Serviceno:t.sServiceCode},success:function(e){t.matchingMaterial=e.Item;t.UnitMeas=e.UnitMeas;t.Matdesc=e.Matdesc;if(t.matchingMaterial===""){t.getView().byId("idInputMatGrp").setEnabled(true);t.getView().byId("idInputMatGrpDesc").setEnabled(true)}else{t.getView().byId("idInputMatGrp").setEnabled(false);t.getView().byId("idInputMatGrpDesc").setEnabled(false);t.getView().byId("idInputMatGrp").setValue(t.matchingMaterial);t.getView().byId("idInputMatGrpDesc").setValue(t.Matdesc)}},error:function(e){}})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},handleSearchService:function(e){var t=e.getParameter("value");var o=new sap.m.StandardListItem({title:"{IdText}",description:"{= parseFloat(${IdNumber})}"});var i=[];var a=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"SRV");var r=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);i.push(a);i.push(r);this._selectDialog.bindAggregation("items",{path:"/ValueHelpSet",template:o,filters:i})},onSaveService:function(e){var t=this;var o=[t.getView().byId("idSelectBoq"),t.getView().byId("idSelectSub"),t.getView().byId("idSelectService"),t.getView().byId("idInputQty"),t.getView().byId("idInputMatGrp"),t.getView().byId("idInputMatGrpDesc")];var i=true;jQuery.each(o,function(e,t){t.setValueState("None")});jQuery.each(o,function(e,t){if(!t.getValue()){t.setValueState("Error")}});jQuery.each(o,function(e,t){if("Error"===t.getValueState()){i=false;return}});if(!i){sap.m.MessageToast.show("Please Enter Manadatory Fields");return}else{var a={Name:t.getView().byId("idInputMatGrpDesc").getValue(),Item:t.getView().byId("idInputMatGrp").getValue(),Matdesc:t.getView().byId("idInputMatGrpDesc").getValue(),ModelType:t.getView().byId("idSelectBoq").getSelectedKey(),ChangeIndicator:"AddB",PriceUnit:"0",Categories:{DelInd:"",Boq:t.getView().byId("idSelectBoq").getValue(),LongText:"",Servicedesc:t.sServiceText,Matdesc:t.getView().byId("idInputMatGrpDesc").getValue(),Name:t.sServiceCode.toString(),PriceUnit:(1*parseFloat(t.getView().byId("idInputQty").getValue())).toString(),Serviceno:t.sServiceCode.toString(),Flag:"",UnitMeas:"",Qty:t.getView().byId("idInputQty").getValue(),ModelType:t.getView().byId("idSelectBoq").getSelectedKey(),ChangeIndicator:"AddS",Item:t.getView().byId("idInputMatGrp").getValue(),SrvNo:""}};var r=t.getView().getModel("localJson").getProperty("/BoqItemSet");var s="";var n="";var l="";var d=false;jQuery.each(r,function(e,o){if(o.Name===t.getView().byId("idSelectBoq").getValue()){s=e;jQuery.each(o.Categories,function(o,i){if(i.Name===t.getView().byId("idSelectSub").getSelectedKey()){n=o;$.each(r[e].Categories[o].Categories,function(t,i){if(i.Item===a.Item){l=t;$.each(r[e].Categories[o].Categories[t].Categories,function(e,t){if(t.Serviceno===a.Serviceno){d=true}})}})}})}});if(d)sap.m.MessageToast.show("Duplicate Service for This Boq");else{if(l===""){r[s].Categories[n].Categories.push(a);t.getView().getModel("localJson").setProperty("/BoqItemSet",r)}else{r[s].Categories[n].Categories[l].Categories.push(a.Categories);t.getView().getModel("localJson").setProperty("/BoqItemSet",r)}var g=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));$.each(g,function(e,t){if(t.Serviceno===a.Serviceno){d=true}});t._selectSDialog.close()}}},onCancelService:function(e){this._selectSDialog.close()},changeCreationType:function(){if(this.getView().byId("idCreationType").getSelectedKey()==="E"&&this.getView().getModel("localJson").getProperty("/Status")==="COMPOSING")this.getView().getModel("localJson").setProperty("/estimatedMode",true);else if(this.getView().byId("idCreationType").getSelectedKey()==="O"&&this.getView().getModel("localJson").getProperty("/Status")!=="COMPOSING")this.getView().getModel("localJson").setProperty("/estimatedMode",false);else if(this.getView().byId("idCreationType").getSelectedKey()==="O"&&this.getView().getModel("localJson").getProperty("/Status")==="COMPOSING"&&this.getView().getModel("localJson").getProperty("/EstimatedContracts").length===0)this.getView().getModel("localJson").setProperty("/estimatedMode",false);else if(this.getView().byId("idCreationType").getSelectedKey()==="O"&&this.getView().getModel("localJson").getProperty("/Status")==="COMPOSING"&&this.getView().getModel("localJson").getProperty("/EstimatedContracts").length!==0){sap.m.MessageBox.error("Estimated partition data must be deleted first!",{title:"Error"});this.getView().byId("idCreationType").setSelectedKey("E")}},handleAddEstimatedContract:function(){var e=this;var t=e.getModel("localJson").getProperty("/EstimatedContracts");var o={Servicedesc:"",Amount:"",DelInd:"",ChangeIndicator:"AddE",SrvStatus:"UA"};t.push(o);e.getModel("localJson").setProperty("/EstimatedContracts",t)},deleteEstimatedContract:function(e){var t=this;var o=[];var i=t.getModel("localJson").getProperty("/EstimatedContracts");var a=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var r=a[2];var s=i.index;i[r].DelInd="X";o.push(new sap.ui.model.Filter("DelInd",sap.ui.model.FilterOperator.NE,"X"));t.getModel("localJson").setProperty("/EstimatedContracts",i);this.byId("idEstimatedServicesTable").getBinding("rows").filter(o);t.getModel("localJson").refresh(true);this.ContractValueHeader()},onDisplaySearGroupfilterr:function(e){if(this._GroupDialogg){this._GroupDialogg.destroy();this._GroupDialogg=null}if(!this._GroupDialogg){this._GroupDialogg=sap.ui.xmlfragment("com.cicre.po.view.fragments.groupSearchDialogfilter",this);this.getView().addDependent(this._GroupDialogg)}var t=new sap.ui.model.json.JSONModel;t.setData({SupeiorWBSSet:[]});that._SuperiorWBSDialog.setModel(t,"localJson");var o=new sap.m.StandardListItem({title:"{localJson>Zzgroup}",description:"{localJson>Zzgroup}",type:"Active"});this._GroupDialogg.bindAggregation("items",{path:"localJson>/myBuildingSet",template:o,templateShareable:false});this._GroupDialogg.open()},onserviceTypeValueHelpPress:function(){if(!this._oDocTypeDialog){this._oDocTypeDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.ServiceTypeSearchDialog",this);this._oDocTypeDialog.setModel(this.getView().getModel())}this._oDocTypeDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"MSERTYPE");t.push(o);this._oDocTypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchServicetype:function(e){var t=e.getParameter("value");var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"MSERTYPE");var i=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,t);var a=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var r=[];r.push(o);r.push(i);this._oDocTypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:a,filters:r})},onSelectServicetypeList:function(e){var t=this;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){t.SERTYPE=e.getObject().IdNumber;t.SERTYPEText=e.getObject().IdText;t.getView().byId("idserviceType").setValue(e.getObject().IdText)})}else{t.SERTYPE="";t.SERTYPEText="";t.getView().byId("idserviceType").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchDocTypeDialog:function(){if(!this._oDocTypeDialog){this._oDocTypeDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.DocumentSearchDialog",this);this._oDocTypeDialog.setModel(this.getView().getModel())}this._oDocTypeDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"DocType");t.push(o);this._oDocTypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchDocument:function(e){var t=e.getParameter("value");var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"DocType");var i=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var r=[];r.push(o);r.push(i);this._oDocTypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:a,filters:r})},onSelectDocumentList:function(e){var t=this;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){t.sDocType=e.getObject().IdNumber;t.sDocTypeText=e.getObject().IdText;t.getView().byId("idDocType").setValue(e.getObject().IdText)})}else{t.sDocType="";t.sDocTypeText="";t.getView().byId("idDocType").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchVendorDialog:function(e){this.vendorInd=e.getParameters().id;if(this._oVendorDialog){this._oVendorDialog.destroy();this._oVendorDialog=null}if(!this._oVendorDialog){this._oVendorDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.VendorSearchDialog",this);this._oVendorDialog.setModel(this.getView().getModel())}this._oVendorDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var o=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Vendor");var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.vendorInd==="idSearchByVendor"?this.sSearchCoText:this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.EQ,this.vendorInd==="idSearchByVendor"?this.sSearchPOrg:this.sPOrg);o.push(i);o.push(a);o.push(r);this._oVendorDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:o})},handleSearchVendor:function(e){var t=e.getParameter("value");var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Vendor");var i=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.EQ,this.sPOrg);var s=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var n=[];n.push(o);n.push(i);n.push(a);n.push(r);this._oVendorDialog.bindAggregation("items",{path:"/ValueHelpSet",template:s,filters:n})},onSelectVendorList:function(e){var t=this;var o=t.getView().getModel();var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.sVendor=e.getObject().IdNumber;t.sVendorName=e.getObject().IdText;t.getView().byId("idVendor").setValue(e.getObject().IdText);o.callFunction("/GetCurrencyExecuteAction",{method:"GET",urlParameters:{Vendor:t.sVendor},success:function(e){console.log(e);t.getView().byId("idCurrency").setValue(e.Currency);if(e.Currency==="USD"){t.CustomCurrency=2}else{t.CustomCurrency=2}t.getView().getModel("localJson").setProperty("/Currency",e.Currency)},error:function(e){}})})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([]);t.consultantIndecator="";t.vendorInd=""},changeContractType:function(){var e=this;if(e.getView().byId("idMeasurementMethod").getSelectedKey()==="LUMP"||e.getView().byId("idMeasurementMethod").getSelectedKey()==="COST")e.getView().byId("idTolerance").setVisible(false);else e.getView().byId("idTolerance").setVisible(true);if(e.getView().byId("idMeasurementMethod").getSelectedKey()==="COST")e.getView().byId("idMarkUp").setVisible(true);else e.getView().byId("idMarkUp").setVisible(false)},_handleCancelPressContract:function(){var e=this;e._oRefContractDialog.close()},_handleValueHelpCloseContract:function(){var e=this;var t=e.selectedRefContracts.join();e.getView().byId("idRefrenceContract").setValue(t);e._oRefContractDialog.close()},onAfterClose:function(){if(this._oRefContractDialog){this._oRefContractDialog.destroy();this._oRefContractDialog=null}},onRefContSelectionChange:function(e){var t=this;var o=e.getSource();var i=true;t.selectedRefContracts=t.getView().getModel("localJson").getProperty("/selectedRefContracts");if(e.getParameters().selected===true){var a=e.getParameter("listItem").getBindingContext("poModel").getObject();$.each(t.selectedRefContracts,function(e,t){if(t===a.PurchDoc)i=false});if(i){t.selectedRefContracts.push(a.PurchDoc);t.getView().getModel("localJson").setProperty("/selectedRefContracts",t.selectedRefContracts);t.aContexts=o.getSelectedContexts(true)}else if(!i){var r=e.getSource();var s=r.getSelectedItem();s.setSelected(false);var n=e.getParameter("listItem").getBindingContextPath();var l=n.slice(n.lastIndexOf("/")+1);t.aContexts.splice(l,1);sap.m.MessageToast.show("Contract is already added!")}}else{var n=e.getParameter("listItem").getBindingContextPath();var l=n.slice(n.lastIndexOf("/")+1);t.selectedRefContracts.splice(l,1);t.aContexts.splice(l,1);t.getView().getModel("localJson").setProperty("/selectedRefContracts",t.selectedRefContracts)}},onDisplaySearchCompDialog:function(e){this.compInd=e.getParameters().id;if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.CompanySearchDialog",this);this._oDialog.setModel(this.getView().getModel())}this._oDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var o=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"CompCode");o.push(i);this._oDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:o})},handleSearchComp:function(e){var t=e.getParameter("value");var o=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var i=[];var a=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"CompCode");var r=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);i.push(a);i.push(r);this._oDialog.bindAggregation("items",{path:"/ValueHelpSet",template:o,filters:i})},onSelectCompanyList:function(e){var t=this;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){if(t.compInd==="idSearchByCompany"){t.sSearchCoCode=e.getObject().IdNumber;sap.ui.getCore().byId("idSearchByCompany").setValue(e.getObject().IdText)}else{t.sCoCode=e.getObject().IdNumber;t.sCoText=e.getObject().IdText;t.getView().byId("idCompanyCode").setValue(e.getObject().IdText);t.getView().getModel("localJson").setProperty("/CompDesc",t.sCoText)}})}else{t.sCoCode="";t.sCoText="";t.getView().getModel("localJson").setProperty("/CompDesc",t.sCoText);sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([]);this.compInd=""},onSearchCompanyChange:function(){this.sCoCode="";this.sCoText="";this.getView().getModel("localJson").setProperty("/CompDesc",this.sCoText)},onDisplaySearchPOrgDialog:function(e){this.pOrgInd=e.getParameters().id;if(!this._oPOrgDialog){this._oPOrgDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.PurchaseOrgSearchDialog",this);this._oPOrgDialog.setModel(this.getView().getModel())}this._oPOrgDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var o=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PORG");var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.Contains,this.pOrgInd==="idSearchPurchaseOrganization"?this.sSearchCoCode:this.sCoCode);o.push(i);o.push(a);this._oPOrgDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:o})},handleSearchPOrg:function(e){var t=e.getParameter("value");var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PORG");var i=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.Contains,this.sCoCode);var r=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var s=[];s.push(o);s.push(i);s.push(a);this._oPOrgDialog.bindAggregation("items",{path:"/ValueHelpSet",template:r,filters:s})},onSelectPOrgList:function(e){var t=this;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){if(t.pOrgInd==="idSearchPurchaseOrganization"){t.sSearchPOrg=e.getObject().IdNumber;sap.ui.getCore().byId("idSearchPurchaseOrganization").setValue(e.getObject().IdText)}else{t.sPOrg=e.getObject().IdNumber;t.getView().byId("idPurchaseOrganization").setValue(e.getObject().IdText)}})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([]);t.sSearchPOrg=""},onDisplaySearchPGrpDialog:function(e){this.pGrpInd=e.getParameters().id;if(!this._oPGrpDialog){this._oPGrpDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.PurchaseGrpSearchDialog",this);this._oPGrpDialog.setModel(this.getView().getModel())}this._oPGrpDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var o=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PGRP");o.push(i);this._oPGrpDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:o})},handleSearchPGrp:function(e){var t=e.getParameter("value");var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PGRP");var i=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var r=[];r.push(o);r.push(i);this._oPGrpDialog.bindAggregation("items",{path:"/ValueHelpSet",template:a,filters:r})},onSelectPGrpList:function(e){var t=this;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){if(t.pGrpInd==="idSearchPurchaseGroup"){t.sSearchPGrp=e.getObject().IdNumber;sap.ui.getCore().byId("idSearchPurchaseGroup").setValue(e.getObject().IdText)}else{t.sPGrp=e.getObject().IdNumber;t.getView().byId("idPurchaseGroup").setValue(e.getObject().IdText)}})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([]);t.pGrpInd=""},AddValueVariation:function(e){var t=this;var o;var i=t.getModel("localJson").getProperty("/HeadToHeadVariation");$.each(i,function(e,t){if(i[e].Status==="C"){o=e}});var a=0;var r=i[o];$.each(e,function(t,o){a=parseFloat(a)+parseFloat(e[t].PriceUnit)});if(t.addVAOld===""){t.addVAOld=a}if(parseFloat(a)===parseFloat(t.addVAOld)){t.addVAOld=a;var s=parseFloat(a)-parseFloat(t.addVAOld);r.ChangeInd="X"}else if(parseFloat(a)>parseFloat(t.addVAOld)){var s=parseFloat(a)-parseFloat(t.addVAOld);r.ChangeAmount=parseFloat(r.ChangeAmount)+parseFloat(s);r.ChangeInd="X";t.addVAOld=a}else{var n=parseFloat(t.addVAOld)-parseFloat(a);var s=parseFloat(a)-parseFloat(t.addVAOld);t.addVAOld=a;r.OmissionValues=parseFloat(r.OmissionValues)+parseFloat(n);r.ChangeInd="X"}t.getModel("localJson").setProperty("/HeadToHeadVariation"+o,r)},handlevariationOrder:function(){var e=this;var t=parseFloat(e.getModel("localJson").getProperty("/VariationOrderPre"));var o=e.getModel("localJso").getProperty("/variationOrderContract");if(t===0){sap.m.MessageToast.show(e.getView().getModel("i18n").getResourceBundle().getText("Please_add_the_original_percentage_from_contract_terms_applaction"))}else{if(o.length>=1){e.getView().getModel("localJson").setProperty("/VariationMode",false)}else{var i=0;var a=e.getView().getModel("localJson").getProperty("/BoqItemSet");$.each(a,function(e,t){i=parseFloat(i)+parseFloat(a[e].PriceUnit)});var r=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var s={UserOrder:"",OrderDesc:"",Type:"",OrderDate:r.format(new Date),MonthIndex:"",AddValues:"0.00",OmissionValues:"0.00",ChangeAmount:"0.00",DaysNo:"",MonthNo:"",Action:"",Status:"C",OrderType:"V",OrderNo:"",VarStatus:""};var n=e.getModel("localJson").getProperty("/HeadToHeadVariation");e.getView().getModel("localJso").setProperty("/VariationMode",false);n.push(s);e.getModel("localJson").setProperty("/HeadToHeadVariation",n)}}},onReleaseVeriation:function(e){var t=this.getView().byId("VariationOrderTable").getModel("localJson");var o=e.getSource().getBindingContext("localJson").getPath();var i=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var a=this.getView().getModel("localJson");var r=a.getProperty(o);r.Txt=r.OrderType+"-"+r.UserOrder;r.Action="R";r.Status="R";a.setProperty(o,r)},loaddatevariation:function(e){var t=this;var o=this.getView().byId("VariationOrderTable").getModel("localJson");var i=e.getSource().getBindingContext("localJson").getPath();var a=this.getView().getModel("localJson");var r=a.getProperty(i);r.OrderDate=e.getParameter("value");a.setProperty(i,r);o.refresh(true)},handleChange:function(e){var t=this;var o=this.getView().byId("VariationOrderTable").getModel("localJson");var i=e.getSource();var a=i.getSelectedKey();var r=e.getSource().getBindingContext("localJson").getPath();var s=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var n=parseInt(s[2]);var l=o.getProperty("/HeadToHeadVariation/"+n);var d=this.getView().getModel("localJson");var g=d.getProperty(r);g.Txt=g.OrderType+"-"+g.UserOrder;if(a=="R"){g.Status="R";g.Action=a;d.setProperty(r,g);t.changestatus(l)}else{g.Status="C";g.Action=a;o.setProperty(r,g)}o.refresh(true)},onCancleVeriation:function(e){var t=this.getView().byId("VariationOrderTable").getModel("localJson");var o=e.getSource().getBindingContext("localJson").getPath();var i=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var a=this.getView().getModel("localJson");var r=a.getProperty(o);r.Action="C";r.Status="C";a.setProperty(o,r);this.getResourceBundle()},handleChangeOrderType:function(e){var t=e.getSource();var o=t.getSelectedKey();var i=this.getView().byId("VariationOrderTable").getModel("localJson");var a=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var r=parseInt(a[2]);var s=i.getProperty("/HeadToHeadVariation/"+r);s.ChangeInd="X";s.Type=o;i.setProperty("/HeadToHeadVariation/"+r,s);i.refresh(true)},onPressVariationOrder:function(e){var t=e.getSource().getBindingContext("localJson").getPath();this._BuildingItemsPath=e.getSource().getParent().getParent().getBinding("rows").getPath();if(!this._oBuilding){var o=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.variationOrder",this);this._oBuilding=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.variationOrderTable",this);this.getView().addDependent(this._oBuilding);this._buildingBinding=t+"/OrderItemsSet";this.getView().byId("idBuildings").bindItems({path:"localJson>"+this._buildingBinding,template:o,templateShareable:true})}this._oBuilding.open()},handleCloseVariation:function(e){this._oBuilding.close();this._oBuilding.destroy();this._oBuilding=null},onPressAddendumOrder:function(e){var t=e.getSource().getBindingContext("localJson").getPath();this._BuildingItemsPath=e.getSource().getParent().getParent().getBinding("rows").getPath();if(!this.AddendumOrder){var o=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.variationOrder",this);this.AddendumOrder=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.AddendumOrderTable",this);this.getView().addDependent(this.AddendumOrder);this._buildingBinding=t+"/OrderItemsSet";this.getView().byId("idBuildingss").bindItems({path:"localJson>"+this._buildingBinding,template:o,templateShareable:true})}this.AddendumOrder.open()},handleCloseAddendum:function(e){this.AddendumOrder.close();this.AddendumOrder.destroy();this.AddendumOrder=null},onPressVariationOrdersrv:function(e){var t=e.getSource().getBindingContext("localJson").getPath();this._BuildingItemsPath=e.getSource().getParent().getParent().getBinding("rows").getPath();if(!this._oServiceD){var o=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.variationOrdersrv",this);this._oServiceD=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.variationOrderTablesrv",this);this.getView().addDependent(this._oServiceD);this._buildingsrv=t+"/OrderItemsSrvSet";this.getView().byId("idsrvDelete").bindItems({path:"localJson>"+this._buildingsrv,template:o,templateShareable:true})}this._oServiceD.open()},handleCloseVariationsrv:function(e){this._oServiceD.close();this._oServiceD.destroy();this._oServiceD=null},handleSelectionChangeV:function(e){var t=e.getParameter("changedItem");var o=e.getParameter("selected")},objectformatdate:function(e){var t=e.substring(6,10);var o=e.substring(3,5);var i=e.substring(0,2);return new Date(t,o-1,i)},formatDate:function(e){var t=new Date(e),o=""+(t.getMonth()+1),i=""+t.getDate(),a=t.getFullYear();if(o.length<2)o="0"+o;if(i.length<2)i="0"+i;return[a,o,i].join("-")},handleSelectionFinish:function(e){var t=e.getParameter("selectedItems");var o="";for(var i=0;i<t.length;i++){o+=t[i].getKey();if(i!=t.length-1){o+=","}}var a=e.getSource().getBindingContext("localJson").getPath();var r=this.getView().getModel("localJson");var s=r.getProperty(a);s.MonthIndex=o;r.setProperty(a,s)},handelValuseUserOrder:function(e){var t=this.getModel("localJson").getProperty("/HeadToHeadVariation");var o=this.getView().byId("VariationOrderTable").getModel("localJson");var i=e.getSource().getBindingContext("localJson").getPath();var a=this.getView().getModel("localJson");var r=a.getProperty(i);$.each(t,function(e,t){if(r.UserOrder===t.UserOrder&&t.OrderNo!==""&&r.OrderType===t.OrderType){r.UserOrder=""}});a.setProperty(i,r)},handdAdendum:function(){var e=this;var t=e.getModel("localJso").getProperty("/variationOrderContract");if(t.length>=1){e.getView().getModel("localJson").setProperty("/VariationMode",false)}else{var o=0;var i=e.getView().getModel("localJson").getProperty("/BoqItemSet");$.each(i,function(e,t){o=parseFloat(o)+parseFloat(i[e].PriceUnit)});var a=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});var r={UserOrder:"",OrderDesc:"",Type:"",OrderDate:a.format(new Date),MonthIndex:"",AddValues:"0.00",OmissionValues:"0.00",ChangeAmount:"0.00",DaysNo:"",MonthNo:"",Action:"",Status:"C",OrderType:"A",OrderNo:"",VarStatus:""};var s=e.getModel("localJson").getProperty("/HeadToHeadVariation");e.getView().getModel("localJso").setProperty("/VariationMode",false);s.push(r);e.getModel("localJson").setProperty("/HeadToHeadVariation",s)}},loaddateAddendum:function(e){var t=this;var o=this.getView().byId("AddendumTable").getModel("localJson");var i=e.getSource().getBindingContext("localJson").getPath();var a=this.getView().getModel("localJson");var r=a.getProperty(i);r.OrderDate=e.getParameter("value");a.setProperty(i,r)},handleChangeA:function(e){var t=this;var o=this.getView().byId("AddendumTable").getModel("localJson");var i=e.getSource();var a=i.getSelectedKey();var r=e.getSource().getBindingContext("localJson").getPath();var s=this.getView().getModel("localJson");var n=s.getProperty(r);if(a=="R"){n.Status="R";n.Action=a;s.setProperty(r,n)}else{n.Status="C";n.Action=a;o.setProperty(r,n)}},handleChangeOrderTypeA:function(e){var t=e.getSource();var o=t.getSelectedKey();var i=this.getView().byId("AddendumTable").getModel("localJson");var a=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var r=parseInt(a[2]);var s=i.getProperty("/HeadToHeadVariation/"+r);s.Type=o;s.ChangeInd="X";i.setProperty("/HeadToHeadVariation/"+r,s);i.refresh(true)},onPressVariationOrder:function(e){var t=e.getSource().getBindingContext("localJson").getPath();this._BuildingItemsPath=e.getSource().getParent().getParent().getBinding("rows").getPath();if(!this._oBuilding){var o=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.variationOrder",this);this._oBuilding=sap.ui.xmlfragment(this.getView().getId(),"com.cicre.po.view.fragments.variationOrderTable",this);this.getView().addDependent(this._oBuilding);this._buildingBinding=t+"/OrderItemsSet";this.getView().byId("idBuildings").bindItems({path:"localJson>"+this._buildingBinding,template:o,templateShareable:true})}this._oBuilding.open()},handleCloseVariation:function(e){this._oBuilding.close();this._oBuilding.destroy();this._oBuilding=null},handleSelectionChange:function(e){var t=e.getParameter("changedItem");var o=e.getParameter("selected")},handleSelectionFinishA:function(e){var t=e.getParameter("selectedItems");var o="";for(var i=0;i<t.length;i++){o+=t[i].getKey();if(i!=t.length-1){o+=","}}var a=e.getSource().getBindingContext("localJson").getPath();var r=this.getView().getModel("localJson");var s=r.getProperty(a);s.MonthIndex=o;r.setProperty(a,s);r.refresh(true)},deleteEstimatedContrac:function(e){var t=this;var o=t.getModel("localJson").getProperty("/variationOrderContract");var i=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var a=i[2];o.splice(a,1);t.getModel("localJson").setProperty("/variationOrderContract",o);t.getModel("localJson").refresh(true)},_longTextDialogBuilding:null,onPressLongTextBuildingBoq:function(e){var t=this;t.itemIndex=e.getSource().getBindingContext("localJson").getPath();var o=e.getSource().getBindingContext("localJson").getObject();if(!t._longTextDialogBuilding){t._longTextDialogBuilding=sap.ui.xmlfragment(t.getView().getId(),"com.cicre.po.view.fragments.ServiceLongText",t);t.getView().addDependent(t._longTextDialogBuilding)}t._longTextDialogBuilding.open();t.getView().byId("idLongText").setText(o.BoqDesc)},_longTextDialogBuildingModel:null,onPressLongTextBuildingModel:function(e){var t=this;t.itemIndex=e.getSource().getBindingContext("localJson").getPath();var o=e.getSource().getBindingContext("localJson").getObject();if(!t._longTextDialogBuildingModel){t._longTextDialogBuildingModel=sap.ui.xmlfragment(t.getView().getId(),"com.cicre.po.view.fragments.ServiceLongText",t);t.getView().addDependent(t._longTextDialogBuildingModel)}t._longTextDialogBuildingModel.open();t.getView().byId("idLongText").setText(o.ModelDesc)},onSelectionChangeFilter:function(e){var t=this;var o=e.getSource();var i=true;var a=t.getView().getModel("localJso").getProperty("/Buildings");if(e.getParameters().selected===true){var r=e.getParameter("listItem").getBindingContext("localJson").getObject();i=true;if(i){a.push(r);t.getView().getModel("localJso").setProperty("/Buildings",a);t.aContexts=o.getSelectedContexts(true)}}else{var s=e.getParameter("listItem").getBindingContextPath();var n=s.slice(s.lastIndexOf("/")+1);a.splice(n,1);t.aContexts.splice(n,1);t.getView().getModel("localJso").setProperty("/Buildings",a)}},CancelPressF:function(){this._oBuildingValueHelpDialog.close();this._oBuildingValueHelpDialog.destroy();this._oBuildingValueHelpDialog=null},onZoomIn:function(e){this.getView().byId("idDisplayProcessFlow").zoomIn()},onZoomOut:function(){this.getView().byId("idDisplayProcessFlow").zoomOut()},onChangeWFContractType:function(e){this._readWFInbox(this.getView().byId("idselectionType").getSelectedKey())},_readWFInbox:function(e){var t=this,o=[],i="",a="",r="";if(e!=="O"){i=e.split("-");a=i[0];r=i[1]}else{a=e}var s=new sap.ui.model.Filter("ReqId","EQ",t.getView().getModel("localJson").getProperty("/PoNumber"));o.push(s);s=new sap.ui.model.Filter("Workitem","EQ",a);o.push(s);s=new sap.ui.model.Filter("ContIntNo","EQ",r);o.push(s);t.getView().setBusy(true);t.getOwnerComponent().getModel().read("/WFContractInboxSet",{async:false,method:"GET",filters:o,success:function(e){if(e.results.length>0){var o=e.results;var i=t.onprocessworkflowBuilding(o);t.getView().getModel("localJson").setProperty("/lanes",i.lanes);t.getView().getModel("localJson").setProperty("/nodes",i.nodes);t.getView().getModel("localJson").refresh();t.getView().setBusy(false)}},error:function(){}})},_readWFType:function(){var e=this,t=[],o=new sap.ui.model.Filter("Flag","EQ","X");t.push(o);o=new sap.ui.model.Filter("ReqId","EQ",e.getView().getModel("localJson").getProperty("/PoNumber"));t.push(o);e.getOwnerComponent().getModel().read("/WFContractInboxSet",{async:false,method:"GET",filters:t,success:function(t){if(t.results.length>0){var o=t.results;e.getView().getModel("localJson").setProperty("/Action_TYPE",o)}},error:function(){}})},onprocessworkflowBuilding:function(e){var t=this;var o=t.getView().getModel("dataModel");$.each(e,function(t,o){e[t].Step=parseInt(o.StepNo).toString()});var i=e.filter(function(e,t,o){return t===0||e.Step!==o[t-1].Step});var a=[{laneId:"0",iconSrc:"sap-icon://activate",text:t.getResourceBundle().getText("detailInitiator"),position:0}];var r=[{nodeId:"0",laneId:"0",title:t.initiator,titleAbbreviation:t.initiator,children:[],state:sap.suite.ui.commons.ProcessFlowNodeState.Positive,stateText:t.getResourceBundle().getText("detailRequestReleased"),highlighted:true}];var s=e.filter(function(e){return e.Step=="1"});for(var n=0;n<s.length;n++){r[0].children.push(s[n].UserName+s[n].Workitem)}for(var l in i){a.push({laneId:i[l].Step,iconSrc:"sap-icon://monitor-payments",text:i[l].Role,position:parseInt(i[l].Step)})}for(var n in e){e[n].DecisionDate=e[n].DecisionDate===null?"":e[n].DecisionDate;r.push({nodeId:e[n].UserName+e[n].Workitem,laneId:e[n].Step,title:e[n].UserName,titleAbbreviation:e[n].UserName,children:[],role:e[n].Role,state:e[n].UserName==e[n].DecisionBy&&e[n].Status=="APPROVED"?sap.suite.ui.commons.ProcessFlowNodeState.Positive:e[n].UserName==e[n].DecisionBy&&e[n].Status=="REJECTED"?sap.suite.ui.commons.ProcessFlowNodeState.Negative:sap.suite.ui.commons.ProcessFlowNodeState.Neutral,stateText:e[n].Role=="WAT"?"Watcher":e[n].Status=="STA"?"Active":e[n].Status=="APPROVED"?"Approved by-"+e[n].DecisionBy:e[n].Status=="REJECTED"?"Rejected by-"+e[n].DecisionBy:"Pending",highlighted:e[n].UserName==e[n].DecisionBy&&e[n].Status=="APPROVED"?true:e[n].UserName==e[n].DecisionBy&&e[n].Status=="REJECTED"?true:false,texts:[t.formatDatew(e[n].DecisionDate),e[n].Comments,e[n].Status]});var s=e.filter(function(t){return t.Step==(parseInt(e[n].Step)+1).toString()});for(var d=0;d<s.length;d++){var g=s[d].UserName+s[d].Workitem;if(r[r.length-1].nodeId!==g){r[r.length-1].children.push(g)}}}return{nodes:r,lanes:a}},onNodePress:function(e){var t=this;var o=e.getParameters().getBindingContext("localJson").getObject();if(o.laneId!="0"){if(t._processFlowDialog){t._processFlowDialog.destroy();t._processFlowDialog=null}if(!t._processFlowDialog){t._processFlowDialog=sap.ui.xmlfragment(t.getView().getId(),"com.cicre.po.view.fragments.ProcessFlowDialog",t);t._processFlowDialog.setBindingContext(e.getParameters().getBindingContext("localJson"),"localJson");t.getView().addDependent(t._processFlowDialog)}t._processFlowDialog.open()}},onCloseProcessFlow:function(e){this._processFlowDialog.close()},onChangeContractDuration:function(){var e=this.getView().byId("idContractDurationMonth").getValue(),t=this.getView().byId("idContractDurationDays").getValue(),o=this.getView().getModel("localJson").getProperty("/TotalvariationMonths"),i=this.getView().getModel("localJson").getProperty("/TotalvariationDays"),a=0,r=0,s=this.getView().getModel("localJson").getProperty("/ValidFrom");a=parseInt(e)+parseInt(o);r=parseInt(t)+parseInt(i);this.getView().getModel("localJson").setProperty("/TotalContractDurationMonths",a);this.getView().getModel("localJson").setProperty("/TotalContractDurationDays",r);var n=this.calculateDates(s,a,r);this.getView().getModel("localJson").setProperty("/ValidTo",n)},getStartDate:function(e,t,o){if(e>t){if(e>o){return e}else{return o}}else{if(t>o){return t}else{return o}}},calculatestartDate:function(){var e=this.getView().getModel("localJson").getProperty("/SigninDate"),t=this.getView().getModel("localJson").getProperty("/CommencementDate"),o=this.getView().getModel("localJson").getProperty("/DateOfApplying"),i=this.getView().getModel("localJson").getProperty("/TotalContractDurationMonths"),a=this.getView().getModel("localJson").getProperty("/TotalContractDurationDays");var r=this.getStartDate(t,o,e);this.getView().getModel("localJson").setProperty("/ValidFrom",r);var s=this.calculateDates(r,i,a);this.getView().getModel("localJson").setProperty("/ValidTo",s)},oncalculatVariationOrder:function(e){var t=this.getView().getModel("localJson").getProperty("/HeadToHeadVariation");var o=0;var i=0,a=this.getView().getModel("localJson").getProperty("/ContDurationMonth"),r=this.getView().getModel("localJson").getProperty("/ContDurationDays"),s=0,n=0;var l=e.getSource().getBindingContext("localJson").getPath();var d=this.getView().getModel("localJson");var g=d.getProperty(l);g.ChangeInd="X";d.setProperty(l,g);$.each(t,function(e,t){if(t.MonthNo===""){t.MonthNo=0}if(t.DaysNo===""){t.DaysNo=0}o=parseInt(o)+parseInt(t.MonthNo);i=parseInt(i)+parseInt(t.DaysNo)});this.getView().getModel("localJson").setProperty("/TotalvariationMonths",o);this.getView().getModel("localJson").setProperty("/TotalvariationDays",i);this.onChangeContractDuration()},onChangeind:function(e){var t=e.getSource().getBindingContext("localJson").getPath();var o=this.getView().getModel("localJson");var i=o.getProperty(t);i.ChangeInd="X";o.setProperty(t,i)},formatDatew:function(e){if(e==null){return""}else{jQuery.sap.require("sap.ui.core.format.DateFormat");var t=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});return t.format(new Date(e))}},onPRSelectionChange:function(e){var t=this;var o=true,i=[],a=[];var r=t.getView().getModel("localJson").getProperty("/selectedPR");var s=t.getView().getModel("localJson").getProperty("/myPurchaseRequisition"),n=t.getView().getModel("localJson").getProperty("/HeadToHeadVariation"),l=this._contractDialogPR.getTable().getSelectedIndices();t.myWBSSet=t.getView().getModel("localJson").getProperty("/myWBSSet");if(l.length>0){for(var d=0;d<l.length;d++){var g=this._contractDialogPR.getTable().getContextByIndex(l[d]).getObject();g.ChangeIndicator="AddB";i.push(g)}$.each(s,function(e,t){$.each(i,function(e,i){if(i.BuildingNo===t.BuildingNo){a.push(t.BuildingNo);o=false}})});if(o){$.each(i,function(e,t){i[e].ContractualIndicator="O";i[e].Txt="Original";$.each(n,function(t,o){if(n[t].Status==="C"){i[e].ContractualIndicator=n[t].OrderType;i[e].SrvStatus="UA";i[e].AsBuild2="";i[e].OrderNo=n[t].OrderNo;i[e].Txt=n[t].OrderType+"-"+n[t].UserOrder;i[e].vlive="V"}});i[e].SrvStatus="UA";i[e].DelInd="";i[e].AsBuild2="";i[e].ModelType="PR";i[e].ActivityNumber=i[e].ActivityNumber;i[e].Network=i[e].Network;i[e].PrNo=parseInt(i[e].PrNo).toString();i[e].PrNumber=parseInt(i[e].PrNo).toString();i[e].BuildingNo=parseInt(i[e].PrNo).toString();i[e].Model=parseInt(i[e].PrNo).toString();i[e].BoqDesc=i[e].ActivityNumberDesc;r.push(i[e]);s.push(i[e])});t.aContexts.push(i);t.getView().getModel("localJson").setProperty("/myPurchaseRequisition",s);t.getView().getModel("localJson").setProperty("/selectedPR",r);t.onPRContractClose();t._handleValueHelpOpjectClosePR()}else if(!o){var c=a.join();sap.m.MessageToast.show("Purchase Requisition is already added or don't select Boq "+c)}}},_handleValueHelpOpjectClosePR:function(e){var t=this,o=t.getView().getModel();t.getView().setBusy(true);var i=t.getView().getModel(),a={},r=t.getView().getModel("localJson").getProperty("/myPurchaseRequisition"),s=t.getView().getModel("localJson").getProperty("/HeadToHeadVariation"),n=[];var l=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/PRItemSet")));if(t.aContexts.length===0)sap.m.MessageToast.show("Select one Building at least!");else{t.BUBoQs.sort();this.objSet=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));this.selectedBuilding=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/selectedBuilding")));var d="0.00";var g=t.getView().getModel("localJson").getProperty("/selectedPR");$.each(g,function(e,t){var o=new sap.ui.model.Filter("PrNumber",sap.ui.model.FilterOperator.EQ,t.PrNo);if(o!==""){n.push(o)}});var c=new sap.ui.model.Filter("Eancat",sap.ui.model.FilterOperator.EQ,"PR");if(c!==""){n.push(c)}this.objSet=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/PRItemSet")));t.getView().getModel("localJson").setProperty("/selectedPR",[]);o.read("/BoqTreeSet",{filters:n,success:function(e,o){e=e.results;var i=1;var n=[];var l="O";var g="";var c="UA";var u="";$.each(s,function(e,t){if(s[e].Status==="C"){l=s[e].OrderType;g=s[e].OrderNo;u=s[e].UserOrder}});if(l==="O"){var p="Original"}else{var p=l+"-"+u}$.each(e,function(t,o){if(e[t].LevelNo==="1"){e[t].AddNew="AN";e[t].live="one"}e[t].ModelType="BOQ";if(e[t].Eancat===""&&parseInt(e[t].LevelNo)===3){e[t].Qty="0";e[t].Uom="";e[t].Price="0"}if(e[t].Eancat==="U"){e[t].Qty=0}if(parseInt(e[t].LevelNo)===3){e[t].Txt=p;e[t].SrvStatus=c;if(e[t].Eancat!=""){e[t].PriceUnit="1";e[t].Price="1"}e[t].DelInd="";e[t].ModelBoq=[];a={ModelType:"PR",Model:e[t].Data,SubModel:"",Buildingno:e[t].Data};e[t].ModelBoq.push(a);e[t].VariationOrder=g;e[t].ChangeIndicator="addB";e[t].ContractualIndicator=l;e[t].Indicator="Y";d=parseFloat(d)+parseFloat(e[t].Qty)*parseFloat(e[t].Price)}else{e[t].Indicator="Z"}});for(i;i<e.length+1;i++){n.push({[i]:[]});for(var h=0;h<e.length;h++){e[h].Categories=[];if(parseInt(e[h].LevelNo)===i){n[i-1][i].push(e[h])}}}var m=[];$.each(n,function(e,t){if(e<3){$.each(t,function(t,o){if(o.length!==0){$.each(o,function(t,o){$.each(n[e+1],function(e,t){$.each(t,function(e,t){if(t.length!==0){if(o.LevelId===t.Parent){o.Categories.push(t)}}})})})}})}});$.each(n[0],function(e,t){if(t.length!==0){$.each(t,function(e,t){m.push(t)})}});var S=false;var f=false;$.each(m,function(e,o){S=false;if(t.objSet.length!==0){$.each(t.objSet,function(i,a){$.each(o.Categories,function(r,s){$.each(a.Categories,function(e,t){if(o.Data===a.Data){S=true;if(s.Data===t.Data){f=true}}});if(S&&!f){if(s.Model===a.Model){t.objSet[i].Categories.push(m[e].Categories[r]);f=false}}})});if(!S&&!f){t.objSet.push(o);S=false}}else{t.objSet.push(o)}f=false;S=false});t.getView().getModel("localJson").setProperty("/PRItemSet",t.objSet);t.Consoliatedservices();var v=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/PRItemSet")));var y=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));$.each(v,function(e,t){$.each(t.Categories,function(e,o){$.each(o.Categories,function(e,i){t.PriceUnit="0";o.PriceUnit="0";i.PriceUnit="0"})})});$.each(y,function(e,o){$.each(v,function(e,i){$.each(i.Categories,function(e,a){$.each(a.Categories,function(e,s){if(o.Data===s.Data&&o.Txt===s.Txt){$.each(r,function(e,r){if(r.PrNo==i.PrNumber){var n=JSON.parse(JSON.stringify(parseFloat(o.PriceUnit).toFixed(t.CustomCurrency)));s.price=n;s.PriceUnit=(n*parseFloat(s.Qty)).toString();s.Qty=parseFloat(s.Qty).toString();if(s.Eancat!=="C"&&s.Eancat!=="U"){i.PriceUnit=(parseFloat(i.PriceUnit)+n*parseFloat(s.Qty)).toString()}if(s.Eancat!=="C"&&s.Eancat!=="U"){a.PriceUnit=(parseFloat(a.PriceUnit)+n*parseFloat(s.Qty)).toString()}}})}})})})});t.getView().getModel("localJson").setProperty("/PRItemSet",JSON.parse(JSON.stringify(v)));t.ContractValueHeader();t.addBuildingForvariation()},error:function(e){sap.m.MessageToast.show("Error")}})}},onChangeNote:function(){var e=this.getView().getModel("localJson").getProperty("/ContractPONoteSet");e.Flag="X";this.getView().getModel("localJson").setProperty("/ContractPONoteSet",e)},onPressContractTermsTile:function(e){var t=sap.ushell.Container.getService("CrossApplicationNavigation"),o=this.getView().getModel("localJson").getProperty("/ContractTermsInd"),i=this.getView().getModel("localJson").getProperty("/Version"),a=this.getView().getModel("localJson").getProperty("/PurchDoc"),r="";var s=t&&t.hrefForExternal({target:{semanticObject:"ZSESMISem",action:"display"}})||"";if(o==="X"){r="&/displayTerms/"+a+"/"+i}else{r="&/createTerms/"+a+"/0"}var n=window.location.href.split("#")[0]+s+r;window.open(n,"_blank")}})});
//# sourceMappingURL=Object.controller.js.map