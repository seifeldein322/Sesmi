jQuery.sap.require("sap.m.MessageBox");sap.ui.define(["com/cicre/po/controller/BaseController","com/cicre/po/model/formatter"],function(e,t){"use strict";return e.extend("com.cicre.po.controller.CreateContract",{formatter:t,sCoCode:"",sCoText:"",sSearchCoText:"",sPONO:"",sVendor:"",sProj:"",sProjectCode:"",sPOrg:"",sPlant:"",sPGrp:"",sDocType:"",sDocTypeText:"",BUBoQs:[],WBSBoQs:[],Boqs:[],myBuildingSet:[],myWBSSet:[],aContexts:[],sSubBoq:"",sSubBoqId:"",sSubBoq2:"",sSubBoq2Id:"",_oBuildingDialog:null,_oWBSDialog:null,consultantIndecator:"",sConsultant:"",sConsultantName:"",compInd:"",vendorInd:"",pGrpInd:"",pOrgInd:"",sSearchCoCode:"",sSearchVendor:"",sSearchPGrp:"",sSearchPOrg:"",selectedRefContracts:[],sVendorName:"",GroupCode:"",ModelCode:"",SupeiorWBSCode:"",SupeiorWBSText:"",ODataTree:[],BoqDescR:"",Building:"",ContractCode:"",GroupCodefilter:"",ModelCodefilter:"",ZoneCodefilter:"",BuildingCodefilter:"",ModelCodeFilter:"",ViewCon:"",companycodeTxt:"",SERTYPE:"",SERTYPEText:"",BoqAll:"",BoqDescAll:"",currentYear:"",ccurrentYear:"",years:"",CustomCurrency:"",onInit:function(){var e=this.getRouter();e.getRoute("createContract").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){var t=this;t.sCoCode="1000";t.sCoText="EDSCO",t.getView().byId("idCompanyCode").setValue(t.sCoText);t.sPOrg="1000";t.getView().byId("idPurchaseOrganization").setValue("TMG CENTRAL Purch.");t.sPGrp="SRV";t.getView().byId("idPurchaseGroup").setValue("Service");t.sPlant="",t.getView().byId("idPlant").setValue("ARAB Company For Proj & Dev");t.CustomCurrency=2;t.sDocType="ZSES";t.sProjectCode="";t.getView().byId("_idSearchByProject").setValue("");t.getView().byId("_idSdocumenttype").setValue("");t.getView().byId("idCreationType").setSelectedKey("O");t.getView().byId("idContractDescription").setValue("");t.getView().byId("idLongDescription").setValue("");t.getView().byId("idCurrency").setValue("");t.getView().byId("idMeasurementMethod").setSelectedKey("REMS");t.getView().byId("idConstructionType").setSelectedKey("T");t.getView().byId("idRefrenceContract").setValue("");t.getView().byId("idDocumentDate").setValue("");t.getView().byId("idValidFromDate").setValue("");t.getView().byId("idValidToDate").setValue("");t.getView().byId("idDeliveryDate").setValue("");t.getView().byId("idRevisedValidToDate").setValue("");t.getView().byId("idIndexMonth").setSelectedKeys("");t.getView().byId("idResponsiblepersonSS").setSelectedKey("");t.getView().byId("idResponsiblepersonIR").setSelectedKey("");t.getView().byId("idSupeiorWBS").setValue("");t.getView().byId("idVendor").setValue("");t.getView().byId("idConsultant").setValue("");t.getView().byId("idTolerance").setValue("");t.getView().byId("idTolerance").setVisible(false);t.getView().byId("idMarkUp").setVisible(false);var i=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:"yyyy-MM-dd"});t.getView().byId("idDocumentDate").setValue(i.format(new Date));t.IndexMonth();var o=new sap.ui.model.json.JSONModel;var a=[{id:"01",text:"Jan"},{id:"02",text:"Feb"},{id:"03",text:"Mar"},{id:"04",text:"Apr"},{id:"05",text:"May"},{id:"06",text:"Jun"},{id:"07",text:"Jul"},{id:"08",text:"Aug"},{id:"09",text:"Sep"},{id:"10",text:"Oct"},{id:"11",text:"Nov"},{id:"12",text:"Dec"}];var r=[{id:"C",text:"Contingency"},{id:"U",text:"Unit rate"},{id:"L",text:"lumpsum"},{id:"P",text:"Provisional Sum"},{id:"R",text:"Remeasured"}];o.setData({estimatedMode:false,BuildingSet:[],WBSSet:[],BoqModelSet:[],BoqItemSet:[],BoqMatGrpSet:[],myBuildingSet:[],AttachmentSet:[],myWBSSet:[],MessageSet:[],MessagesLength:[],selectedBuilding:[],IndexMonths:this.years,Service_TYPE:r,selectedRefContracts:[],EstimatedContracts:[],SupeiorWBSSet:[],selectedBuildingOrWBS:[],BoqConsulidatedItemSet:[],myBuildingSet:[],HeadToHeadVariation:[],AsbuildService:[],EstimatedContractValue:"0.00",OriginalContractValue:"0.00",VariationOrderValue:"0.00",AddendumValue:"0.00",TotalContractValue:"0.00",RevisedContractValue:"0.00",BuildingNO:"0.00",WbslistNo:"0:00",ServicNOCount:"0.00",projectText:"",selectBoq:false,selectGroupBoq:false,myPurchaseRequisition:[],selectedPR:[],PRItemSet:[]});t.getView().setModel(o,"localJson");var s=new sap.ui.model.json.JSONModel;s.setData({VariationMode:true,ViewCon1:false,ViewCon2:true,ViewCon4:false,ViewCon3:true,VReleasedMode:"",Buildings:[],Buildingss:[]});t.getView().setModel(s,"localJso")},onDisplaySearchCompDialog:function(e){this.compInd=e.getParameters().id;if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.CompanySearchDialog",this);this._oDialog.setModel(this.getView().getModel())}this._oDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var i=[];var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"CompCode");i.push(o);this._oDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:i})},handleSearchComp:function(e){var t=e.getParameter("value");var i=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var o=[];var a=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"CompCode");var r=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);o.push(a);o.push(r);this._oDialog.bindAggregation("items",{path:"/ValueHelpSet",template:i,filters:o})},onSelectCompanyList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){if(t.compInd==="idSearchByCompany"){t.sSearchCoCode=e.getObject().IdNumber;sap.ui.getCore().byId("idSearchByCompany").setValue(e.getObject().IdText)}else{t.sCoCode=e.getObject().IdNumber;t.sCoText=e.getObject().IdText;t.getView().byId("idCompanyCode").setValue(e.getObject().IdText);t.getView().getModel("localJson").setProperty("/projectText",t.sCoText)}})}else{t.sCoCode="";t.sCoText="";t.getView().getModel("localJson").setProperty("/projectText",t.sCoText);sap.m.MessageToast.show("No new item was selected.");t.getView().byId("idCompanyCode").setValue("")}e.getSource().getBinding("items").filter([]);this.compInd=""},onSearchCompanyChange:function(){this.sCoCode="";this.sCoText="";this.getView().getModel("localJson").setProperty("/projectText",this.sCoText)},onserviceTypeValueHelpPress:function(){if(!this._oDocTypeDialog){this._oDocTypeDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.ServiceTypeSearchDialog",this);this._oDocTypeDialog.setModel(this.getView().getModel())}this._oDocTypeDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"MSERTYPE");t.push(i);this._oDocTypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchServicetype:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"MSERTYPE");var o=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,t);var a=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var r=[];r.push(i);r.push(o);this._oDocTypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:a,filters:r})},onSelectServicetypeList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.SERTYPE=e.getObject().IdNumber;t.SERTYPEText=e.getObject().IdText;t.getView().byId("idserviceType").setValue(e.getObject().IdText)})}else{t.SERTYPE="";t.SERTYPEText="";t.getView().byId("idserviceType").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchDocTypeDialog:function(){if(!this._oDocTypeDialog){this._oDocTypeDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.DocumentSearchDialog",this);this._oDocTypeDialog.setModel(this.getView().getModel())}this._oDocTypeDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"DocType");t.push(i);this._oDocTypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchDocument:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"DocType");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var r=[];r.push(i);r.push(o);this._oDocTypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:a,filters:r})},onSelectDocumentList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.sDocType=e.getObject().IdNumber;t.sDocTypeText=e.getObject().IdText;t.getView().byId("idDocType").setValue(e.getObject().IdText)})}else{t.sDocType="";t.sDocTypeText="";t.getView().byId("idDocType").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchVendorDialog:function(e){this.vendorInd=e.getParameters().id;if(this._oVendorDialog){this._oVendorDialog.destroy();this._oVendorDialog=null}if(!this._oVendorDialog){this._oVendorDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.VendorSearchDialog",this);this._oVendorDialog.setModel(this.getView().getModel())}this._oVendorDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var i=[];var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Vendor");var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.vendorInd==="idSearchByVendor"?this.sSearchCoText:this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.EQ,this.vendorInd==="idSearchByVendor"?this.sSearchPOrg:this.sPOrg);i.push(o);i.push(a);i.push(r);this._oVendorDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:i})},handleSearchVendor:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Vendor");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.EQ,this.sPOrg);var s=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var l=[];l.push(i);l.push(o);l.push(a);l.push(r);this._oVendorDialog.bindAggregation("items",{path:"/ValueHelpSet",template:s,filters:l})},onSelectVendorList:function(e){var t=this;var i=t.getView().getModel();var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){t.sVendor=e.getObject().IdNumber;t.sVendorName=e.getObject().IdText;t.getView().byId("idVendor").setValue(e.getObject().IdText);let o=t.sVendor;let a=i.bindContext("/GetCurrencyExecuteAction(...)");a.setParameter("Vendor",o);a.execute().then(()=>{const e=a.getBoundContext();let i=e.getObject();console.log("Currency Data:",i);if(i&&i.Currency){t.getView().byId("idCurrency").setValue(i.Currency);t.getView().getModel("localJson").setProperty("/Currency",i.Currency)}else{sap.m.MessageToast.show("No currency data returned")}}).catch(e=>{console.error("Error executing action: ",e);sap.m.MessageBox.error("Failed to fetch currency")})})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([]);t.consultantIndecator="";t.vendorInd=""},onDisplaySearchProjDialog:function(){if(!this._oProjDialog){this._oProjDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.ProjSearchDialog",this);this._oProjDialog.setModel(this.getView().getModel())}this._oProjDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Zone");var o=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var a=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var r=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.Contains,this.ModelCode);var s=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.Contains,this.Building);var l=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.Contains,this.GroupCode);t.push(i);t.push(o);t.push(a);if(this.ModelCode.length>0){t.push(r)}if(this.Building.length>0){t.push(s)}if(this.GroupCode.length>0){t.push(l)}this._oProjDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchProj:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Zone");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.Contains,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.Contains,this.ModelCode);var l=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.Contains,this.Building);var n=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.Contains,this.GroupCode);var d=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var g=[];g.push(i);g.push(o);g.push(a);g.push(r);if(this.ModelCode.length>0){g.push(s)}if(this.Building.length>0){g.push(l)}if(this.GroupCode.length>0){g.push(n)}this._oProjDialog.bindAggregation("items",{path:"/ValueHelpSet",template:d,filters:g})},onSelectProjList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.sProj=e.getObject().IdNumber;t.getView().byId("idSearchByProject").setValue(e.getObject().IdText)})}else{t.sProj="";t.getView().byId("idSearchByProject").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchModel:function(){if(!this._ModelDialog){this._ModelDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.ModelSearchDialog",this);this._ModelDialog.setModel(this.getView().getModel())}this._ModelDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Model");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,this.sCoCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var r=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,this.sProj);var s=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.EQ,this.Building);var l=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.Contains,this.GroupCode);t.push(i);t.push(o);t.push(a);if(this.sProj.length>0){t.push(r)}if(this.Building.length>0){t.push(s)}if(this.GroupCode.length>0){t.push(l)}this._ModelDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchModel:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Model");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sCoCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,this.sProj);var l=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.EQ,this.Building);var n=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.Contains,this.GroupCode);var d=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var g=[];g.push(i);g.push(o);g.push(a);g.push(r);if(this.sProj.length>0){g.push(s)}if(this.Building.length>0){g.push(l)}if(this.GroupCode.length>0){g.push(n)}this._ModelDialog.bindAggregation("items",{path:"/ValueHelpSet",template:d,filters:g})},onSelectModelList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.ModelCode=e.getObject().IdNumber;t.getView().getModel("localJson").setProperty("/selectBoq",false);t.getView().byId("idSearchByModel").setValue(e.getObject().IdText)})}else{t.ModelCode="";t.getView().byId("idSearchByModel").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearBuilding:function(){if(!this._BuildingDialog){this._BuildingDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.BuildingSearchDialog",this);this._BuildingDialog.setModel(this.getView().getModel())}this._BuildingDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"BUILDINGID");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,this.sProj);var s=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.EQ,this.ModelCode);var l=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.EQ,this.GroupCode);t.push(i);if(this.sProjectCode.length>0){t.push(o)}if(this.sProj.length>0){t.push(r)}if(this.ModelCode.length>0){t.push(s)}if(this.GroupCode.length>0){t.push(l)}t.push(a);this._BuildingDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchBuilding:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"BUILDINGID");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,this.sProj);var l=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.EQ,this.ModelCode);var n=new sap.ui.model.Filter("SelectionParameter6",sap.ui.model.FilterOperator.EQ,this.GroupCode);var d=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var g=[];g.push(i);if(this.sProjectCode.length>0){g.push(r)}g.push(a);g.push(o);if(this.sProj.length>0){g.push(s)}if(this.ModelCode.length>0){g.push(l)}if(this.GroupCode.length>0){g.push(n)}this._BuildingDialog.bindAggregation("items",{path:"/ValueHelpSet",template:d,filters:g})},onSelectBuilding:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.Building=e.getObject().IdNumber;t.getView().byId("_IdBuilding").setValue(e.getObject().IdText)})}else{t.Building="";t.getView().byId("_IdBuilding").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearGroup:function(){if(!this._GroupDialog){this._GroupDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.GroupSearchDialog",this);this._GroupDialog.setModel(this.getView().getModel())}this._GroupDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Group");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProj);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.Contains,this.ModelCode);var s=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.Contains,this.Building);t.push(i);if(this.sProj.length>0){t.push(o)}if(this.ModelCode.length>0){t.push(r)}if(this.Building.length>0){t.push(s)}t.push(a);this._GroupDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchGroup:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"Group");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProj);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.Contains,this.ModelCode);var l=new sap.ui.model.Filter("SelectionParameter5",sap.ui.model.FilterOperator.Contains,this.Building);var n=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var d=[];d.push(i);if(t!==""){d.push(r)}d.push(a);if(this.sProj.length>0){d.push(o)}if(this.ModelCode.length>0){d.push(s)}if(this.Building.length>0){d.push(l)}this._GroupDialog.bindAggregation("items",{path:"/ValueHelpSet",template:n,filters:d})},onSelectGroupList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.GroupCode=e.getObject().IdNumber;t.getView().byId("idSearchByGroup").setValue(e.getObject().IdText)})}else{t.GroupCode="";t.getView().byId("idSearchByGroup").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},handleSearWBS:function(){var e=this;if(!this._GroupDialog){this._GroupDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SuperiorWBSSearchDialog",this);this._GroupDialog.setModel(this.getView().getModel())}var t=e.getView().getModel();var i=new sap.ui.model.json.JSONModel;i.setData({SupeiorWBSSet:[]});e._SuperiorWBSDialog.setModel(i,"localJson");var o=[];var a=[];var r=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"SUBWBS");var s=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var l=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var n=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,sap.ui.getCore().byId("idDesc").getValue());var d=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idlenth").getValue());o.push(r);o.push(s);o.push(l);if(sap.ui.getCore().byId("idDesc").getValue()!==""){o.push(n)}if(sap.ui.getCore().byId("idlenth").getValue()!==""){o.push(d)}if(sap.ui.getCore().byId("idlenth").getValue()===""){var d=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,500);o.push(d)}t.read("/ValueHelpSet",{filters:o,success:function(t){var i=JSON.parse(JSON.stringify(t.results));e._SuperiorWBSDialog.getModel("localJson").setProperty("/SupeiorWBSSet",i)},error:function(e){sap.m.MessageToast.show("Error")}})},onSelectCheque:function(e){this.SupeiorWBSText=e.getParameters().rowContext.getObject().IdText;this.SupeiorWBSCode=e.getParameters().rowContext.getObject().IdNumber;this.getView().byId("idSupeiorWBS").setValue(this.SupeiorWBSText);this._SuperiorWBSDialog.close();this._SuperiorWBSDialog.destroy();this._SuperiorWBSDialog=null},_handleCancelPresswbs:function(){var e=this;this.SupeiorWBSText="";this.SupeiorWBSCode="";this.getView().byId("idSupeiorWBS").setValue("");e._SuperiorWBSDialog.close();e._SuperiorWBSDialog.destroy();e._SuperiorWBSDialog=null},onDisplaySearchidSupeiorWBSDialog:function(){if(this.sCoCode&&this.sProjectCode){if(!this._SuperiorWBSDialog){this._SuperiorWBSDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SuperiorWBSSearchDialog",this);this._SuperiorWBSDialog.setModel(this.getView().getModel())}this._SuperiorWBSDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"SUBWBS");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,1e3);t.push(i);t.push(o);t.push(a);t.push(r);this._SuperiorWBSDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})}else{sap.m.MessageToast.show(this.getView().getModel("i18n").getResourceBundle().getText("Msg_Error_Select_WBS_C"))}},handleSearchSuperior:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"SUBWBS");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var r=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("SelectionParameter4",sap.ui.model.FilterOperator.EQ,1e3);var l=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var n=[];n.push(i);n.push(o);n.push(a);n.push(r);n.push(s);this._SuperiorWBSDialog.bindAggregation("items",{path:"/ValueHelpSet",template:l,filters:n})},onSelectSuperiorList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.SupeiorWBSText=e.getObject().IdText;t.SupeiorWBSCode=e.getObject().IdNumber;t.getView().byId("idSupeiorWBS").setValue(e.getObject().IdText)})}else{t.SupeiorWBSText="";t.SupeiorWBSCode="";t.getView().byId("idSupeiorWBS").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchPOrgDialog:function(e){this.pOrgInd=e.getParameters().id;if(!this._oPOrgDialog){this._oPOrgDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.PurchaseOrgSearchDialog",this);this._oPOrgDialog.setModel(this.getView().getModel())}this._oPOrgDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var i=[];var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PORG");var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.Contains,this.pOrgInd==="idSearchPurchaseOrganization"?this.sSearchCoCode:this.sCoCode);i.push(o);i.push(a);this._oPOrgDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:i})},handleSearchPOrg:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PORG");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.Contains,this.sCoCode);var r=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var s=[];s.push(i);s.push(o);s.push(a);this._oPOrgDialog.bindAggregation("items",{path:"/ValueHelpSet",template:r,filters:s})},onSelectPOrgList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){if(t.pOrgInd==="idSearchPurchaseOrganization"){t.sSearchPOrg=e.getObject().IdNumber;sap.ui.getCore().byId("idSearchPurchaseOrganization").setValue(e.getObject().IdText)}else{t.sPOrg=e.getObject().IdNumber;t.getView().byId("idPurchaseOrganization").setValue(e.getObject().IdText)}})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([]);t.sSearchPOrg=""},onDisplayDocType:function(e){if(!this._sdoctypeDialog){this._sdoctypeDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.DocumentType",this);this._sdoctypeDialog.setModel(this.getView().getModel())}this._sdoctypeDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var i=[];var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"DOC_TYPE");i.push(o);this._sdoctypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:i})},handleSearchDocType:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"DOC_TYPE");var o=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.Contains,t);var a=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var r=[];r.push(i);r.push(o);this._sdoctypeDialog.bindAggregation("items",{path:"/ValueHelpSet",template:a,filters:r})},onSelectDocTypeList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.sDocTypeText=e.getObject().IdText;t.sDocType=e.getObject().IdNumber;t.getView().byId("_idSdocumenttype").setValue(e.getObject().IdText)})}else{t.sDocTypeText="";t.sDocType="";t.getView().byId("_idSdocumenttype").setValue("");sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchPGrpDialog:function(e){this.pGrpInd=e.getParameters().id;if(!this._oPGrpDialog){this._oPGrpDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.PurchaseGrpSearchDialog",this);this._oPGrpDialog.setModel(this.getView().getModel())}this._oPGrpDialog.open();var t=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var i=[];var o=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PGRP");i.push(o);this._oPGrpDialog.bindAggregation("items",{path:"/ValueHelpSet",template:t,filters:i})},handleSearchPGrp:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PGRP");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var r=[];r.push(i);r.push(o);this._oPGrpDialog.bindAggregation("items",{path:"/ValueHelpSet",template:a,filters:r})},onSelectPGrpList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){if(t.pGrpInd==="idSearchPurchaseGroup"){t.sSearchPGrp=e.getObject().IdNumber;sap.ui.getCore().byId("idSearchPurchaseGroup").setValue(e.getObject().IdText)}else{t.sPGrp=e.getObject().IdNumber;t.getView().byId("idPurchaseGroup").setValue(e.getObject().IdText)}})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([]);t.pGrpInd=""},onDisplaySearchPlantDialog:function(){if(!this._oPlantDialog){this._oPlantDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.PlantSearchDialog",this);this._oPlantDialog.setModel(this.getView().getModel())}this._oPlantDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var t=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PLANT");var o=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.Contains,this.sPOrg);t.push(i);t.push(o);this._oPlantDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchPlant:function(e){var t=e.getParameter("value");var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PLANT");var o=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);var a=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.Contains,this.sPOrg);var r=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var s=[];s.push(i);s.push(o);s.push(a);this._oPlantDialog.bindAggregation("items",{path:"/ValueHelpSet",template:r,filters:s})},onSelectPlantList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.sPlant=e.getObject().IdNumber;t.getView().byId("idPlant").setValue(e.getObject().IdText)})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchSubBoqDialog:function(e){if(!this._oSubBoqDialog){this._oSubBoqDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SubBoqSearchDialog",this);this._oSubBoqDialog.setModel(this.getView().getModel())}this._oSubBoqDialog.open();this.sSubBoqId=e.getParameters().id;var t=e.getSource().getBindingContext("localJson").getObject().Model;this.BoqDescR=e.getSource().getBin=e.getSource().getBindingContext("localJson").getObject();var i=new sap.ui.model.Filter("Boq",sap.ui.model.FilterOperator.EQ,t);var o=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,this.sCoCode);var a=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var r=new sap.m.StandardListItem({title:"{BoqSub}",description:"{BoqDesc}"});var s=[];s.push(i);s.push(o);s.push(a);this._oSubBoqDialog.bindAggregation("items",{path:"/BoqSubItemSet",template:r,filters:s})},onDisplay2SearchSubBoqDialog:function(e){if(!this._oSubBoq2Dialog){this._oSubBoq2Dialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SubBoqSearchDialog",this);this._oSubBoq2Dialog.setModel(this.getView().getModel())}this._oSubBoq2Dialog.open();this.sSubBoq2Id=e.getParameters().id;this.BoqDescR=e.getSource().getBindingContext("localJson").getObject();var t=e.getSource().getBindingContext("localJson").getObject().SelectionParameter6;var i=new sap.ui.model.Filter("Boq",sap.ui.model.FilterOperator.EQ,t);var o=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,this.sCoCode);var a=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,this.sProjectCode);var r=new sap.m.StandardListItem({title:"{BoqSub}",description:"{BoqDesc}"});var s=[];s.push(i);s.push(o);s.push(a);this._oSubBoq2Dialog.bindAggregation("items",{path:"/BoqSubItemSet",template:r,filters:s})},onSelectSubBoqList:function(e){var t=this;var i;var o=e.getParameter("selectedContexts");if(o&&o.length){o.map(function(e){if(t.sSubBoqId!==""){t.sSubBoq=e.getObject().BoqSub;i=e.getObject().BoqDesc;sap.ui.getCore().byId(t.sSubBoqId).setValue(e.getObject().BoqSub);t.BoqDescR.BoqDesc=i}if(t.sSubBoq2Id!==""){t.sSubBoq2=e.getObject().BoqSub;i=e.getObject().BoqDesc;sap.ui.getCore().byId(t.sSubBoq2Id).setValue(e.getObject().BoqSub);t.BoqDescR.BoqDesc=i}})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([]);this.sSubBoq2Id="";this.sSubBoqId=""},onAddBuildingsCreate:function(){var e=this;if(e.sProjectCode!==""&&e.sCoCode!==""){if(!e._oBuildingDialog){e._oBuildingDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SelectMultiBuildingCreate",e.getView().getController());var t=new sap.ui.model.resource.ResourceModel({bundleUrl:"i18n/i18n.properties"});e._oBuildingDialog.setModel(t,"i18n");e._oBuildingDialog.setModel(e.getView().getModel())}e._oBuildingDialog.open();if(e._oBuildingDialog.getModel("localJson"))e._oBuildingDialog.getModel("localJson").setProperty("/BuildingSet",[]);e.aContexts=[];e.Boqs=[];e.BUBoQs=[];e.WBSBoQs=[]}else{sap.m.MessageToast.show("Please select Company Code and Project first.")}},onAfterCloseWBS:function(e){var t=this;this._oWBSDialog.destroy();this._oWBSDialog=null},onAfterCloseBuilding:function(e){this._oBuildingDialog.destroy();this._oBuildingDialog=null},onActionAfterClose:function(e){var t=this;e.getSource().destroy();t._actionSheet=null},_handleCancelPressBuilding:function(e){var t=this;var i=t.getView().getModel("localJson").getProperty("/selectedBuilding");var o=[];for(var a=0;a<t.myBuildingSet.length;a++){var r=false;$.each(i,function(e,i){if(t.myBuildingSet[a].BuildingNo===i.BuildingNo)r=true});if(!r){o.push(t.myBuildingSet[a])}}t.myBuildingSet=JSON.parse(JSON.stringify(o));t.getView().getModel("localJson").setProperty("/myBuildingSet",t.myBuildingSet);t.getView().getModel("localJson").setProperty("/selectedBuilding",[]);t._oBuildingDialog.close();this.onAfterCloseBuilding(e)},handleSearchBuildingPress:function(e){var t=this;var i=t.getView().getModel(),o=[],a=t.getView().getModel("localJson"),r=true;var s=new sap.ui.model.Filter("Zone",sap.ui.model.FilterOperator.EQ,t.sProj);var l=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,t.sCoCode);var n=new sap.ui.model.Filter("BuildingNo",sap.ui.model.FilterOperator.EQ,t.Building);var d=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,t.sProjectCode);var g=new sap.ui.model.Filter("Group",sap.ui.model.FilterOperator.EQ,t.GroupCode);var u=new sap.ui.model.Filter("Model",sap.ui.model.FilterOperator.EQ,t.ModelCode);o.push(l);o.push(d);if(t.sProj!=="")o.push(s);if(t.Building!=="")o.push(n);if(t.GroupCode!==""){o.push(g)}if(t.ModelCode!==""){o.push(u)}i.read("/BuildingSet",{filters:o,success:function(e){$.each(e.results,function(i,o){e.results[i].Model=e.results[i].Model;if(i==0){t.oldmodelvalue=e.results[i].Model}if(t.oldmodelvalue!=e.results[i].Model||t.oldmodelvalue===""){r=false}});t.BoqAll="";t.BoqDescAll="";t.getView().byId("idhandboq").setValue(t.BoqDescAll);var i=JSON.parse(JSON.stringify(e.results));a.setProperty("/BuildingSet",i);a.refresh();if(t.oldmodelvalue===""){r=false}if(r){t.getView().getModel("localJson").setProperty("/selectBoq",true)}},error:function(e){sap.m.MessageToast.show("Error")}})},onSelectionChange:function(e){var t=this;var i=e.getSource();var o=true,a=[],r=[];t.BUBoQs=[];t.WBSBoQs=[];var s=t.getView().getModel("localJson").getProperty("/selectedBuilding"),l=this._BuildinDialog.getTable().getSelectedIndices();t.myBuildingSet=t.getView().getModel("localJson").getProperty("/myBuildingSet");var n=t.getView().getModel("localJson").getProperty("/selectedBuildingOrWBS");if(l.length>0){for(var d=0;d<l.length;d++){var g=this._BuildinDialog.getTable().getContextByIndex(l[d]).getObject();g.ChangeIndicator="AddB";a.push(g)}$.each(a,function(e,t){if(t.Group===""){r.push(t.BuildingNo);o=false}});$.each(t.myBuildingSet,function(e,t){$.each(a,function(e,i){if(i.BuildingNo===t.BuildingNo&&t.Model===i.Model&&t.Group===i.Group){r.push(t.BuildingNo);o=false}})});if(o){$.each(a,function(e,i){a[e].SubBoq=a[e].Group;a[e].ContractualIndicator="O";a[e].ModelType="BUILD";a[e].SrvStatus="UA";a[e].Txt="Original";a[e].DelInd="";t.myBuildingSet.push(a[e]);n.push(a[e]);s.push(a[e])});t.getView().getModel("localJson").setProperty("/selectedBuilding",s);t.getView().getModel("localJson").setProperty("/selectedBuildingOrWBS",n);t.aContexts.push(a);this.onBuildingContractClose();this._handleValueHelpCloseBuilding()}else if(!o){var u=r.join();sap.m.MessageToast.show("Model and  Boq is already added or don't select Boq"+u);r=[]}}},_handleValueHelpCloseBuilding:function(e){var t=this,i=t.getView().getModel();t.getView().setBusy(true);var o=t.getView().getModel();var a=t.getView().getModel("localJson").getProperty("/selectedBuilding");var r=t.getView().getModel("localJson").getProperty("/selectedBuildingOrWBS"),s=[];var l=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));if(t.aContexts.length===0)sap.m.MessageToast.show("Select one Building at least!");else{var n=false;$.each(t.myBuildingSet,function(e,t){if(t.Group===""){n=true}});if(n)sap.m.MessageToast.show("Select Boq for each Building!");else{$.each(a,function(e,i){t.BUBoQs.push(i.Model+i.Group)});t.BUBoQs.sort();var d=null;var g=0;var u=[];t.getView().getModel("localJson").setProperty("/selectBoq",false);t.oldmodelvalue="";t.BoqDescAll="";t.BoqAll="";t.getView().getModel("localJson").setProperty("/myBuildingSet",t.myBuildingSet);t.getView().getModel("localJson").setProperty("/myBuildingSet",t.myBuildingSet);this.objSet=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));this.selectedBuilding=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/selectedBuilding")));var c=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));this.getView().setBusy(true);$.each(r,function(e,t){var i=new sap.ui.model.Filter("Data",sap.ui.model.FilterOperator.BT,t.Model,t.Group);if(i!==""){u.push(i)}});var p=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,t.sProjectCode);if(p!==""){u.push(p)}var h=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,t.sCoCode);if(h!==""){u.push(h)}i.read("/BoqTreeSet",{filters:u,success:function(e,i){e=e.results;var o=1;var a=[];$.each(e,function(t,i){if(e[t].LevelNo==="1"){e[t].live="one";e[t].AddNew="AN"}if(e[t].Eancat===""&&parseInt(e[t].LevelNo)===4){e[t].Qty="0";e[t].Uom="";e[t].Price="0"}e[t].DelInd="";e[t].ModelType="BOQ";if(e[t].Eancat==="U"){e[t].Qty=0}if(parseInt(e[t].LevelNo)===4){e[t].Txt="Original";if(e[t].Eancat!=""){e[t].PriceUnit="1";e[t].Price="1"}e[t].DelInd="";e[t].ContractualIndicator="O";e[t].Indicator="Y"}else{e[t].Indicator="Z"}});for(o;o<e.length+1;o++){a.push({[o]:[]});for(var r=0;r<e.length;r++){e[r].Categories=[];if(parseInt(e[r].LevelNo)===o){a[o-1][o].push(e[r])}}}var s=[];$.each(a,function(e,t){if(e<3){$.each(t,function(t,i){if(i.length!==0){$.each(i,function(t,i){$.each(a[e+1],function(e,t){$.each(t,function(e,t){if(t.length!==0){if(i.LevelId===t.Parent){i.Categories.push(t)}}})})})}})}});$.each(a[0],function(e,t){if(t.length!==0){$.each(t,function(e,t){s.push(t)})}});var l=false;var n=false;$.each(s,function(e,i){l=false;n=false;if(t.objSet.length!==0){$.each(t.objSet,function(o,a){$.each(i.Categories,function(r,d){$.each(a.Categories,function(e,t){if(i.Data===a.Data){l=true;if(d.Data===t.Data){n=true}}});if(l&&!n){if(d.Model===a.Model){t.objSet[o].Categories.push(s[e].Categories[r]);n=false}}})});if(!l&&!n){t.objSet.push(i);l=false;n=false}}else{t.objSet.push(i)}n=false;l=false});t.getView().getModel("localJson").setProperty("/BoqItemSet",t.objSet);t.getView().getModel("localJson").setProperty("/selectedBuildingOrWBS",[]);t.Consoliatedservices();t.getView().setBusy(false);var a=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));var d=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));$.each(a,function(e,t){$.each(t.Categories,function(t,i){$.each(i.Categories,function(i,o){$.each(o.Categories,function(o,r){a[e].PriceUnit="0";a[e].Categories[t].PriceUnit="0";a[e].Categories[t].Categories[i].PriceUnit="0";a[e].Categories[t].Categories[i].Categories[o].Matdesc=a[e].Categories[t].Categories[i].ShortDesc})})})});var g;$.each(a,function(e,i){$.each(i.Categories,function(i,o){$.each(o.Categories,function(o,r){$.each(r.Categories,function(r,s){g=d.find(e=>e.Data===s.Data);if(g.Data===s.Data){var l=false;$.each(t.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===s.Model){l=true}});$.each(t.myWBSSet,function(e,t){if(t.Model===s.Model){l=true}});if(l){var n=JSON.parse(JSON.stringify(g.PriceUnit));a[e].Categories[i].Categories[o].Categories[r].price=n;a[e].Categories[i].Categories[o].Categories[r].PriceUnit=(n*parseFloat(a[e].Categories[i].Categories[o].Categories[r].Qty)).toString();if(s.Eancat!=="C"&&s.Eancat!=="U"){a[e].PriceUnit=(parseFloat(a[e].PriceUnit)+n*parseFloat(a[e].Categories[i].Categories[o].Categories[r].Qty)).toString()}if(s.Eancat!=="C"&&s.Eancat!=="U"){a[e].Categories[i].PriceUnit=(parseFloat(a[e].Categories[i].PriceUnit)+n*parseFloat(a[e].Categories[i].Categories[o].Categories[r].Qty)).toString()}if(s.Eancat!=="C"&&s.Eancat!=="U"){a[e].Categories[i].Categories[o].PriceUnit=(parseFloat(a[e].Categories[i].Categories[o].PriceUnit)+n*parseFloat(a[e].Categories[i].Categories[o].Categories[r].Qty)).toString()}}}})})})});t.getView().getModel("localJson").setProperty("/BoqItemSet",JSON.parse(JSON.stringify(a.sort((e,t)=>e.Data-t.Data))));t.ContractValueHeader();t.getView().setBusy(false)},error:function(e){sap.m.MessageToast.show("Error")}})}}},_longTextDialog:null,onPressLongText:function(e){var t=this;t.itemIndex=e.getSource().getBindingContext("localJson").getPath();var i=e.getSource().getBindingContext("localJson").getObject();if(!t._longTextDialog){t._longTextDialog=sap.ui.xmlfragment(t.getView().getId(),"com.cicre.po.view.fragments.ServiceLongText",t);t.getView().addDependent(t._longTextDialog)}t._longTextDialog.open();t.getView().byId("idLongText").setText(i.LongDesc)},groupcon3:function(e){var t=this;var i=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));var o=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));$.each(o,function(e,t){$.each(i,function(e,t){$.each(t.Categories,function(e,t){$.each(t.Categories,function(e,t){})})})})},onCloseLongTextFragment:function(e){this._longTextDialog.close()},onSavePress:function(){var e=this;var t=this.getView();var i=t.getModel("i18n").getResourceBundle();var o=e.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet");var a=e.getView().getModel("localJson").getProperty("/BoqItemSet");var r=e.getView().getModel("localJson").getProperty("/myPurchaseRequisition"),s=e.getView().getModel("localJson").getProperty("/PRItemSet");var l=e.getView().getModel("localJson").getProperty("/AttachmentSet"),n=e.getView().getModel("localJson").getProperty("/EstimatedContracts"),d=[],g=[],u=[],c=[],p=[],h={};var m=[this.getView().byId("idCompanyCode"),this.getView().byId("idPurchaseOrganization"),this.getView().byId("idPurchaseGroup"),this.getView().byId("idPlant"),this.getView().byId("idDocumentDate"),this.getView().byId("idValidFromDate"),this.getView().byId("idValidToDate"),this.getView().byId("idDeliveryDate"),this.getView().byId("_idSearchByProject"),this.getView().byId("idVendor"),this.getView().byId("idContractDescription"),this.getView().byId("_idSdocumenttype")];if(e.getView().byId("idCreationType").getSelectedKey()=="E"){if(e.SupeiorWBSCode==""){this.getView().byId("idSupeiorWBS").setValueState("Error");return}else{this.getView().byId("idSupeiorWBS").setValueState("None")}}var S=new sap.m.Dialog({title:i.getText("Confirm"),type:"Message",content:new sap.m.Text({text:i.getText("Msg_Confirm_Craete")}),beginButton:new sap.m.Button({text:i.getText("Confirm"),type:"Emphasized",press:function(){if(e.getView().byId("idMeasurementMethod").getSelectedKey()==="REMS")var t=true;jQuery.each(m,function(e,t){t.setValueState("None")});jQuery.each(m,function(e,t){if(!t.getValue()){t.setValueState("Error")}});jQuery.each(m,function(e,i){if("Error"===i.getValueState()){t=false;return}});if(!t){sap.m.MessageToast.show("Please Enter Manadatory Fields");S.close();return}else{$.each(e.myBuildingSet,function(e,t){p.push(t)});$.each(e.myWBSSet,function(e,t){p.push(t)});$.each(r,function(e,t){t.Group="";t.Project="";t.Model="";p.push(t)});$.each(p,function(e,t){c.push({PoHeader:"",Buildingno:t.BuildingNo,Zone:t.Project,Model:t.Model,Submodel:t.Group,ContractualIndicator:"O",TextContInd:"",VariationOrder:"",ChangeIndicator:"AddB",DeleteIndicator:"",SrvStatus:"UA",Network:t.Network,Type:t.ModelType})});if(r.length>0){$.each(s,function(t,i){$.each(i.Categories,function(t,o){$.each(o.Categories,function(t,a){d.push({PoHeader:"",PoItem:"",SubBoq:a.SubModel,DeleteInd:"",Plant:e.sPlant,MatlGroup:a.MatlGroup,Qty:parseFloat(a.Qty.toString()).toFixed(2),PoUnit:"",PriceUnit:a.PriceUnit.toString(),ItemCat:"",Acctasscat:"",Boq:a.Model,ShortText:a.ShortDesc,LongText:a.LongDesc,Serviceno:a.Data,Servicedesc:a.ShortDesc,BaseUom:a.Uom,WbsElement:"",NoLimit:"X",Buildingno:i.PrNumber,Project:"",OvfTol:a.OvfTol,ChangeIndicator:"AddB",DeliveryDate:e.getView().byId("idDeliveryDate").getValue(),ContractualIndicator:"O",SrvStatus:"UA",ServiceType:a.Eancat,Currency:e.getView().byId("idCurrency").getValue(),IuidRelevant:"P",PrItem:a.Item,Network:i.Network,ActivityNumber:o.ActivityNumber})})})})}$.each(a,function(t,i){$.each(i.Categories,function(t,o){$.each(o.Categories,function(t,o){$.each(o.Categories,function(t,a){d.push({PoHeader:"",PoItem:"",SubBoq:a.SubModel,DeleteInd:"",Plant:e.sPlant,MatlGroup:a.Item,Qty:parseFloat(a.Qty.toString()).toFixed(2),PoUnit:"",Matdesc:o.ShortDesc,PriceUnit:a.PriceUnit.toString(),ItemCat:"D",Acctasscat:"P",Boq:a.Model,ShortText:a.ShortDesc,LongText:a.LongDesc,Serviceno:a.Data,Servicedesc:a.ShortDesc,BaseUom:a.Uom,WbsElement:"",NoLimit:"X",Buildingno:"",Project:"",OvfTol:a.OvfTol,ChangeIndicator:"AddB",DeliveryDate:e.getView().byId("idDeliveryDate").getValue(),ContractualIndicator:"O",SrvStatus:"UA",ServiceType:a.Eancat,Currency:e.getView().byId("idCurrency").getValue(),IuidRelevant:i.ModelType==="WBS"?"X":""})})})})});var i;$.each(d,function(t,a){i=o.find(e=>e.Data===a.Serviceno);if(a.Serviceno===i.Data){d[t].PriceUnit=parseFloat(i.PriceUnit).toFixed(e.CustomCurrency);d[t].BaseUom=i.Uom;d[t].ProvisionRate=i.ProvisionRate?i.ProvisionRate.toString():"0"}});if(e.getView().byId("idNote").getValue()!==""){h={PoNumber:"",NoteText:e.getView().byId("idNote").getValue(),Flag:"X"}}setTimeout(function(){var t={PoNumber:"",Flag:"",DocType:e.sDocType,Project:e.sProjectCode,Vendor:e.sVendor,PurchOrg:e.sPOrg,PurchDoc:"",Message:"",PurGroup:e.sPGrp,CompCode:e.sCoCode,DocDate:e.getView().byId("idDocumentDate").getValue()===""?null:e.getView().byId("idDocumentDate").getValue(),VperStart:e.getView().byId("idValidFromDate").getValue()===""?null:e.getView().byId("idValidFromDate").getValue(),VperEnd:e.getView().byId("idValidToDate").getValue()===""?null:e.getView().byId("idValidToDate").getValue(),Status:"",DeleteInd:"",ContractDesc:e.getView().byId("idContractDescription").getValue(),LongDesc:e.getView().byId("idLongDescription").getValue(),Currency:e.getView().byId("idCurrency").getValue(),MeasMethod:e.getView().byId("idMeasurementMethod").getSelectedKey(),ConstructionType:e.getView().byId("idConstructionType").getSelectedKey(),RefContract:e.getView().byId("idRefrenceContract").getValue(),CreationDate:e.getView().byId("idDocumentDate").getValue()===""?null:e.getView().byId("idDocumentDate").getValue(),ValidFrom:e.getView().byId("idValidFromDate").getValue()===""?null:e.getView().byId("idValidFromDate").getValue(),ValidTo:e.getView().byId("idValidToDate").getValue()===""?null:e.getView().byId("idValidToDate").getValue(),SigninDate:e.getView().byId("idDeliveryDate").getValue()===""?null:e.getView().byId("idDeliveryDate").getValue(),RevisedValidTo:e.getView().byId("idRevisedValidToDate").getValue()===""?null:e.getView().byId("idRevisedValidToDate").getValue(),IndexMonth:e.getView().byId("idIndexMonth").getSelectedKeys().join(),Consultant:e.sConsultant,ConsultantName:e.sConsultantName,Ss:e.getView().byId("idResponsiblepersonSS").getSelectedKey(),Ir:e.getView().byId("idResponsiblepersonIR").getSelectedKey(),SuperiorWbs:e.SupeiorWBSCode,CreationType:e.getView().byId("idCreationType").getSelectedKey(),MarkUp:e.getView().byId("idMarkUp").getValue()===""?"0.0":e.getView().byId("idMarkUp").getValue(),VendorName:e.sVendorName,POHeaderToPOItem:d,POHeaderToPOBuildingNav:c,AttachmentSet:l,EstimatedContractValue:parseFloat(e.getModel("localJson").getProperty("/EstimatedContractValue")).toFixed(e.CustomCurrency),OriginalContractValue:parseFloat(e.getModel("localJson").getProperty("/OriginalContractValue")).toFixed(e.CustomCurrency),TotalContractValue:parseFloat(e.getModel("localJson").getProperty("/TotalContractValue")).toFixed(e.CustomCurrency),VariationOrderValue:parseFloat(e.getModel("localJson").getProperty("/VariationOrderValue")).toFixed(e.CustomCurrency),AddendumValue:parseFloat(e.getModel("localJson").getProperty("/AddendumValue")).toFixed(e.CustomCurrency),RevisedContractValue:parseFloat(e.getModel("localJson").getProperty("/RevisedContractValue")).toFixed(e.CustomCurrency),SerType:e.SERTYPE,ContractPONoteNav:h};var i=e.getView().getModel();console.log(t);e.getView().setBusy(true);const o=i.bindList("/ContractPOHeaderSet");o.attachCreateCompleted(e=>{console.log("Create Event Completed:",e)});const a=o.create(t);a.created().then(t=>{const i=a.getObject();if(i.PoNumber){sap.m.MessageBox.success("Contract "+i.PoNumber+" Created Successfully!",{title:"Success",onClose:function(t){e.getRouter().navTo("object",{objectId:i.PoNumber})}})}else{sap.m.MessageBox.error("Error: "+i.Message,{title:"Error"})}e.getView().setBusy(false)}).catch(t=>{e.getView().setBusy(false);sap.m.MessageToast.show("Error Creating Contract",{duration:4e3});let i="An unexpected error occurred.";try{const o=JSON.parse(t.responseText);const a=o.error?.innererror?.errordetails||[];if(a.length>0){let t=e.getView().getModel("localJson").getProperty("/MessageSet")||[];a.forEach(e=>{t.push({type:"Error",title:e.code.substring(0,10),description:e.message})});e.getView().getModel("localJson").setProperty("/MessageSet",t);e.getView().getModel("localJson").setProperty("/MessagesLength",t.length)}else{i=o.error?.message||"Unknown error."}}catch(e){console.error("Error Parsing Response:",e)}sap.m.MessageBox.error(i,{title:"Error"})})},2e3)}S.close()}}),endButton:new sap.m.Button({text:i.getText("Cancel"),press:function(){S.close()}}),afterClose:function(){S.destroy()}});S.open()},_createDialog:null,oncreatePO:function(e){var t=this;if(!this._createDialog){this._createDialog=new sap.m.Dialog({title:"{i18n>Confirm}",content:[new sap.m.Label({text:t.getResourceBundle().getText("detailRequestActivateMessage","CONTRACT-0007")})],beginButton:new sap.m.Button({text:"{i18n>Yes}",press:function(){this._createDialog.close();var e=t.getOwnerComponent().getModel();e.callFunction("/CreatePurchaseOrder",{method:"POST",urlParameters:{PoNo:"CONTRACT-0002"},success:function(e){},error:function(e){t.getView().getModel("detailView").setProperty("/busy",false);sap.m.MessageToast.show(t.getResourceBundle().getText("Error"),{duration:4e3})}})}.bind(this)}),endButton:new sap.m.Button({text:"{i18n>No}",press:function(){this._createDialog.close()}.bind(this)}),afterClose:function(){t._createDialog.destroy();t._createDialog=null}});this.getView().addDependent(this._createDialog)}this._createDialog.open()},onChangeTolerance:function(){var e=this;var t=e.getView().byId("idTolerance").getValue();var i=e.getView().getModel("localJson").getProperty("/BoqItemSet");$.each(i,function(e,o){$.each(o.Categories,function(o,a){$.each(a.Categories,function(a,r){$.each(r.Categories,function(r,s){i[e].Categories[o].Categories[a].Categories[r].OvfTol=t})})})});e.getView().getModel("localJson").setProperty("/BoqItemSet",i)},changeContractType:function(){var e=this;if(e.getView().byId("idMeasurementMethod").getSelectedKey()==="LUMP"||e.getView().byId("idMeasurementMethod").getSelectedKey()==="COST")e.getView().byId("idTolerance").setVisible(false);else if(e.getView().byId("idMeasurementMethod").getSelectedKey()==="COST")e.getView().byId("idMarkUp").setVisible(true);else e.getView().byId("idMarkUp").setVisible(false)},onChangeQty:function(e){var t=this;var i=e.getSource().getBindingContext("localJson").getPath();var o=t.getView().getModel("localJson").getProperty(i);var a=e.getParameters().newValue;var r=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));var s=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/myBuildingSet")));var l=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));var n=0;var d=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/myWBSSet")));var g=0;if(o.ModelType==="BOQ"){$.each(s,function(e,t){if("00000"+t.Model===o.Model)++g})}else{$.each(d,function(e,t){if(t.Model===o.Model)++g})}$.each(l,function(e,t){$.each(t.Categories,function(e,t){$.each(t.Categories,function(e,t){$.each(t.Categories,function(e,t){if(o.Data===t.Data){n=(parseFloat(n)+parseFloat(t.Qty)).toString()}})})})});$.each(r,function(e,t){if(t.Data===o.Data){r[e].Qty=n}});t.getView().getModel("localJson").setProperty(i+"/Qty",a===""?"0":JSON.parse(JSON.stringify(a)));t.getView().getModel("localJson").setProperty("/BoqConsulidatedItemSet",JSON.parse(JSON.stringify(r.sort((e,t)=>e.Data-t.Data))));t.onPriceConsolidatedChange("",o,JSON.parse(JSON.stringify(a)))},onPriceConsolidatedChange:function(e,t,i){var o=this;var a,r;var s=JSON.parse(JSON.stringify(o.getView().getModel("localJson").getProperty("/BoqItemSet")));var l=JSON.parse(JSON.stringify(o.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));var n=JSON.parse(JSON.stringify(o.getView().getModel("localJson").getProperty("/PRItemSet")));var d=this.getView().getModel("localJson").getProperty("/myPurchaseRequisition");$.each(s,function(e,t){$.each(t.Categories,function(t,i){$.each(i.Categories,function(i,o){$.each(o.Categories,function(o,a){s[e].PriceUnit="0";s[e].Categories[t].PriceUnit="0";s[e].Categories[t].Categories[i].PriceUnit="0"})})})});$.each(n,function(e,t){$.each(t.Categories,function(e,i){$.each(i.Categories,function(e,o){t.PriceUnit="0";i.PriceUnit="0";o.PriceUnit="0"})})});if(e!==""){var g=e.getSource().getBindingContext("localJson").getObject();var u=JSON.parse(JSON.stringify(g.PriceUnit));var c=g.Serviceno;$.each(l,function(e,t){$.each(s,function(e,i){$.each(i.Categories,function(i,a){$.each(a.Categories,function(a,r){$.each(r.Categories,function(r,l){if(t.Data===l.Data){var n=false;$.each(o.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===l.Model){n=true}});$.each(o.myWBSSet,function(e,t){if(t.Model===l.Model){n=true}});if(n){var d=JSON.parse(JSON.stringify(t.PriceUnit));s[e].Categories[i].Categories[a].Categories[r].price=d;s[e].Categories[i].Categories[a].Categories[r].PriceUnit=(d*parseFloat(s[e].Categories[i].Categories[a].Categories[r].Qty)).toString();if(l.Eancat!=="C"&&l.Eancat!=="U"){s[e].PriceUnit=(parseFloat(s[e].PriceUnit)+d*parseFloat(s[e].Categories[i].Categories[a].Categories[r].Qty)).toString()}if(l.Eancat!=="C"&&l.Eancat!=="U"){s[e].Categories[i].PriceUnit=(parseFloat(s[e].Categories[i].PriceUnit)+d*parseFloat(s[e].Categories[i].Categories[a].Categories[r].Qty)).toString()}if(l.Eancat!=="C"&&l.Eancat!=="U"){s[e].Categories[i].Categories[a].PriceUnit=(parseFloat(s[e].Categories[i].Categories[a].PriceUnit)+d*parseFloat(s[e].Categories[i].Categories[a].Categories[r].Qty)).toString()}}}})})})})});$.each(n,function(e,t){$.each(t.Categories,function(e,i){$.each(i.Categories,function(e,o){a=l.find(e=>e.Data===o.Data);r=a.ModelBoq.find(e=>e.ModelType==="PR");if(a.Data===o.Data&&r.ModelType==="PR"){$.each(d,function(e,r){if(r.PrNo==t.PrNumber&&i.Data===o.Item){var s=JSON.parse(JSON.stringify(a.PriceUnit));o.price=s;o.PriceUnit=(s*parseFloat(o.Qty)).toString();o.Qty=parseFloat(o.Qty).toString();if(o.Eancat!=="C"&&o.Eancat!=="U"){t.PriceUnit=(parseFloat(t.PriceUnit)+s*parseFloat(o.Qty)).toString()}if(o.Eancat!=="C"&&o.Eancat!=="U"){i.PriceUnit=(parseFloat(i.PriceUnit)+s*parseFloat(o.Qty)).toString()}}})}})})})}else{var g=t;var c=g.Serviceno;$.each(l,function(e,t){$.each(s,function(e,i){$.each(i.Categories,function(i,a){$.each(a.Categories,function(a,r){$.each(r.Categories,function(r,l){if(t.Data===l.Data){var n=false;$.each(o.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===l.Model){n=true}});$.each(o.myWBSSet,function(e,t){if(t.Model===l.Model){n=true}});if(n){var d=JSON.parse(JSON.stringify(t.PriceUnit));s[e].Categories[i].Categories[a].Categories[r].price=d;s[e].Categories[i].Categories[a].Categories[r].PriceUnit=(d*parseFloat(s[e].Categories[i].Categories[a].Categories[r].Qty)).toString();if(l.Eancat!=="C"&&l.Eancat!=="U"){s[e].PriceUnit=(parseFloat(s[e].PriceUnit)+d*parseFloat(s[e].Categories[i].Categories[a].Categories[r].Qty)).toString()}if(l.Eancat!=="C"&&l.Eancat!=="U"){s[e].Categories[i].PriceUnit=(parseFloat(s[e].Categories[i].PriceUnit)+d*parseFloat(s[e].Categories[i].Categories[a].Categories[r].Qty)).toString()}if(l.Eancat!=="C"&&l.Eancat!=="U"){s[e].Categories[i].Categories[a].PriceUnit=(parseFloat(s[e].Categories[i].Categories[a].PriceUnit)+d*parseFloat(s[e].Categories[i].Categories[a].Categories[r].Qty)).toString()}}}})})})})})}$.each(l,function(e,t){l[e].Amount=parseFloat(l[e].Qty)*parseFloat(l[e].PriceUnit)});o.getView().getModel("localJson").setProperty("/BoqConsulidatedItemSet",JSON.parse(JSON.stringify(l.sort((e,t)=>e.Data-t.Data))));o.getView().getModel("localJson").setProperty("/BoqItemSet",JSON.parse(JSON.stringify(s.sort((e,t)=>e.Data-t.Data))));o.getView().getModel("localJson").setProperty("/PRItemSet",JSON.parse(JSON.stringify(n.sort((e,t)=>e.Data-t.Data))));this.ContractValueHeader()},onExpandFirstLevel:function(){var e=this.byId("TreeTableBasic");e.expandToLevel(3)},onCollapseAll:function(){var e=this.byId("TreeTableBasic");e.collapseAll()},handleOpenActionSheet1:function(e){var t=e.getSource();if(!this._actionSheet){this._actionSheet=sap.ui.xmlfragment("com.cicre.po.view.fragments.ActionSheetDialog",this);this.getView().addDependent(this._actionSheet)}this._actionSheet.openBy(t)},onWBSSelectionValueHelpPressB:function(e){if(e.getSource().getId().lastIndexOf("idAddPurchaseRequisitionc")>-1){this.fragmentType="PR";if(this.sProjectCode===""){sap.m.MessageToast.show(this.getView().getModel("i18n").getResourceBundle().getText("PleaseEnterTheProject"));return}else{this.onPRSelectionValueHelpPress()}}else{this.fragmentType="WBS";this.onWBSSelectionValueHelpPress()}this.getView().getModel("localJson").setProperty("/fragmentType",this.fragmentType)},onAddWBSCreate:function(){var e=this;if(e.sProjectCode!==""&&e.sCoCode!==""){if(!e._oWBSDialog){e._oWBSDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SelectMultiWBSCreate",e);var t=new sap.ui.model.resource.ResourceModel({bundleUrl:"i18n/i18n.properties"});e._oWBSDialog.setModel(t,"i18n");e._oWBSDialog.setModel(e.getView().getModel())}e._oWBSDialog.open();var i=e.getView().getModel();var o=new sap.ui.model.json.JSONModel;o.setData({WBSSet:[]});e._oWBSDialog.setModel(o,"localJson");var a=[];var r=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"WBS");var s=new sap.ui.model.Filter("SelectionParameter2",sap.ui.model.FilterOperator.EQ,this.sCoCode);var l=new sap.ui.model.Filter("SelectionParameter3",sap.ui.model.FilterOperator.EQ,this.sProjectCode);a.push(r);a.push(s);a.push(l);i.read("/ValueHelpSet",{filters:a,success:function(t){$.each(t.results,function(e,i){t.results[e].Group="";t.results[e].Model=t.results[e].IdNumber});var i=JSON.parse(JSON.stringify(t.results));e._oWBSDialog.getModel("localJson").setProperty("/WBSSet",i)},error:function(e){sap.m.MessageToast.show("Error")}});e.aContexts=[];e.Boqs=[];e.BUBoQs=[];e.WBSBoQs=[]}else{sap.m.MessageToast.show("Please select Company Code and Project first.")}},_handleCancelPressWBS:function(){var e=this;var t=e.getView().getModel("localJson").getProperty("/selectedBuilding");var i=[];for(var o=0;o<e.myWBSSet.length;o++){var a=false;$.each(t,function(t,i){if(e.myWBSSet[o].Model===i.Model)a=true});if(!a){i.push(e.myWBSSet[o])}}e.myWBSSet=JSON.parse(JSON.stringify(i));e.getView().getModel("localJson").setProperty("/myWBSSet",e.myWBSSet);e.getView().getModel("localJson").setProperty("/selectedBuilding",[]);e._oWBSDialog.close()},onWBSSelectionChange:function(e){var t=this;var i=e.getSource();var o=true,a=[],r=[];t.BUBoQs=[];t.WBSBoQs=[];var s=t.getView().getModel("localJson").getProperty("/selectedBuildingOrWBS");var l=t.getView().getModel("localJson").getProperty("/selectedBuilding"),n=this._contractDialog.getTable().getSelectedIndices();t.myWBSSet=t.getView().getModel("localJson").getProperty("/myWBSSet");if(n.length>0){for(var d=0;d<n.length;d++){var g=this._contractDialog.getTable().getContextByIndex(n[d]).getObject();g.ChangeIndicator="AddB";a.push(g)}$.each(a,function(e,t){if(t.Group===""){r.push(t.IdNumber);o=false}});$.each(t.myWBSSet,function(e,t){$.each(a,function(e,i){if(i.IdNumber===t.IdNumber&&t.Model===i.Model&&t.Group===i.Group){r.push(t.IdNumber);o=false}})});if(o){$.each(a,function(e,i){a[e].ContractualIndicator="O";a[e].SrvStatus="UA";a[e].ModelType="WBS";a[e].DelInd="";a[e].AsBuild2="";a[e].WbsCode=a[e].SelectionParameter;a[e].Txt="Original";a[e].SubBoq=a[e].Group;a[e].GroupCode=a[e].SelectionParameter6;a[e].BuildingNo=parseInt(a[e].IdNumber).toString();t.myWBSSet.push(a[e]);s.push(a[e]);l.push(a[e])});t.aContexts.push(a);t.getView().getModel("localJson").setProperty("/selectedBuilding",l);t.getView().getModel("localJson").setProperty("/selectedBuildingOrWBS",s);this.onWBSContractClose();this._handleValueHelpCloseWBS()}else if(!o){var u=r.join();sap.m.MessageToast.show("WBS is already added or don't select Boq "+u)}}},_handleValueHelpCloseWBS:function(e){var t=this,i=t.getView().getModel(),o=[],a=4;var r=new sap.ui.model.json.JSONModel;var s=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/selectedBuilding")));var l=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));if(t.aContexts.length===0)sap.m.MessageToast.show("Select one WBS at least!");else{var n=false;$.each(t.myWBSSet,function(e,t){if(t.Group===""){n=true}});if(n)sap.m.MessageToast.show("Select Boq for each WBS!");else{$.each(s,function(e,i){t.BUBoQs.push(i.Model+i.Group)});t.BUBoQs.sort();var d=t.getView().getModel("localJson").getProperty("/selectedBuildingOrWBS");$.each(d,function(e,t){var i=new sap.ui.model.Filter("Data",sap.ui.model.FilterOperator.BT,t.Model,t.Group);if(i!==""){o.push(i)}});t.getView().setBusy(true);var g=new sap.ui.model.Filter("Project",sap.ui.model.FilterOperator.EQ,t.sProjectCode);var u=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,t.sCoCode);var c=new sap.ui.model.Filter("Eancat",sap.ui.model.FilterOperator.EQ,"W");if(g!==""){o.push(g)}if(u!==""){o.push(u)}if(c!==""){o.push(c)}this.objSet=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));t.getView().getModel("localJson").setProperty("/selectedBuildingOrWBS",[]);t.getView().getModel("localJson").setProperty("/myWBSSet",JSON.parse(JSON.stringify(t.myWBSSet)));var p=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));var h=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));var m="/BoqTreeSet";var S=i.bindList(m,undefined,undefined,o);S.requestContexts(0,100).then(function(e){var i=e.map(e=>e.getObject());var o=1;var r=[];$.each(i,function(e,t){i[e].DelInd="";i[e].ModelType="WBS";if(i[e].LevelNo==="1"){i[e].live="one";i[e].AddNew="AN"}if(i[e].Eancat===""&&parseInt(i[e].LevelNo)===4){i[e].Qty="0";i[e].Uom="";i[e].Price="0"}i[e].DelInd="";i[e].ModelType="WBS";if(i[e].Eancat==="U"){i[e].Qty=0}if(parseInt(i[e].LevelNo)===4){i[e].Txt="Original";i[e].DelInd="";if(i[e].Eancat!=""){i[e].PriceUnit="1";i[e].Price="1"}i[e].ContractualIndicator="O";i[e].Indicator="Y"}else{i[e].Indicator="Z"}});for(o;o<=parseInt(a);o++){r.push({[o]:[]});for(var s=0;s<i.length;s++){i[s].Categories=[];if(parseInt(i[s].LevelNo)===o){r[o-1][o].push(i[s])}}}var l=[];$.each(r,function(e,t){if(e<3){$.each(t,function(t,i){if(i.length!==0){$.each(i,function(t,i){$.each(r[e+1],function(e,t){$.each(t,function(e,t){if(t.length!==0){if(i.LevelId===t.Parent){i.Categories.push(t)}}})})})}})}});$.each(r[0],function(e,t){if(t.length!==0){$.each(t,function(e,t){l.push(t)})}});var n=false;var d=false;$.each(l,function(e,i){n=false;d=false;if(t.objSet.length!==0){$.each(t.objSet,function(o,a){$.each(i.Categories,function(r,s){$.each(a.Categories,function(e,t){if(i.Data===a.Data){n=true;if(s.Data===t.Data){d=true}}});if(n&&!d){if(s.Model===a.Model){t.objSet[o].Categories.push(l[e].Categories[r]);d=false}}})});if(!n&&!d){t.objSet.push(i);n=false;d=false}}else{t.objSet.push(i)}d=false;n=false});t.getView().getModel("localJson").setProperty("/BoqItemSet",t.objSet);t.Consoliatedservices();t.getView().setBusy(false);var r=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqItemSet")));var g=JSON.parse(JSON.stringify(t.getView().getModel("localJson").getProperty("/BoqConsulidatedItemSet")));$.each(r,function(e,t){$.each(t.Categories,function(t,i){$.each(i.Categories,function(i,o){$.each(o.Categories,function(o,a){r[e].PriceUnit="0";r[e].Categories[t].PriceUnit="0";r[e].Categories[t].Categories[i].PriceUnit="0";r[e].Categories[t].Categories[i].Categories[o].Matdesc=r[e].Categories[t].Categories[i].ShortDesc})})})});var u;$.each(r,function(e,i){$.each(i.Categories,function(i,o){$.each(o.Categories,function(o,a){$.each(a.Categories,function(a,s){u=g.find(e=>e.Data===s.Data);if(u.Data===s.Data){var l=false;$.each(t.myBuildingSet,function(e,t){if((t.Model.length===8?t.Model:"00000"+t.Model)===s.Model){l=true}});$.each(t.myWBSSet,function(e,t){if(t.Model===s.Model){l=true}});if(l){var n=JSON.parse(JSON.stringify(u.PriceUnit));r[e].Categories[i].Categories[o].Categories[a].price=n;r[e].Categories[i].Categories[o].Categories[a].PriceUnit=(n*parseFloat(r[e].Categories[i].Categories[o].Categories[a].Qty)).toString();if(s.Eancat!=="C"&&s.Eancat!=="U"){r[e].PriceUnit=(parseFloat(r[e].PriceUnit)+n*parseFloat(r[e].Categories[i].Categories[o].Categories[a].Qty)).toString()}if(s.Eancat!=="C"&&s.Eancat!=="U"){r[e].Categories[i].PriceUnit=(parseFloat(r[e].Categories[i].PriceUnit)+n*parseFloat(r[e].Categories[i].Categories[o].Categories[a].Qty)).toString()}if(s.Eancat!=="C"&&s.Eancat!=="U"){r[e].Categories[i].Categories[o].PriceUnit=(parseFloat(r[e].Categories[i].Categories[o].PriceUnit)+n*parseFloat(r[e].Categories[i].Categories[o].Categories[a].Qty)).toString()}}}})})})});t.getView().getModel("localJson").setProperty("/BoqItemSet",JSON.parse(JSON.stringify(r.sort((e,t)=>e.Data-t.Data))));t.ContractValueHeader();t.getView().setBusy(false)}).catch(function(e){sap.m.MessageToast.show("Error");t.getView().setBusy(false)})}}},onDisplaySearchProjectDialog:function(){if(this._pDialog){this._pDialog.destroy();this._pDialog=null}if(!this._pDialog){this._pDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.ProjectSearchDialog",this);this._pDialog.setModel(this.getView().getModel())}this._pDialog.open();var e=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}",info:"{SelectionParameter}"});var t=[];var i=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PROJ");t.push(i);this._pDialog.bindAggregation("items",{path:"/ValueHelpSet",template:e,filters:t})},handleSearchProject:function(e){var t=e.getParameter("value");var i=new sap.m.StandardListItem({title:"{IdText}",description:"{IdNumber}"});var o=[];var a=new sap.ui.model.Filter("ValueHelpType",sap.ui.model.FilterOperator.EQ,"PROJ");var r=new sap.ui.model.Filter("SelectionParameter",sap.ui.model.FilterOperator.Contains,t);o.push(a);o.push(r);this._pDialog.bindAggregation("items",{path:"/ValueHelpSet",template:i,filters:o})},onSelectProjectList:function(e){var t=this;var i=e.getParameter("selectedContexts");if(i&&i.length){i.map(function(e){t.sProjectCode=e.getObject().IdNumber;t.getView().byId("_idSearchByProject").setValue(e.getObject().IdText)})}else{sap.m.MessageToast.show("No new item was selected.")}e.getSource().getBinding("items").filter([])},onDisplaySearchRefrenceContractDialog:function(){if(!this._oRefContractDialog){this._oRefContractDialog=sap.ui.xmlfragment("com.cicre.po.view.fragments.SelectMultiRefrenceContract",this);this._oRefContractDialog.setModel(this.getView().getModel())}this._oRefContractDialog.open();var e=new sap.ui.model.resource.ResourceModel({bundleUrl:"i18n/i18n.properties"});this._oRefContractDialog.setModel(e,"i18n")},onSearchContract:function(){var e=this;var t=sap.ui.getCore().byId("table");t.setBusy(true);var i=this.getView().getModel();i.read("/ContractPOHeaderSet");t.setModel(i,"poModel");var o=new sap.ui.model.Filter("PurchDoc",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idSearchByPO").getValue());var a=new sap.ui.model.Filter("Vendor",sap.ui.model.FilterOperator.EQ,this.sSearchVendor);var r=new sap.ui.model.Filter("CompCode",sap.ui.model.FilterOperator.EQ,this.sSearchCoCode);var s=new sap.ui.model.Filter("PurchOrg",sap.ui.model.FilterOperator.EQ,this.sSearchPOrg);var l=new sap.ui.model.Filter("PurGroup",sap.ui.model.FilterOperator.EQ,this.sSearchPGrp);var n=new sap.ui.model.Filter("Flag",sap.ui.model.FilterOperator.EQ,"X");var d=[];if(sap.ui.getCore().byId("idSearchByPO").getValue().length>0){d.push(o)}if(this.sSearchVendor.length>0&&sap.ui.getCore().byId("idSearchByVendor").getValue()!==""){d.push(a)}if(this.sSearchCoCode.length>0){d.push(r)}if(this.sSearchPOrg.length>0&&sap.ui.getCore().byId("idSearchPurchaseOrganization").getValue()!==""){d.push(s)}if(this.sSearchPGrp.length>0&&sap.ui.getCore().byId("idSearchPurchaseGroup").getValue()!==""){d.push(l)}d.push(n);var g=t.getBinding("items");g.filter(d);t.setBusy(false)},_handleCancelPressContract:function(){var e=this;e._oRefContractDialog.close()},_handleValueHelpCloseContract:function(){var e=this;var t=e.selectedRefContracts.join();e.getView().byId("idRefrenceContract").setValue(t);e._oRefContractDialog.close()},onAfterClose:function(){if(this._oRefContractDialog){this._oRefContractDialog.destroy();this._oRefContractDialog=null}},onRefContSelectionChange:function(e){var t=this;var i=e.getSource();var o=true;t.selectedRefContracts=t.getView().getModel("localJson").getProperty("/selectedRefContracts");if(e.getParameters().selected===true){var a=e.getParameter("listItem").getBindingContext("poModel").getObject();$.each(t.selectedRefContracts,function(e,t){if(t===a.PurchDoc)o=false});if(o){t.selectedRefContracts.push(a.PurchDoc);t.getView().getModel("localJson").setProperty("/selectedRefContracts",t.selectedRefContracts);t.aContexts=i.getSelectedContexts(true)}else if(!o){var r=e.getSource();var s=r.getSelectedItem();s.setSelected(false);var l=e.getParameter("listItem").getBindingContextPath();var n=l.slice(l.lastIndexOf("/")+1);sap.m.MessageToast.show("Contract is already added!")}}else{var l=e.getParameter("listItem").getBindingContextPath();var n=l.slice(l.lastIndexOf("/")+1);t.selectedRefContracts.splice(n,1);t.aContexts.splice(n,1);t.getView().getModel("localJson").setProperty("/selectedRefContracts",t.selectedRefContracts)}},changeCreationType:function(){if(this.getView().byId("idCreationType").getSelectedKey()==="E")this.getView().getModel("localJson").setProperty("/estimatedMode",true);else this.getView().getModel("localJson").setProperty("/estimatedMode",false);this.getView().byId("idSupeiorWBS").setValueState("None")},handleAddEstimatedContract:function(){var e=this;var t=e.getModel("localJson").getProperty("/EstimatedContracts");var i={Servicedesc:"",Amount:""};t.push(i);e.getModel("localJson").setProperty("/EstimatedContracts",t)},deleteEstimatedContract:function(e){var t=this;var i=t.getModel("localJson").getProperty("/EstimatedContracts");var o=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var a=o[2];i.splice(a,1);t.getModel("localJson").setProperty("/EstimatedContracts",i);t.getModel("localJson").refresh(true);this.ContractValueHeader()},handlevariationOrder:function(){var e=this;var t=e.getModel("localJson").getProperty("/EstimatedContracts");var i={Servicedesc:"",Amount:""};t.push(i);e.getModel("localJson").setProperty("/EstimatedContracts",t)},onDeleteBuilding:function(e){var t=this;var i=this.getView().byId("IdBuildingTable").getModel("localJson");var o=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var a=parseInt(o[2]);var r=i.getProperty("/myBuildingSet/"+a);var s=e.getSource().getBindingContext("localJson").getPath();var l=this.getView();var n=l.getModel("i18n").getResourceBundle();var d=new sap.m.Dialog({title:n.getText("Delete"),type:"Message",content:new sap.m.Text({text:n.getText("Msg_Confirm_Delete")}),beginButton:new sap.m.Button({text:n.getText("Delete"),type:"Emphasized",press:function(){var e=t.getView().getModel("localJson");var i=e.getProperty(s);if(r.SrvStatus==="UA"){i.DelInd=i.DelInd==="Y"?"":"Y";d.close();r.Boq=r.Model.length===8?r.Model:"00000"+r.Model;t.deletesrv(r);t.deleteBOQliseConsolidate(r);e.setProperty(s,i)}else if(r.SrvStatus==="A"){sap.m.MessageToast.show("you should handel this service");i.DelInd=i.DelInd==="X"?"":"X";d.close();e.setProperty(s,i)}}}),endButton:new sap.m.Button({text:n.getText("Cancel"),press:function(){d.close()}}),afterClose:function(){d.destroy()}});d.open()},onDeleteWBS:function(e){var t=this;var i=this.getView().byId("IdWBSTable").getModel("localJson");var o=e.getSource().getParent().getBindingContext("localJson").getPath().split("/");var a=parseInt(o[2]);var r=i.getProperty("/myWBSSet/"+a);var s=e.getSource().getBindingContext("localJson").getPath();var l=this.getView();var n=l.getModel("i18n").getResourceBundle();var d=new sap.m.Dialog({title:n.getText("Delete"),type:"Message",content:new sap.m.Text({text:n.getText("Msg_Confirm_Delete")}),beginButton:new sap.m.Button({text:n.getText("Delete"),type:"Emphasized",press:function(){var e=t.getView().getModel("localJson");var i=e.getProperty(s);if(r.SrvStatus==="UA"){i.DelInd="Y";i.ChangeIndicator="Y";d.close();r.Boq=r.Model.length===8?r.Model:"00000"+r.Model;t.deletesrv(r);t.deleteBOQliseConsolidate(r);e.setProperty(s,i)}else if(r.SrvStatus==="A"){sap.m.MessageToast.show("you should handel this service");i.DelInd=i.DelInd==="X"?"":"X";t.deletesrvA(r,s);d.close();e.setProperty(s,i)}}}),endButton:new sap.m.Button({text:n.getText("Cancel"),press:function(){d.close()}}),afterClose:function(){d.destroy()}});d.open()},onPRSelectionChange:function(e){var t=this;var i=true,o=[],a=[];var r=t.getView().getModel("localJson").getProperty("/selectedPR");var s=t.getView().getModel("localJson").getProperty("/myPurchaseRequisition"),l=this._contractDialogPR.getTable().getSelectedIndices();t.myWBSSet=t.getView().getModel("localJson").getProperty("/myWBSSet");if(l.length>0){for(var n=0;n<l.length;n++){var d=this._contractDialogPR.getTable().getContextByIndex(l[n]).getObject();d.ChangeIndicator="AddB";o.push(d)}$.each(s,function(e,t){$.each(o,function(e,o){if(o.IdNumber===t.IdNumber&&t.Model===o.Model&&t.Group===o.Group){a.push(t.IdNumber);i=false}})});if(i){$.each(o,function(e,t){o[e].ContractualIndicator="O";o[e].SrvStatus="UA";o[e].DelInd="";o[e].AsBuild2="";o[e].ModelType="PR";o[e].BoqDesc=o[e].ActivityNumberDesc;o[e].Txt="Original";o[e].ActivityNumber=o[e].ActivityNumber;o[e].Network=o[e].Network;o[e].PrNo=parseInt(o[e].PrNo).toString();o[e].PrNumber=parseInt(o[e].PrNo).toString();o[e].BuildingNo=parseInt(o[e].PrNo).toString();o[e].Model=parseInt(o[e].PrNo).toString();r.push(o[e]);s.push(o[e])});t.aContexts.push(o);t.getView().getModel("localJson").setProperty("/myPurchaseRequisition",s);t.getView().getModel("localJson").setProperty("/selectedPR",r);t.onPRContractClose();t._handleValueHelpClosePR()}else if(!i){var g=a.join();sap.m.MessageToast.show("WBS is already added or don't select Boq "+g)}}},calculatestartDate:function(){var e=new Date(this.getView().byId("idDeliveryDate").getValue()),t=new Date(this.getView().byId("idCommencementDate").getValue());if(e>t){this.getView().byId("idValidFromDate").setValue(this.getView().byId("idDeliveryDate").getValue())}else{this.getView().byId("idValidFromDate").setValue(this.getView().byId("idCommencementDate").getValue())}this.calculateCompletionDate()},calculateCompletionDate:function(){var e=new Date(this.getView().byId("idValidFromDate").getValue()),t=parseInt(this.getView().byId("idContractDurationDays").getValue()),i=parseInt(this.getView().byId("idContractDurationMonth").getValue());if(this.getView().byId("idValidFromDate").getValue()!==""){var o=this.calculateDates(e,i,t);var a=this.DateObjectToYYYYMMDD(o);var r=+a.substring(0,4);var s=+a.substring(4,6);var l=+a.substring(6,8);var n=r+"-"+s+"-"+l;this.getView().byId("idValidToDate").setValue(n)}}})});
//# sourceMappingURL=CreateContract.controller.js.map